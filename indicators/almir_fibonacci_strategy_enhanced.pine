// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TRADERAGENT

//@version=6
strategy("ALMIR Fibonacci Strategy - Enhanced", shorttitle="ALMIR-Fib-E", overlay=true,
         initial_capital=10000, default_qty_type=strategy.percent_of_equity,
         default_qty_value=1, commission_type=strategy.commission.percent,
         commission_value=0.1, slippage=3,
         max_bars_back=500, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ============================================================================
// –û–ü–ò–°–ê–ù–ò–ï / DESCRIPTION
// ============================================================================
// Enhanced version of ALMIR Fibonacci Strategy with:
// - Systematic testing support with parameter presets
// - Results export via TradingView alerts (CSV-compatible)
// - Extended statistics (green/red candles, confluence analysis)
// - Visual improvements with metrics table
// - Easy parameter switching for different market conditions
//
// –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ALMIR Fibonacci —Å:
// - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
// - –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ –∞–ª–µ—Ä—Ç—ã TradingView (CSV-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π)
// - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∑–µ–ª—ë–Ω—ã–µ/–∫—Ä–∞—Å–Ω—ã–µ —Å–≤–µ—á–∏, –∞–Ω–∞–ª–∏–∑ confluence)
// - –í–∏–∑—É–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Å —Ç–∞–±–ª–∏—Ü–µ–π –º–µ—Ç—Ä–∏–∫
// - –õ–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
// ============================================================================

// ============================================================================
// PARAMETER PRESETS / –ü–†–ï–°–ï–¢–´ –ü–ê–†–ê–ú–ï–¢–†–û–í
// ============================================================================
// Select a preset to quickly load optimized parameters for different market conditions
// –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ—Å–µ—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä—ã–Ω–æ—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π

presetOptions = input.string("Default", "Parameter Preset / –ü—Ä–µ—Å–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤",
     options=["Default", "Trending", "Sideways", "Volatile", "Conservative", "Aggressive", "Custom"],
     group="üéõÔ∏è Preset Selection", tooltip="Select preset or 'Custom' to use individual parameters below")

// ============================================================================
// RSI SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò RSI
// ============================================================================
// Recommended ranges: Length (7-14), Smoothing (2-5), Oversold (20-35), Overbought (60-75)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–µ—Ä–∏–æ–¥ (7-14), –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (2-5), –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å (20-35), –ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å (60-75)

rsiLengthInput = input.int(10, "RSI Length / –ü–µ—Ä–∏–æ–¥ RSI", minval=1, maxval=50, group="üìä RSI Settings")
rsiSmoothLengthInput = input.int(3, "RSI Smoothing / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ RSI", minval=1, maxval=10, group="üìä RSI Settings")
rsiOversoldInput = input.int(30, "Oversold Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏", minval=1, maxval=50, group="üìä RSI Settings")
rsiOverboughtInput = input.int(65, "Overbought Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏", minval=50, maxval=100, group="üìä RSI Settings")
rsiMidLevelInput = input.int(50, "Mid Level / –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å", minval=30, maxval=70, group="üìä RSI Settings")

// ============================================================================
// MACD SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò MACD
// ============================================================================
// Recommended ranges: Fast (2-5), Slow (20-40), Signal (5-15)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ë—ã—Å—Ç—Ä–∞—è (2-5), –ú–µ–¥–ª–µ–Ω–Ω–∞—è (20-40), –°–∏–≥–Ω–∞–ª—å–Ω–∞—è (5-15)

macdFastInput = input.int(2, "MACD Fast Length / –ë—ã—Å—Ç—Ä–∞—è –ª–∏–Ω–∏—è", minval=1, maxval=20, group="üìà MACD Settings")
macdSlowInput = input.int(30, "MACD Slow Length / –ú–µ–¥–ª–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è", minval=10, maxval=100, group="üìà MACD Settings")
macdSignalInput = input.int(10, "MACD Signal Length / –°–∏–≥–Ω–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è", minval=1, maxval=30, group="üìà MACD Settings")

// ============================================================================
// STOCHASTIC SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò STOCHASTIC
// ============================================================================
// Recommended ranges: Length (10-20), Smooth (2-5), Oversold (20-35), Overbought (70-85)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–µ—Ä–∏–æ–¥ (10-20), –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (2-5), –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å (20-35), –ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å (70-85)

stochLengthInput = input.int(14, "Stochastic Length / –ü–µ—Ä–∏–æ–¥ Stochastic", minval=5, maxval=30, group="üìâ Stochastic Settings")
stochSmoothInput = input.int(3, "Stochastic Smooth / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ", minval=1, maxval=10, group="üìâ Stochastic Settings")
stochOversoldInput = input.int(30, "Stochastic Oversold / –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å", minval=1, maxval=50, group="üìâ Stochastic Settings")
stochOverboughtInput = input.int(83, "Stochastic Overbought / –ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å", minval=50, maxval=100, group="üìâ Stochastic Settings")

// ============================================================================
// VOLUME SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò –û–ë–™–ï–ú–ê
// ============================================================================
// Recommended ranges: MA Length (5-20), Multiplier (1.5-3.0)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–µ—Ä–∏–æ–¥ MA (5-20), –ú–Ω–æ–∂–∏—Ç–µ–ª—å (1.5-3.0)

volumeMaLengthInput = input.int(10, "Volume MA Length / –ü–µ—Ä–∏–æ–¥ MA –æ–±—ä–µ–º–∞", minval=1, maxval=50, group="üìä Volume Settings")
volumeMultiplierInput = input.float(2.0, "Volume Multiplier / –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—ä–µ–º–∞", minval=1.0, maxval=5.0, step=0.1, group="üìä Volume Settings")
useDirectionalVolumeInput = input.bool(true, "Use Directional Volume / –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä—ë–º", group="üìä Volume Settings")

// ============================================================================
// EMA SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò EMA
// ============================================================================
// Recommended ranges: EMA1 (5-13), EMA2 (3-9), EMA3 (100-300)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: EMA1 (5-13), EMA2 (3-9), EMA3 (100-300)

ema1LengthInput = input.int(9, "EMA 1 Length / –ü–µ—Ä–∏–æ–¥ EMA 1", minval=1, maxval=50, group="üìà EMA Settings")
ema2LengthInput = input.int(5, "EMA 2 Length / –ü–µ—Ä–∏–æ–¥ EMA 2", minval=1, maxval=30, group="üìà EMA Settings")
ema3LengthInput = input.int(200, "EMA 3 Length / –ü–µ—Ä–∏–æ–¥ EMA 3", minval=50, maxval=500, group="üìà EMA Settings")

// ============================================================================
// CONFLUENCE SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò CONFLUENCE
// ============================================================================
// Recommended ranges: Min Score (4-10), Min Bars (8-20)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ú–∏–Ω. –±–∞–ª–ª (4-10), –ú–∏–Ω. –±–∞—Ä–æ–≤ (8-20)

minConfluenceScoreInput = input.int(6, "Min Confluence Score / –ú–∏–Ω. –±–∞–ª–ª confluence", minval=2, maxval=20, group="üéØ Confluence Settings")
minBarsBetweenSignalsInput = input.int(12, "Min Bars Between Signals / –ú–∏–Ω. –±–∞—Ä–æ–≤ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏", minval=1, maxval=50, group="üéØ Confluence Settings")

// ============================================================================
// INDICATOR WEIGHTS / –í–ï–°–ê –ò–ù–î–ò–ö–ê–¢–û–†–û–í
// ============================================================================
// Recommended ranges: All weights (0-5)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –í—Å–µ –≤–µ—Å–∞ (0-5)

rsiWeightInput = input.int(2, "RSI Weight / –í–µ—Å RSI", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
macdWeightInput = input.int(2, "MACD Weight / –í–µ—Å MACD", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
stochWeightInput = input.int(2, "Stochastic Weight / –í–µ—Å Stochastic", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
volumeWeightInput = input.int(2, "Volume Weight / –í–µ—Å –æ–±—ä—ë–º–∞", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
priceActionWeightInput = input.int(1, "Price Action Weight / –í–µ—Å Price Action", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
maWeightInput = input.int(1, "EMA Weight / –í–µ—Å EMA", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")
divergenceWeightInput = input.int(2, "Divergence Weight / –í–µ—Å –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights")

// ============================================================================
// DIVERGENCE SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò –î–ò–í–ï–†–ì–ï–ù–¶–ò–ô
// ============================================================================
// Recommended ranges: Lookback (2-10), Min Strength (0.3-1.0)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞ (2-10), –ú–∏–Ω. —Å–∏–ª–∞ (0.3-1.0)

enableDivergenceInput = input.bool(true, "Enable Divergence Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π", group="üîÑ Divergence Settings")
divergenceLookbackInput = input.int(3, "Divergence Lookback / –ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞", minval=2, maxval=20, group="üîÑ Divergence Settings")
minDivergenceStrengthInput = input.float(0.6, "Min Divergence Strength / –ú–∏–Ω. —Å–∏–ª–∞ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏", minval=0.01, maxval=2.0, step=0.01, group="üîÑ Divergence Settings")

// ============================================================================
// ADAPTIVE FILTERS / –ê–î–ê–ü–¢–ò–í–ù–´–ï –§–ò–õ–¨–¢–†–´
// ============================================================================
// Recommended ranges: High Vol Threshold (0.7-1.0), Low Vol Threshold (0.3-0.7)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–æ—Ä–æ–≥ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (0.7-1.0), –ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (0.3-0.7)

enableAdaptiveFiltersInput = input.bool(true, "Enable Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã", group="üîß Adaptive Filters")
enableTrendFilterInput = input.bool(true, "Filter Against Strong Trend / –§–∏–ª—å—Ç—Ä –ø—Ä–æ—Ç–∏–≤ —Ç—Ä–µ–Ω–¥–∞", group="üîß Adaptive Filters")
enableVolatilityFilterInput = input.bool(true, "Enable Volatility Filter / –§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", group="üîß Adaptive Filters")
highVolThresholdInput = input.float(0.85, "High Volatility Threshold / –ü–æ—Ä–æ–≥ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", minval=0.1, maxval=2.0, step=0.05, group="üîß Adaptive Filters")
lowVolThresholdInput = input.float(0.6, "Low Volatility Threshold / –ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", minval=0.1, maxval=1.0, step=0.05, group="üîß Adaptive Filters")

// ============================================================================
// FIBONACCI SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò –§–ò–ë–û–ù–ê–ß–ß–ò
// ============================================================================
// Recommended ranges: Lookback (50-200)
// –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞ (50-200)

fibLookbackInput = input.int(100, "Fibonacci Lookback / –ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞ –§–∏–±–æ–Ω–∞—á—á–∏", minval=10, maxval=500, group="üìê Fibonacci Settings")
showFibLevels = input.bool(true, "Show Fibonacci Levels / –ü–æ–∫–∞–∑–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏", group="üìê Fibonacci Settings")
showFibLabels = input.bool(true, "Show Fibonacci Labels / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏", group="üìê Fibonacci Settings")

// ============================================================================
// POSITION MANAGEMENT / –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–û–ó–ò–¶–ò–ï–ô
// ============================================================================

useMultipleEntries = input.bool(true, "Use Multiple Entries / –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã", group="üí∞ Position Management",
                                tooltip="Entry #1 at signal candle, Entry #2 at 0.5, Entry #3 at 0.618")
entry1Percent = input.float(1.0, "Entry #1 Size (% of equity) / –†–∞–∑–º–µ—Ä –≤—Ö–æ–¥–∞ #1", minval=0.1, step=0.1, group="üí∞ Position Management")
entry2Percent = input.float(1.0, "Entry #2 Size (% of equity) / –†–∞–∑–º–µ—Ä –≤—Ö–æ–¥–∞ #2", minval=0.1, step=0.1, group="üí∞ Position Management")
entry3Percent = input.float(1.0, "Entry #3 Size (% of equity) / –†–∞–∑–º–µ—Ä –≤—Ö–æ–¥–∞ #3", minval=0.1, step=0.1, group="üí∞ Position Management")

tp1Percent = input.float(30.0, "TP1 Close % / –ó–∞–∫—Ä—ã—Ç—å % –Ω–∞ TP1", minval=1, maxval=100, group="üí∞ Position Management")
tp2Percent = input.float(30.0, "TP2 Close % / –ó–∞–∫—Ä—ã—Ç—å % –Ω–∞ TP2", minval=1, maxval=100, group="üí∞ Position Management")
tp3Percent = input.float(40.0, "TP3 Close % / –ó–∞–∫—Ä—ã—Ç—å % –Ω–∞ TP3", minval=1, maxval=100, group="üí∞ Position Management")

// ============================================================================
// DISPLAY SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø
// ============================================================================

showBullishSignals = input.bool(true, "Show Bullish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="üé® Display Settings")
showBearishSignals = input.bool(true, "Show Bearish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="üé® Display Settings")
showInfoTable = input.bool(true, "Show Info Table / –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É", group="üé® Display Settings")
showConfluenceDetails = input.bool(true, "Show Confluence Details / –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ confluence", group="üé® Display Settings")
showStatsTable = input.bool(true, "Show Extended Statistics / –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", group="üé® Display Settings")

// ============================================================================
// EXPORT SETTINGS / –ù–ê–°–¢–†–û–ô–ö–ò –≠–ö–°–ü–û–†–¢–ê
// ============================================================================

enableResultsExport = input.bool(false, "Enable Results Export / –í–∫–ª—é—á–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤", group="üì§ Export Settings",
     tooltip="Enable CSV-compatible export via alerts")
exportOnlyAtEnd = input.bool(true, "Export Only at Test End / –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Ü–µ —Ç–µ—Å—Ç–∞", group="üì§ Export Settings")

// ============================================================================
// APPLY PRESET VALUES / –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ó–ù–ê–ß–ï–ù–ò–ô –ü–†–ï–°–ï–¢–ê
// ============================================================================

// Function to get preset value or custom input
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
getPresetValue(preset, defaultVal, trendingVal, sidewaysVal, volatileVal, conservativeVal, aggressiveVal, customVal) =>
    preset == "Trending" ? trendingVal :
     preset == "Sideways" ? sidewaysVal :
     preset == "Volatile" ? volatileVal :
     preset == "Conservative" ? conservativeVal :
     preset == "Aggressive" ? aggressiveVal :
     preset == "Custom" ? customVal : defaultVal

// Apply preset values / –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–µ—Å–µ—Ç–∞
rsiLength = getPresetValue(presetOptions, 10, 12, 8, 10, 14, 7, rsiLengthInput)
rsiSmoothLength = getPresetValue(presetOptions, 3, 3, 5, 3, 4, 2, rsiSmoothLengthInput)
rsiOversold = getPresetValue(presetOptions, 30, 25, 35, 30, 35, 25, rsiOversoldInput)
rsiOverbought = getPresetValue(presetOptions, 65, 70, 60, 65, 70, 60, rsiOverboughtInput)
rsiMidLevel = getPresetValue(presetOptions, 50, 50, 50, 50, 50, 50, rsiMidLevelInput)

macdFast = getPresetValue(presetOptions, 2, 3, 2, 2, 3, 2, macdFastInput)
macdSlow = getPresetValue(presetOptions, 30, 40, 25, 30, 35, 25, macdSlowInput)
macdSignal = getPresetValue(presetOptions, 10, 12, 8, 10, 12, 8, macdSignalInput)

stochLength = getPresetValue(presetOptions, 14, 18, 12, 14, 18, 10, stochLengthInput)
stochSmooth = getPresetValue(presetOptions, 3, 3, 5, 3, 4, 2, stochSmoothInput)
stochOversold = getPresetValue(presetOptions, 30, 25, 35, 30, 35, 25, stochOversoldInput)
stochOverbought = getPresetValue(presetOptions, 83, 85, 80, 83, 85, 75, stochOverboughtInput)

volumeMaLength = getPresetValue(presetOptions, 10, 15, 8, 10, 12, 8, volumeMaLengthInput)
volumeMultiplier = getPresetValue(presetOptions, 2.0, 2.5, 1.8, 2.0, 2.5, 1.5, volumeMultiplierInput)
useDirectionalVolume = getPresetValue(presetOptions, 1, 1, 1, 1, 1, 1, useDirectionalVolumeInput ? 1 : 0) == 1

ema1Length = getPresetValue(presetOptions, 9, 13, 7, 9, 12, 7, ema1LengthInput)
ema2Length = getPresetValue(presetOptions, 5, 8, 4, 5, 7, 4, ema2LengthInput)
ema3Length = getPresetValue(presetOptions, 200, 250, 150, 200, 250, 150, ema3LengthInput)

minConfluenceScore = getPresetValue(presetOptions, 6, 7, 5, 6, 8, 5, minConfluenceScoreInput)
minBarsBetweenSignals = getPresetValue(presetOptions, 12, 15, 10, 12, 15, 8, minBarsBetweenSignalsInput)

rsiWeight = getPresetValue(presetOptions, 2, 2, 2, 2, 2, 2, rsiWeightInput)
macdWeight = getPresetValue(presetOptions, 2, 3, 1, 2, 2, 2, macdWeightInput)
stochWeight = getPresetValue(presetOptions, 2, 2, 2, 2, 2, 2, stochWeightInput)
volumeWeight = getPresetValue(presetOptions, 2, 3, 1, 2, 2, 3, volumeWeightInput)
priceActionWeight = getPresetValue(presetOptions, 1, 2, 1, 1, 1, 2, priceActionWeightInput)
maWeight = getPresetValue(presetOptions, 1, 2, 1, 1, 1, 1, maWeightInput)
divergenceWeight = getPresetValue(presetOptions, 2, 2, 2, 2, 2, 2, divergenceWeightInput)

enableDivergence = getPresetValue(presetOptions, 1, 1, 1, 1, 1, 1, enableDivergenceInput ? 1 : 0) == 1
divergenceLookback = getPresetValue(presetOptions, 3, 4, 3, 3, 4, 3, divergenceLookbackInput)
minDivergenceStrength = getPresetValue(presetOptions, 0.6, 0.7, 0.5, 0.6, 0.8, 0.4, minDivergenceStrengthInput)

enableAdaptiveFilters = getPresetValue(presetOptions, 1, 1, 1, 1, 1, 0, enableAdaptiveFiltersInput ? 1 : 0) == 1
enableTrendFilter = getPresetValue(presetOptions, 1, 1, 1, 1, 1, 0, enableTrendFilterInput ? 1 : 0) == 1
enableVolatilityFilter = getPresetValue(presetOptions, 1, 1, 1, 1, 1, 0, enableVolatilityFilterInput ? 1 : 0) == 1
highVolThreshold = getPresetValue(presetOptions, 0.85, 0.90, 0.80, 0.85, 0.90, 0.80, highVolThresholdInput)
lowVolThreshold = getPresetValue(presetOptions, 0.6, 0.7, 0.5, 0.6, 0.7, 0.5, lowVolThresholdInput)

fibLookback = getPresetValue(presetOptions, 100, 150, 75, 100, 120, 80, fibLookbackInput)

// ============================================================================
// INDICATOR CALCULATIONS / –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í
// ============================================================================

// === RSI Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RSI ===
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// === MACD Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ MACD ===
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdBullish = ta.crossover(macdLine, signalLine) and macdLine < 0
macdBearish = ta.crossunder(macdLine, signalLine) and macdLine > 0

// === Stochastic Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Stochastic ===
stochK = ta.stoch(close, high, low, stochLength)
stochD = ta.sma(stochK, stochSmooth)
stochBullish = ta.crossover(stochK, stochD) and stochK < stochOversold
stochBearish = ta.crossunder(stochK, stochD) and stochK > stochOverbought

// === Volume Analysis / –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞ ===
volumeMa = ta.sma(volume, volumeMaLength)
volumeRatio = volume / volumeMa
strongVolume = volumeRatio > volumeMultiplier

// Directional Volume / –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–º
isBuyingPressure = close > open and strongVolume
isSellingPressure = close < open and strongVolume

// === EMA Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ EMA ===
ema1 = ta.ema(close, ema1Length)
ema2 = ta.ema(close, ema2Length)
ema3 = ta.ema(close, ema3Length)

// EMA Signals / –°–∏–≥–Ω–∞–ª—ã EMA
emaBullish = ta.crossover(ema1, ema2) and ema1 > ema3
emaBearish = ta.crossunder(ema1, ema2) and ema1 < ema3

// === Price Action Analysis / –ê–Ω–∞–ª–∏–∑ Price Action ===
candleRange = high - low
candleBody = math.abs(close - open)
isBullishCandle = (close > open) and (candleBody > candleRange * 0.6) and candleRange > 0
isBearishCandle = (open > close) and (candleBody > candleRange * 0.6) and candleRange > 0

// === ATR for Volatility / ATR –¥–ª—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ ===
atrLength = 14
atr = ta.atr(atrLength)
atrMa = ta.sma(atr, 20)
atrRatio = atr / atrMa
isHighVolatility = atrRatio > highVolThreshold
isLowVolatility = atrRatio < lowVolThreshold

// === ADX for Trend Strength / ADX –¥–ª—è —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞ ===
adxLength = 14
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
isTrendingUp = adx > 25 and diPlus > diMinus
isTrendingDown = adx > 25 and diMinus > diPlus
isStrongTrend = adx > 30

// ============================================================================
// DIVERGENCE DETECTION / –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–ò–í–ï–†–ì–ï–ù–¶–ò–ô
// ============================================================================

// Find pivot points for price / –ü–æ–∏—Å–∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ —Ü–µ–Ω—ã
pivotLow = ta.pivotlow(low, divergenceLookback, divergenceLookback)
pivotHigh = ta.pivothigh(high, divergenceLookback, divergenceLookback)

// Find pivot points for RSI / –ü–æ–∏—Å–∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ RSI
rsiPivotLow = ta.pivotlow(rsi, divergenceLookback, divergenceLookback)
rsiPivotHigh = ta.pivothigh(rsi, divergenceLookback, divergenceLookback)

// Store previous pivot values / –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤
var float prevPriceLow = na
var float prevPriceHigh = na
var float prevRsiLow = na
var float prevRsiHigh = na

// Update previous pivots / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤
if not na(pivotLow)
    prevPriceLow := pivotLow

if not na(pivotHigh)
    prevPriceHigh := pivotHigh

if not na(rsiPivotLow)
    prevRsiLow := rsiPivotLow

if not na(rsiPivotHigh)
    prevRsiHigh := rsiPivotHigh

// Detect bullish divergence / –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±—ã—á—å–µ–π –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
bullishDivergence = false
bullishDivergenceStrength = 0.0

if enableDivergence and not na(pivotLow) and not na(prevPriceLow) and not na(rsiPivotLow) and not na(prevRsiLow)
    priceLowerLow = pivotLow < prevPriceLow
    rsiHigherLow = rsiPivotLow > prevRsiLow
    inOversoldZone = rsiPivotLow < rsiOversold

    if priceLowerLow and rsiHigherLow and inOversoldZone
        bullishDivergence := true
        bullishDivergenceStrength := prevRsiLow != 0 ? (rsiPivotLow - prevRsiLow) / prevRsiLow : 0.0

// Detect bearish divergence / –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ–¥–≤–µ–∂—å–µ–π –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
bearishDivergence = false
bearishDivergenceStrength = 0.0

if enableDivergence and not na(pivotHigh) and not na(prevPriceHigh) and not na(rsiPivotHigh) and not na(prevRsiHigh)
    priceHigherHigh = pivotHigh > prevPriceHigh
    rsiLowerHigh = rsiPivotHigh < prevRsiHigh
    inOverboughtZone = rsiPivotHigh > rsiOverbought

    if priceHigherHigh and rsiLowerHigh and inOverboughtZone
        bearishDivergence := true
        bearishDivergenceStrength := prevRsiHigh != 0 ? (prevRsiHigh - rsiPivotHigh) / prevRsiHigh : 0.0

// Strong divergences / –°–∏–ª—å–Ω—ã–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
strongBullishDivergence = bullishDivergence and bullishDivergenceStrength > minDivergenceStrength
strongBearishDivergence = bearishDivergence and bearishDivergenceStrength > minDivergenceStrength

// ============================================================================
// CONFLUENCE SCORE CALCULATION / –†–ê–°–ß–Å–¢ CONFLUENCE SCORE
// ============================================================================

// Initialize scores and reasons / –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ –∏ –ø—Ä–∏—á–∏–Ω
var int bullishScore = 0
var int bearishScore = 0
var array<string> bullishReasons = array.new<string>()
var array<string> bearishReasons = array.new<string>()

// Reset scores / –°–±—Ä–æ—Å –±–∞–ª–ª–æ–≤
bullishScore := 0
bearishScore := 0
array.clear(bullishReasons)
array.clear(bearishReasons)

// === RSI Signals / –°–∏–≥–Ω–∞–ª—ã RSI ===
rsiBullishSignal = ta.crossover(rsi, rsiOversold) and rsiSmooth > rsiSmooth[1]
rsiBearishSignal = ta.crossunder(rsi, rsiOverbought) and rsiSmooth < rsiSmooth[1]

if rsiBullishSignal
    bullishScore += rsiWeight
    array.push(bullishReasons, "RSI bullish reversal")

if rsiBearishSignal
    bearishScore += rsiWeight
    array.push(bearishReasons, "RSI bearish reversal")

// === MACD Signals / –°–∏–≥–Ω–∞–ª—ã MACD ===
if macdBullish
    bullishScore += macdWeight
    array.push(bullishReasons, "MACD bullish cross")

if macdBearish
    bearishScore += macdWeight
    array.push(bearishReasons, "MACD bearish cross")

// === Stochastic Signals / –°–∏–≥–Ω–∞–ª—ã Stochastic ===
if stochBullish
    bullishScore += stochWeight
    array.push(bullishReasons, "Stochastic oversold")

if stochBearish
    bearishScore += stochWeight
    array.push(bearishReasons, "Stochastic overbought")

// === Volume Signals / –°–∏–≥–Ω–∞–ª—ã –æ–±—ä—ë–º–∞ ===
volumeBullish = strongVolume and (useDirectionalVolume ? isBuyingPressure : close > open)
volumeBearish = strongVolume and (useDirectionalVolume ? isSellingPressure : close < open)

if volumeBullish
    bullishScore += volumeWeight
    array.push(bullishReasons, "Strong buying volume")

if volumeBearish
    bearishScore += volumeWeight
    array.push(bearishReasons, "Strong selling volume")

// === Price Action Signals / –°–∏–≥–Ω–∞–ª—ã Price Action ===
if isBullishCandle
    bullishScore += priceActionWeight
    array.push(bullishReasons, "Strong bullish candle")

if isBearishCandle
    bearishScore += priceActionWeight
    array.push(bearishReasons, "Strong bearish candle")

// === EMA Signals / –°–∏–≥–Ω–∞–ª—ã EMA ===
if emaBullish
    bullishScore += maWeight
    array.push(bullishReasons, "EMA bullish cross")

if emaBearish
    bearishScore += maWeight
    array.push(bearishReasons, "EMA bearish cross")

// === Divergence Signals / –°–∏–≥–Ω–∞–ª—ã –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π ===
if strongBullishDivergence
    bullishScore += divergenceWeight
    array.push(bullishReasons, "Bullish divergence")

if strongBearishDivergence
    bearishScore += divergenceWeight
    array.push(bearishReasons, "Bearish divergence")

// ============================================================================
// SIGNAL GENERATION WITH FILTERS / –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ò–ì–ù–ê–õ–û–í –° –§–ò–õ–¨–¢–†–ê–ú–ò
// ============================================================================

// Track last signal bar / –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
var int lastBullishBar = 0
var int lastBearishBar = 0

// Check minimum distance between signals / –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
barsSinceLastBullish = bar_index - lastBullishBar
barsSinceLastBearish = bar_index - lastBearishBar

// Raw signals based on confluence score / –°—ã—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ confluence
bullishSignalRaw = bullishScore >= minConfluenceScore and barsSinceLastBullish >= minBarsBetweenSignals
bearishSignalRaw = bearishScore >= minConfluenceScore and barsSinceLastBearish >= minBarsBetweenSignals

// === Apply Adaptive Filters / –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
bool bullishSignalFiltered = bullishSignalRaw
bool bearishSignalFiltered = bearishSignalRaw

if enableAdaptiveFilters
    // Trend Filter / –§–∏–ª—å—Ç—Ä —Ç—Ä–µ–Ω–¥–∞
    if enableTrendFilter and isStrongTrend
        if isTrendingDown
            bullishSignalFiltered := false
        if isTrendingUp
            bearishSignalFiltered := false

    // Volatility Filter / –§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
    if enableVolatilityFilter
        if isHighVolatility
            if not isTrendingUp
                bullishSignalFiltered := false
            if not isTrendingDown
                bearishSignalFiltered := false

// Final signals / –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
bullishSignal = bullishSignalFiltered and showBullishSignals
bearishSignal = bearishSignalFiltered and showBearishSignals

// Update last signal bars / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ä–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bullishSignal
    lastBullishBar := bar_index

if bearishSignal
    lastBearishBar := bar_index

// ============================================================================
// EXTENDED STATISTICS TRACKING / –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –†–ê–°–®–ò–†–ï–ù–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò
// ============================================================================

// Track statistics by candle color / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–≤–µ—Ç—É —Å–≤–µ—á–µ–π
var int greenCandleSignals = 0
var int redCandleSignals = 0
var float greenCandleProfit = 0.0
var float redCandleProfit = 0.0

// Track statistics by confluence score / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ confluence score
var array<int> confluenceScores = array.new<int>()
var array<float> confluenceProfits = array.new<float>()

// Track entry indicator states / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏ –≤—Ö–æ–¥–µ
var int entriesWithRSIOversold = 0
var int entriesWithMACDCross = 0
var int entriesWithStochOversold = 0
var int entriesWithVolume = 0
var int entriesWithDivergence = 0

// Track signal on candle color / –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –ø–æ —Ü–≤–µ—Ç—É —Å–≤–µ—á–∏
if bullishSignal or bearishSignal
    isGreenCandle = close > open
    currentScore = bullishSignal ? bullishScore : bearishScore

    if isGreenCandle
        greenCandleSignals += 1
    else
        redCandleSignals += 1

    // Track confluence scores
    array.push(confluenceScores, currentScore)
    array.push(confluenceProfits, 0.0)  // Will be updated on trade close

    // Track indicator states at entry
    if bullishSignal
        if rsiBullishSignal
            entriesWithRSIOversold += 1
        if macdBullish
            entriesWithMACDCross += 1
        if stochBullish
            entriesWithStochOversold += 1
        if volumeBullish
            entriesWithVolume += 1
        if strongBullishDivergence
            entriesWithDivergence += 1

// ============================================================================
// FIBONACCI LEVELS CALCULATION / –†–ê–°–ß–Å–¢ –£–†–û–í–ù–ï–ô –§–ò–ë–û–ù–ê–ß–ß–ò
// ============================================================================

// Track Fibonacci levels for active position / –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
var float fibBase = na
var float fibTop = na
var bool isLongPosition = false
var int signalBar = na

// Calculate ta.highest and ta.lowest on every bar for consistency
// –í—ã—á–∏—Å–ª—è–µ–º ta.highest –∏ ta.lowest –Ω–∞ –∫–∞–∂–¥–æ–º –±–∞—Ä–µ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
highestHigh = ta.highest(high, fibLookback)
lowestLow = ta.lowest(low, fibLookback)

// Calculate Fibonacci levels on new signal / –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–∏–≥–Ω–∞–ª–µ
if bullishSignal
    signalBar := bar_index
    isLongPosition := true
    // For bullish: base = low of signal candle, top = high of lookback period
    fibBase := low
    fibTop := highestHigh

if bearishSignal
    signalBar := bar_index
    isLongPosition := false
    // For bearish: base = high of signal candle, top = low of lookback period
    fibBase := high
    fibTop := lowestLow

// Calculate Fibonacci levels / –†–∞—Å—á—ë—Ç —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
float fib_0_0 = na
float fib_0_5 = na
float fib_0_618 = na
float fib_0_820 = na  // Stop Loss level
float fib_1_0 = na
float fib_n0_618 = na  // TP1
float fib_n1_618 = na  // TP2
float fib_n2_618 = na  // TP3

if not na(fibBase) and not na(fibTop)
    fibRange = fibTop - fibBase

    if isLongPosition
        // Long position: from low (1.0) to high (0.0)
        fib_1_0 := fibBase
        fib_0_820 := fibBase + fibRange * 0.820
        fib_0_618 := fibBase + fibRange * 0.618
        fib_0_5 := fibBase + fibRange * 0.5
        fib_0_0 := fibTop
        fib_n0_618 := fibTop + fibRange * 0.618
        fib_n1_618 := fibTop + fibRange * 1.618
        fib_n2_618 := fibTop + fibRange * 2.618
    else
        // Short position: from high (1.0) to low (0.0)
        fib_1_0 := fibBase
        fib_0_820 := fibBase - fibRange * 0.820
        fib_0_618 := fibBase - fibRange * 0.618
        fib_0_5 := fibBase - fibRange * 0.5
        fib_0_0 := fibTop
        fib_n0_618 := fibTop - fibRange * 0.618
        fib_n1_618 := fibTop - fibRange * 1.618
        fib_n2_618 := fibTop - fibRange * 2.618

// ============================================================================
// TRADING LOGIC / –¢–û–†–ì–û–í–ê–Ø –õ–û–ì–ò–ö–ê
// ============================================================================

// Entry #1: Market order at signal candle close
// –í—Ö–æ–¥ #1: –†—ã–Ω–æ—á–Ω—ã–π –æ—Ä–¥–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏
if bullishSignal
    strategy.entry("Long Entry #1", strategy.long, qty=entry1Percent, comment="üü¢ Long E1")

if bearishSignal
    strategy.entry("Short Entry #1", strategy.short, qty=entry1Percent, comment="üî¥ Short E1")

// Entry #2: Limit order at 0.5 Fibonacci level
// –í—Ö–æ–¥ #2: –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä –Ω–∞ —É—Ä–æ–≤–Ω–µ 0.5 –§–∏–±–æ–Ω–∞—á—á–∏
if useMultipleEntries and not na(fib_0_5) and isLongPosition == true and strategy.position_size > 0
    if low <= fib_0_5 and strategy.opentrades < 2
        strategy.entry("Long Entry #2", strategy.long, qty=entry2Percent, limit=fib_0_5, comment="üü¢ Long E2")

if useMultipleEntries and not na(fib_0_5) and isLongPosition == false and strategy.position_size < 0
    if high >= fib_0_5 and strategy.opentrades < 2
        strategy.entry("Short Entry #2", strategy.short, qty=entry2Percent, limit=fib_0_5, comment="üî¥ Short E2")

// Entry #3: Limit order at 0.618 Fibonacci level
// –í—Ö–æ–¥ #3: –õ–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä –Ω–∞ —É—Ä–æ–≤–Ω–µ 0.618 –§–∏–±–æ–Ω–∞—á—á–∏
if useMultipleEntries and not na(fib_0_618) and isLongPosition == true and strategy.position_size > 0
    if low <= fib_0_618 and strategy.opentrades < 3
        strategy.entry("Long Entry #3", strategy.long, qty=entry3Percent, limit=fib_0_618, comment="üü¢ Long E3")

if useMultipleEntries and not na(fib_0_618) and isLongPosition == false and strategy.position_size < 0
    if high >= fib_0_618 and strategy.opentrades < 3
        strategy.entry("Short Entry #3", strategy.short, qty=entry3Percent, limit=fib_0_618, comment="üî¥ Short E3")

// Stop Loss at 0.820 Fibonacci level
// –°—Ç–æ–ø-–ª–æ—Å—Å –Ω–∞ —É—Ä–æ–≤–Ω–µ 0.820 –§–∏–±–æ–Ω–∞—á—á–∏
if not na(fib_0_820) and strategy.position_size != 0
    if strategy.position_size > 0
        strategy.exit("Long SL", "Long Entry #1", stop=fib_0_820, comment="üõë Long SL")
        if useMultipleEntries
            strategy.exit("Long SL #2", "Long Entry #2", stop=fib_0_820, comment="üõë Long SL")
            strategy.exit("Long SL #3", "Long Entry #3", stop=fib_0_820, comment="üõë Long SL")
    else
        strategy.exit("Short SL", "Short Entry #1", stop=fib_0_820, comment="üõë Short SL")
        if useMultipleEntries
            strategy.exit("Short SL #2", "Short Entry #2", stop=fib_0_820, comment="üõë Short SL")
            strategy.exit("Short SL #3", "Short Entry #3", stop=fib_0_820, comment="üõë Short SL")

// Take Profit levels with partial closes
// –£—Ä–æ–≤–Ω–∏ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º –∑–∞–∫—Ä—ã—Ç–∏–µ–º
if not na(fib_n0_618) and strategy.position_size != 0
    if strategy.position_size > 0 and high >= fib_n0_618
        strategy.close("Long Entry #1", qty_percent=tp1Percent, comment="üéØ Long TP1")
        if useMultipleEntries
            strategy.close("Long Entry #2", qty_percent=tp1Percent, comment="üéØ Long TP1")
            strategy.close("Long Entry #3", qty_percent=tp1Percent, comment="üéØ Long TP1")
    else if strategy.position_size < 0 and low <= fib_n0_618
        strategy.close("Short Entry #1", qty_percent=tp1Percent, comment="üéØ Short TP1")
        if useMultipleEntries
            strategy.close("Short Entry #2", qty_percent=tp1Percent, comment="üéØ Short TP1")
            strategy.close("Short Entry #3", qty_percent=tp1Percent, comment="üéØ Short TP1")

if not na(fib_n1_618) and strategy.position_size != 0
    if strategy.position_size > 0 and high >= fib_n1_618
        strategy.close("Long Entry #1", qty_percent=tp2Percent, comment="üéØ Long TP2")
        if useMultipleEntries
            strategy.close("Long Entry #2", qty_percent=tp2Percent, comment="üéØ Long TP2")
            strategy.close("Long Entry #3", qty_percent=tp2Percent, comment="üéØ Long TP2")
    else if strategy.position_size < 0 and low <= fib_n1_618
        strategy.close("Short Entry #1", qty_percent=tp2Percent, comment="üéØ Short TP2")
        if useMultipleEntries
            strategy.close("Short Entry #2", qty_percent=tp2Percent, comment="üéØ Short TP2")
            strategy.close("Short Entry #3", qty_percent=tp2Percent, comment="üéØ Short TP2")

if not na(fib_n2_618) and strategy.position_size != 0
    if strategy.position_size > 0 and high >= fib_n2_618
        strategy.close("Long Entry #1", qty_percent=tp3Percent, comment="üéØ Long TP3")
        if useMultipleEntries
            strategy.close("Long Entry #2", qty_percent=tp3Percent, comment="üéØ Long TP3")
            strategy.close("Long Entry #3", qty_percent=tp3Percent, comment="üéØ Long TP3")
    else if strategy.position_size < 0 and low <= fib_n2_618
        strategy.close("Short Entry #1", qty_percent=tp3Percent, comment="üéØ Short TP3")
        if useMultipleEntries
            strategy.close("Short Entry #2", qty_percent=tp3Percent, comment="üéØ Short TP3")
            strategy.close("Short Entry #3", qty_percent=tp3Percent, comment="üéØ Short TP3")

// ============================================================================
// VISUALIZATION / –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================================

// Plot Fibonacci levels / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
plot(showFibLevels ? fib_1_0 : na, "Fib 1.0 (Base)", color=color.new(color.gray, 30), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fib_0_820 : na, "Fib 0.820 (SL)", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)
plot(showFibLevels ? fib_0_618 : na, "Fib 0.618 (E3)", color=color.new(color.blue, 30), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fib_0_5 : na, "Fib 0.5 (E2)", color=color.new(color.blue, 30), linewidth=1, style=plot.style_linebr)
plot(showFibLevels ? fib_0_0 : na, "Fib 0.0 (E1)", color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr)
plot(showFibLevels ? fib_n0_618 : na, "Fib -0.618 (TP1)", color=color.new(color.yellow, 0), linewidth=2, style=plot.style_linebr)
plot(showFibLevels ? fib_n1_618 : na, "Fib -1.618 (TP2)", color=color.new(color.orange, 0), linewidth=2, style=plot.style_linebr)
plot(showFibLevels ? fib_n2_618 : na, "Fib -2.618 (TP3)", color=color.new(color.lime, 0), linewidth=2, style=plot.style_linebr)

// Plot EMAs / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ EMA
plot(ema1, "EMA 9", color=color.new(color.blue, 30), linewidth=1)
plot(ema2, "EMA 5", color=color.new(color.orange, 30), linewidth=1)
plot(ema3, "EMA 200", color=color.new(color.purple, 50), linewidth=2)

// Enhanced signal markers with confluence score display
// –£–ª—É—á—à–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å–∏–≥–Ω–∞–ª–æ–≤ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º confluence score
plotshape(bullishSignal, title="Bullish Signal", style=shape.triangleup, location=location.belowbar,
     color=color.new(color.green, 0), text="BUY\n" + str.tostring(bullishScore), textcolor=color.white, size=size.large)

plotshape(bearishSignal, title="Bearish Signal", style=shape.triangledown, location=location.abovebar,
     color=color.new(color.red, 0), text="SELL\n" + str.tostring(bearishScore), textcolor=color.white, size=size.large)

// Plot divergences / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π
plotshape(strongBullishDivergence and not bullishSignal, title="Bullish Div", style=shape.circle,
     location=location.belowbar, color=color.new(color.green, 50), size=size.tiny)

plotshape(strongBearishDivergence and not bearishSignal, title="Bearish Div", style=shape.circle,
     location=location.abovebar, color=color.new(color.red, 50), size=size.tiny)

// ============================================================================
// INFO TABLE / –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê
// ============================================================================

if showInfoTable and barstate.islast
    var table infoTable = table.new(position.top_right, 3, 20,
         border_width=2, border_color=color.gray, frame_width=1, frame_color=color.gray)

    // Header / –ó–∞–≥–æ–ª–æ–≤–æ–∫
    table.cell(infoTable, 0, 0, "ALMIR Fibonacci Strategy Enhanced", text_color=color.white,
         bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.merge_cells(infoTable, 0, 0, 2, 0)

    // Preset info / –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–µ—Å–µ—Ç–µ
    table.cell(infoTable, 0, 1, "Preset", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 1, presetOptions, text_color=color.white, text_size=size.small)
    table.merge_cells(infoTable, 1, 1, 2, 1)

    // Market State / –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞
    table.cell(infoTable, 0, 2, "Market State", text_color=color.gray, text_size=size.small)
    trendText = isTrendingUp ? "Uptrend" : isTrendingDown ? "Downtrend" : "Sideways"
    trendColor = isTrendingUp ? color.green : isTrendingDown ? color.red : color.gray
    table.cell(infoTable, 1, 2, trendText, text_color=trendColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 2, 2, 2)

    // Volatility / –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    table.cell(infoTable, 0, 3, "Volatility", text_color=color.gray, text_size=size.small)
    volText = isHighVolatility ? "High" : isLowVolatility ? "Low" : "Medium"
    volColor = isHighVolatility ? color.orange : color.gray
    table.cell(infoTable, 1, 3, volText, text_color=volColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 3, 2, 3)

    // Separator
    table.cell(infoTable, 0, 4, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
    table.merge_cells(infoTable, 0, 4, 2, 4)

    // Confluence Scores / –ë–∞–ª–ª—ã Confluence
    table.cell(infoTable, 0, 5, "Confluence Score", text_color=color.white,
         bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.merge_cells(infoTable, 0, 5, 2, 5)

    table.cell(infoTable, 0, 6, "Bullish", text_color=color.gray, text_size=size.small)
    bullScoreColor = bullishScore >= minConfluenceScore ? color.green : color.gray
    table.cell(infoTable, 1, 6, str.tostring(bullishScore), text_color=bullScoreColor, text_size=size.small)
    table.cell(infoTable, 2, 6, "/" + str.tostring(minConfluenceScore), text_color=color.gray, text_size=size.small)

    table.cell(infoTable, 0, 7, "Bearish", text_color=color.gray, text_size=size.small)
    bearScoreColor = bearishScore >= minConfluenceScore ? color.red : color.gray
    table.cell(infoTable, 1, 7, str.tostring(bearishScore), text_color=bearScoreColor, text_size=size.small)
    table.cell(infoTable, 2, 7, "/" + str.tostring(minConfluenceScore), text_color=color.gray, text_size=size.small)

    // Show confluence details if enabled
    if showConfluenceDetails
        // Separator
        table.cell(infoTable, 0, 8, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
        table.merge_cells(infoTable, 0, 8, 2, 8)

        // Active Signals / –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
        table.cell(infoTable, 0, 9, "Active Signals", text_color=color.white,
             bgcolor=color.new(color.blue, 70), text_size=size.small)
        table.merge_cells(infoTable, 0, 9, 2, 9)

        // Show reasons for bullish signal
        rowIdx = 10
        if bullishScore > 0
            reasonsText = array.size(bullishReasons) > 0 ? array.get(bullishReasons, 0) : "None"
            if array.size(bullishReasons) > 1
                for i = 1 to math.min(2, array.size(bullishReasons) - 1)
                    reasonsText += "\n" + array.get(bullishReasons, i)
            table.cell(infoTable, 0, rowIdx, "üü¢ Bullish:", text_color=color.green, text_size=size.small)
            table.cell(infoTable, 1, rowIdx, reasonsText, text_color=color.gray, text_size=size.small)
            table.merge_cells(infoTable, 1, rowIdx, 2, rowIdx)
            rowIdx += 1

        // Show reasons for bearish signal
        if bearishScore > 0
            reasonsText = array.size(bearishReasons) > 0 ? array.get(bearishReasons, 0) : "None"
            if array.size(bearishReasons) > 1
                for i = 1 to math.min(2, array.size(bearishReasons) - 1)
                    reasonsText += "\n" + array.get(bearishReasons, i)
            table.cell(infoTable, 0, rowIdx, "üî¥ Bearish:", text_color=color.red, text_size=size.small)
            table.cell(infoTable, 1, rowIdx, reasonsText, text_color=color.gray, text_size=size.small)
            table.merge_cells(infoTable, 1, rowIdx, 2, rowIdx)

    // Position info separator
    table.cell(infoTable, 0, 12, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
    table.merge_cells(infoTable, 0, 12, 2, 12)

    // Position Info / –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∑–∏—Ü–∏–∏
    table.cell(infoTable, 0, 13, "Position Info", text_color=color.white,
         bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.merge_cells(infoTable, 0, 13, 2, 13)

    // Position Size / –†–∞–∑–º–µ—Ä –ø–æ–∑–∏—Ü–∏–∏
    table.cell(infoTable, 0, 14, "Size", text_color=color.gray, text_size=size.small)
    posSize = strategy.position_size
    posText = posSize > 0 ? "LONG" : posSize < 0 ? "SHORT" : "None"
    posColor = posSize > 0 ? color.green : posSize < 0 ? color.red : color.gray
    table.cell(infoTable, 1, 14, posText, text_color=posColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 14, 2, 14)

    // Open Trades / –û—Ç–∫—Ä—ã—Ç—ã–µ —Å–¥–µ–ª–∫–∏
    table.cell(infoTable, 0, 15, "Open Trades", text_color=color.gray, text_size=size.small)
    table.cell(infoTable, 1, 15, str.tostring(strategy.opentrades), text_color=color.white, text_size=size.small)
    table.merge_cells(infoTable, 1, 15, 2, 15)

    // Net Profit / –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å
    table.cell(infoTable, 0, 16, "Net Profit", text_color=color.gray, text_size=size.small)
    netProfit = strategy.netprofit
    profitColor = netProfit > 0 ? color.green : netProfit < 0 ? color.red : color.gray
    table.cell(infoTable, 1, 16, str.tostring(netProfit, "#.##"), text_color=profitColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 16, 2, 16)

// ============================================================================
// EXTENDED STATISTICS TABLE / –¢–ê–ë–õ–ò–¶–ê –†–ê–°–®–ò–†–ï–ù–ù–û–ô –°–¢–ê–¢–ò–°–¢–ò–ö–ò
// ============================================================================

if showStatsTable and barstate.islast
    var table statsTable = table.new(position.bottom_right, 2, 15,
         border_width=2, border_color=color.gray, frame_width=1, frame_color=color.gray)

    // Header / –ó–∞–≥–æ–ª–æ–≤–æ–∫
    table.cell(statsTable, 0, 0, "Extended Statistics", text_color=color.white,
         bgcolor=color.new(color.purple, 30), text_size=size.normal)
    table.merge_cells(statsTable, 0, 0, 1, 0)

    // Strategy Performance / –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    table.cell(statsTable, 0, 1, "Total Trades", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 1, str.tostring(strategy.closedtrades), text_color=color.white, text_size=size.small)

    table.cell(statsTable, 0, 2, "Win Rate", text_color=color.gray, text_size=size.small)
    winRate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    winRateColor = winRate >= 50 ? color.green : color.red
    table.cell(statsTable, 1, 2, str.tostring(winRate, "#.##") + "%", text_color=winRateColor, text_size=size.small)

    table.cell(statsTable, 0, 3, "Profit Factor", text_color=color.gray, text_size=size.small)
    profitFactor = strategy.grossloss != 0 ? math.abs(strategy.grossprofit / strategy.grossloss) : 0
    pfColor = profitFactor >= 1.5 ? color.green : profitFactor >= 1.0 ? color.orange : color.red
    table.cell(statsTable, 1, 3, str.tostring(profitFactor, "#.##"), text_color=pfColor, text_size=size.small)

    table.cell(statsTable, 0, 4, "Max Drawdown", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 4, str.tostring(strategy.max_drawdown, "#.##"), text_color=color.red, text_size=size.small)

    // Separator
    table.cell(statsTable, 0, 5, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
    table.merge_cells(statsTable, 0, 5, 1, 5)

    // Candle Color Statistics / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–≤–µ—Ç—É —Å–≤–µ—á–µ–π
    table.cell(statsTable, 0, 6, "Candle Color Stats", text_color=color.white,
         bgcolor=color.new(color.purple, 70), text_size=size.small)
    table.merge_cells(statsTable, 0, 6, 1, 6)

    table.cell(statsTable, 0, 7, "Green Candle Signals", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 7, str.tostring(greenCandleSignals), text_color=color.green, text_size=size.small)

    table.cell(statsTable, 0, 8, "Red Candle Signals", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 8, str.tostring(redCandleSignals), text_color=color.red, text_size=size.small)

    // Separator
    table.cell(statsTable, 0, 9, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
    table.merge_cells(statsTable, 0, 9, 1, 9)

    // Indicator State Statistics / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    table.cell(statsTable, 0, 10, "Entry Indicators", text_color=color.white,
         bgcolor=color.new(color.purple, 70), text_size=size.small)
    table.merge_cells(statsTable, 0, 10, 1, 10)

    table.cell(statsTable, 0, 11, "With RSI Signal", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 11, str.tostring(entriesWithRSIOversold), text_color=color.white, text_size=size.small)

    table.cell(statsTable, 0, 12, "With MACD Cross", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 12, str.tostring(entriesWithMACDCross), text_color=color.white, text_size=size.small)

    table.cell(statsTable, 0, 13, "With Stoch Signal", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 13, str.tostring(entriesWithStochOversold), text_color=color.white, text_size=size.small)

    table.cell(statsTable, 0, 14, "With Divergence", text_color=color.gray, text_size=size.small)
    table.cell(statsTable, 1, 14, str.tostring(entriesWithDivergence), text_color=color.white, text_size=size.small)

// ============================================================================
// LABELS FOR FIBONACCI LEVELS / –ú–ï–¢–ö–ò –î–õ–Ø –£–†–û–í–ù–ï–ô –§–ò–ë–û–ù–ê–ß–ß–ò
// ============================================================================

if showFibLabels and bullishSignal
    label.new(bar_index, fib_0_0, "Entry #1 (0.0)", style=label.style_label_down,
         color=color.new(color.green, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_0_5, "Entry #2 (0.5)", style=label.style_label_left,
         color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)
    label.new(bar_index, fib_0_618, "Entry #3 (0.618)", style=label.style_label_left,
         color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)
    label.new(bar_index, fib_0_820, "Stop Loss (0.820)", style=label.style_label_left,
         color=color.new(color.red, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_n0_618, "TP1 (-0.618)", style=label.style_label_left,
         color=color.new(color.yellow, 0), textcolor=color.black, size=size.small)
    label.new(bar_index, fib_n1_618, "TP2 (-1.618)", style=label.style_label_left,
         color=color.new(color.orange, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_n2_618, "TP3 (-2.618)", style=label.style_label_left,
         color=color.new(color.lime, 0), textcolor=color.black, size=size.small)

if showFibLabels and bearishSignal
    label.new(bar_index, fib_0_0, "Entry #1 (0.0)", style=label.style_label_up,
         color=color.new(color.red, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_0_5, "Entry #2 (0.5)", style=label.style_label_right,
         color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)
    label.new(bar_index, fib_0_618, "Entry #3 (0.618)", style=label.style_label_right,
         color=color.new(color.blue, 30), textcolor=color.white, size=size.tiny)
    label.new(bar_index, fib_0_820, "Stop Loss (0.820)", style=label.style_label_right,
         color=color.new(color.red, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_n0_618, "TP1 (-0.618)", style=label.style_label_right,
         color=color.new(color.yellow, 0), textcolor=color.black, size=size.small)
    label.new(bar_index, fib_n1_618, "TP2 (-1.618)", style=label.style_label_right,
         color=color.new(color.orange, 0), textcolor=color.white, size=size.small)
    label.new(bar_index, fib_n2_618, "TP3 (-2.618)", style=label.style_label_right,
         color=color.new(color.lime, 0), textcolor=color.black, size=size.small)

// ============================================================================
// ALERTS FOR RESULTS EXPORT / –ê–õ–ï–†–¢–´ –î–õ–Ø –≠–ö–°–ü–û–†–¢–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
// ============================================================================

// Create JSON string with strategy parameters for export
// –°–æ–∑–¥–∞–Ω–∏–µ JSON —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
string paramsJSON = '{"preset":"' + presetOptions +
     '","rsiLength":' + str.tostring(rsiLength) +
     ',"rsiOversold":' + str.tostring(rsiOversold) +
     ',"rsiOverbought":' + str.tostring(rsiOverbought) +
     ',"macdFast":' + str.tostring(macdFast) +
     ',"macdSlow":' + str.tostring(macdSlow) +
     ',"macdSignal":' + str.tostring(macdSignal) +
     ',"stochLength":' + str.tostring(stochLength) +
     ',"stochOversold":' + str.tostring(stochOversold) +
     ',"stochOverbought":' + str.tostring(stochOverbought) +
     ',"minConfluenceScore":' + str.tostring(minConfluenceScore) +
     ',"minBarsBetweenSignals":' + str.tostring(minBarsBetweenSignals) +
     ',"fibLookback":' + str.tostring(fibLookback) + '}'

// Build CSV-compatible export message
// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ CSV-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
string exportMessage = syminfo.ticker + "," +
     timeframe.period + "," +
     paramsJSON + "," +
     str.tostring(strategy.closedtrades) + "," +
     str.tostring(winRate, "#.##") + "," +
     str.tostring(profitFactor, "#.##") + "," +
     str.tostring(strategy.max_drawdown, "#.##") + "," +
     str.tostring(strategy.netprofit, "#.##") + "," +
     str.tostring(greenCandleSignals) + "," +
     str.tostring(redCandleSignals)

// Export alert condition
// –£—Å–ª–æ–≤–∏–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
bool exportCondition = enableResultsExport and (exportOnlyAtEnd ? barstate.islastconfirmedhistory : barstate.islast)

alertcondition(exportCondition, title="Export Results",
     message="EXPORT," + exportMessage)

// Standard trading alerts / –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –∞–ª–µ—Ä—Ç—ã
alertcondition(bullishSignal, title="ALMIR Bullish Signal",
     message="ALMIR Strategy: Bullish signal! Score: " + str.tostring(bullishScore))

alertcondition(bearishSignal, title="ALMIR Bearish Signal",
     message="ALMIR Strategy: Bearish signal! Score: " + str.tostring(bearishScore))

alertcondition(strategy.position_size > 0, title="Long Position Opened",
     message="ALMIR Strategy: Long position opened")

alertcondition(strategy.position_size < 0, title="Short Position Opened",
     message="ALMIR Strategy: Short position opened")

alertcondition(strategy.position_size == 0, title="Position Closed",
     message="ALMIR Strategy: Position closed")
