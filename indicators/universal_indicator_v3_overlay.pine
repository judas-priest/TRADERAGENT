// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TRADERAGENT

//@version=6
indicator("–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä v3 - Fibonacci Overlay", shorttitle="UI v3 Fib", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================================
// –û–ü–ò–°–ê–ù–ò–ï / DESCRIPTION
// ============================================================================
// Overlay-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ v3.
// –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —à–∫–∞–ª—ã
// –∏ –º–∞—Ä–∫–∏—Ä—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–≤–µ—á–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ —Ü–µ–Ω—ã.
//
// Overlay component for Universal Indicator v3.
// Displays Fibonacci levels using logarithmic scale
// and marks key candles on the price chart.
//
// –í–ê–ñ–ù–û: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º!
// IMPORTANT: Settings must match the main indicator!

// ============================================================================
// –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ / INPUTS
// ============================================================================

// RSI Settings (must match main indicator)
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º)
rsiLength = input.int(14, "RSI Length / –ü–µ—Ä–∏–æ–¥ RSI", minval=1, group="RSI Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI (–°–æ–≤–ø–∞–¥–∞—é—Ç)")
rsiSmoothLength = input.int(3, "RSI Smoothing / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ RSI", minval=1, group="RSI Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI (–°–æ–≤–ø–∞–¥–∞—é—Ç)")
rsiOversold = input.int(30, "Oversold Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏", minval=1, maxval=50, group="RSI Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI (–°–æ–≤–ø–∞–¥–∞—é—Ç)")
rsiOverbought = input.int(70, "Overbought Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏", minval=50, maxval=100, group="RSI Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI (–°–æ–≤–ø–∞–¥–∞—é—Ç)")

// Volume-Momentum Settings (must match main indicator)
// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞ –∏ –º–æ–º–µ–Ω—Ç—É–º–∞ (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å–Ω–æ–≤–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º)
volumeMaLength = input.int(20, "Volume MA Length / –ü–µ—Ä–∏–æ–¥ MA –æ–±—ä–µ–º–∞", minval=1, group="Momentum Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–º–µ–Ω—Ç—É–º–∞ (–°–æ–≤–ø–∞–¥–∞—é—Ç)")
momentumThreshold = input.float(1.2, "Momentum Threshold / –ü–æ—Ä–æ–≥ –º–æ–º–µ–Ω—Ç—É–º–∞", minval=1.0, step=0.1, group="Momentum Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–º–µ–Ω—Ç—É–º–∞ (–°–æ–≤–ø–∞–¥–∞—é—Ç)")
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / –ú–∏–Ω. –±–∞—Ä–æ–≤ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏", minval=1, group="Momentum Settings (Match Main) / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–º–µ–Ω—Ç—É–º–∞ (–°–æ–≤–ø–∞–¥–∞—é—Ç)")

// Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏
showBullishFib = input.bool(true, "Show Bullish Fibonacci / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ —É—Ä–æ–≤–Ω–∏", group="Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
showBearishFib = input.bool(true, "Show Bearish Fibonacci / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —É—Ä–æ–≤–Ω–∏", group="Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
showLabels = input.bool(true, "Show Level Labels / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∫–∏ —É—Ä–æ–≤–Ω–µ–π", group="Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
showTable = input.bool(true, "Show Levels Table / –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —É—Ä–æ–≤–Ω–µ–π", group="Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏")
lineExtension = input.int(10, "Line Extension (bars) / –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π (—Å–≤–µ—á–µ–π)", minval=1, maxval=50, group="Fibonacci Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –§–∏–±–æ–Ω–∞—á—á–∏")

// Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
showBullishMarkers = input.bool(true, "Show Bullish Candle Markers / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ –º–∞—Ä–∫–µ—Ä—ã", group="Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
showBearishMarkers = input.bool(true, "Show Bearish Candle Markers / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ –º–∞—Ä–∫–µ—Ä—ã", group="Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
highlightSignalCandles = input.bool(true, "Highlight Signal Candles / –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å —Å–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Å–≤–µ—á–∏", group="Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")

// Candlestick Pattern Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å–≤–µ—á–µ–π
enableCandlePatterns = input.bool(true, "Enable Candlestick Patterns / –í–∫–ª—é—á–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å–≤–µ—á–µ–π", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
showCandlePatterns = input.bool(true, "Show Pattern Labels / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
patternSensitivity = input.string("Medium", "Pattern Sensitivity / –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤", options=["Strict", "Medium", "Relaxed"], group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
useHammer = input.bool(true, "Use Hammer / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ú–æ–ª–æ—Ç", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
useEngulfing = input.bool(true, "Use Engulfing / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü–æ–≥–ª–æ—â–µ–Ω–∏–µ", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
useStarPatterns = input.bool(true, "Use Star Patterns / –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ó–≤—ë–∑–¥–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")
showPatternStats = input.bool(true, "Show Pattern Statistics / –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤", group="üïØÔ∏è Candle Patterns / –ü–∞—Ç—Ç–µ—Ä–Ω—ã –°–≤–µ—á–µ–π")

// ============================================================================
// –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í / INDICATOR CALCULATIONS
// ============================================================================
// Duplicate logic from main indicator to detect signals
// –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤

// RSI Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum / –û–±—ä–µ–º–Ω—ã–π –º–æ–º–µ–Ω—Ç—É–º
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought

// Momentum Confirmation / –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –º–æ–º–µ–Ω—Ç—É–º–∞
strongMomentum = volumeMomentum > momentumThreshold

// ============================================================================
// –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ü–ê–¢–¢–ï–†–ù–û–í –°–í–ï–ß–ï–ô / CANDLESTICK PATTERN RECOGNITION
// ============================================================================

// Get sensitivity multipliers based on user setting
// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
float bodyThreshold = patternSensitivity == "Strict" ? 0.25 : patternSensitivity == "Medium" ? 0.3 : 0.35
float wickRatio = patternSensitivity == "Strict" ? 2.5 : patternSensitivity == "Medium" ? 2.0 : 1.5

// Helper functions for candle measurements
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Å–≤–µ—á–µ–π
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low

// Calculate EMA for trend detection
// –í—ã—á–∏—Å–ª–µ–Ω–∏–µ EMA –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–µ–Ω–¥–∞
ema20 = ta.ema(close, 20)

// Function: Hammer pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ú–æ–ª–æ—Ç
isHammer() =>
    smallBody = bodySize < totalRange * bodyThreshold
    longLowerWick = lowerWick > bodySize * wickRatio
    shortUpperWick = upperWick < bodySize * 0.5
    inDowntrend = close < ema20
    totalRange > 0 and smallBody and longLowerWick and shortUpperWick and inDowntrend

// Function: Shooting Star pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ü–∞–¥–∞—é—â–∞—è –∑–≤–µ–∑–¥–∞
isShootingStar() =>
    smallBody = bodySize < totalRange * bodyThreshold
    longUpperWick = upperWick > bodySize * wickRatio
    shortLowerWick = lowerWick < bodySize * 0.5
    inUptrend = close > ema20
    totalRange > 0 and smallBody and longUpperWick and shortLowerWick and inUptrend

// Function: Bullish Engulfing pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ë—ã—á—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ
isBullishEngulfing() =>
    prevBearish = close[1] < open[1]
    currentBullish = close > open
    engulfs = open < close[1] and close > open[1]
    inDowntrend = close < ema20
    prevBearish and currentBullish and engulfs and inDowntrend

// Function: Bearish Engulfing pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ú–µ–¥–≤–µ–∂—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ
isBearishEngulfing() =>
    prevBullish = close[1] > open[1]
    currentBearish = close < open
    engulfs = open > close[1] and close < open[1]
    inUptrend = close > ema20
    prevBullish and currentBearish and engulfs and inUptrend

// Function: Morning Star pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –£—Ç—Ä–µ–Ω–Ω—è—è –∑–≤–µ–∑–¥–∞
isMorningStar() =>
    firstBearish = (open[2] - close[2]) > (high[2] - low[2]) * 0.6
    secondSmall = math.abs(close[1] - open[1]) < (high[2] - low[2]) * bodyThreshold
    thirdBullish = (close - open) > (high - low) * 0.6
    thirdCloseAboveMid = close > (open[2] + close[2]) / 2
    firstBearish and secondSmall and thirdBullish and thirdCloseAboveMid

// Function: Evening Star pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –í–µ—á–µ—Ä–Ω—è—è –∑–≤–µ–∑–¥–∞
isEveningStar() =>
    firstBullish = (close[2] - open[2]) > (high[2] - low[2]) * 0.6
    secondSmall = math.abs(close[1] - open[1]) < (high[2] - low[2]) * bodyThreshold
    thirdBearish = (open - close) > (high - low) * 0.6
    thirdCloseBelowMid = close < (open[2] + close[2]) / 2
    firstBullish and secondSmall and thirdBearish and thirdCloseBelowMid

// Function: Doji pattern detection
// –§—É–Ω–∫—Ü–∏—è: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –î–æ–¥–∂–∏
isDoji() =>
    totalRange > 0 and bodySize < totalRange * 0.1

// Detect patterns based on user settings
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
hammer = enableCandlePatterns and useHammer and isHammer()
shootingStar = enableCandlePatterns and useHammer and isShootingStar()
bullishEngulfing = enableCandlePatterns and useEngulfing and isBullishEngulfing()
bearishEngulfing = enableCandlePatterns and useEngulfing and isBearishEngulfing()
morningStar = enableCandlePatterns and useStarPatterns and isMorningStar()
eveningStar = enableCandlePatterns and useStarPatterns and isEveningStar()
doji = enableCandlePatterns and isDoji()

// Combined pattern signals
// –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
bullishCandlePattern = hammer or bullishEngulfing or morningStar
bearishCandlePattern = shootingStar or bearishEngulfing or eveningStar

// Pattern counters for statistics
// –°—á—ë—Ç—á–∏–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
var int hammerCount = 0
var int shootingStarCount = 0
var int bullishEngulfCount = 0
var int bearishEngulfCount = 0
var int morningStarCount = 0
var int eveningStarCount = 0
var int dojiCount = 0

if hammer
    hammerCount += 1
if shootingStar
    shootingStarCount += 1
if bullishEngulfing
    bullishEngulfCount += 1
if bearishEngulfing
    bearishEngulfCount += 1
if morningStar
    morningStarCount += 1
if eveningStar
    eveningStarCount += 1
if doji
    dojiCount += 1

// ============================================================================
// –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –ü–ê–¢–¢–ï–†–ù–û–í –° –°–ò–ì–ù–ê–õ–ê–ú–ò / PATTERN SIGNAL INTEGRATION
// ============================================================================

// Signal Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]

bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]

// Integrate candlestick patterns with original signal logic
// –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å–≤–µ—á–µ–π —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π —Å–∏–≥–Ω–∞–ª–æ–≤
bullishSignalRaw = (bullishTransition and strongMomentum and rsiRising) or
                   (enableCandlePatterns and bullishCandlePattern and strongMomentum and isOversold)

bearishSignalRaw = (bearishTransition and strongMomentum and rsiFalling) or
                   (enableCandlePatterns and bearishCandlePattern and strongMomentum and isOverbought)

// Filter signals / –§–∏–ª—å—Ç—Ä —Å–∏–≥–Ω–∞–ª–æ–≤
var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

bullishSignal = bullishSignalRaw and signalAllowed
bearishSignal = bearishSignalRaw and signalAllowed

if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// ============================================================================
// –£–ü–†–ê–í–õ–ï–ù–ò–ï –§–ò–ë–û–ù–ê–ß–ß–ò / FIBONACCI MANAGEMENT
// ============================================================================

// Arrays to store Fibonacci drawing objects
// –ú–∞—Å—Å–∏–≤—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –§–∏–±–æ–Ω–∞—á—á–∏
var line[] activeFibLines = array.new<line>()
var label[] activeFibLabels = array.new<label>()

// Store last signal information for table display
// –•—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–∏–≥–Ω–∞–ª–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
var bool lastSignalIsBullish = false
var float lastLowPrice = na
var float lastHighPrice = na

// Function to delete old Fibonacci objects
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –§–∏–±–æ–Ω–∞—á—á–∏
deleteOldFibonacci() =>
    // Delete lines / –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π
    if array.size(activeFibLines) > 0
        for i = array.size(activeFibLines) - 1 to 0
            line.delete(array.get(activeFibLines, i))
        array.clear(activeFibLines)

    // Delete labels / –£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫
    if array.size(activeFibLabels) > 0
        for i = array.size(activeFibLabels) - 1 to 0
            label.delete(array.get(activeFibLabels, i))
        array.clear(activeFibLabels)

// Function to calculate logarithmic Fibonacci price
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —Ü–µ–Ω—ã –§–∏–±–æ–Ω–∞—á—á–∏
calcLogFibPrice(float lowPrice, float highPrice, float level, bool isBullish) =>
    float result = na
    if not na(lowPrice) and not na(highPrice) and lowPrice > 0 and highPrice > 0
        logLow = math.log(lowPrice)
        logHigh = math.log(highPrice)
        logRange = logHigh - logLow

        // Declare logPrice variable before using it
        float logPrice = na

        if isBullish
            // For bullish: build from Low to High
            // level 0.0 = High, level 1.0 = Low
            // Negative levels go above High
            logPrice := logHigh - (logRange * level)
        else
            // For bearish: build from High to Low
            // level 0.0 = High, level 1.0 = Low
            // Negative levels go above High
            logPrice := logHigh - (logRange * level)

        result := math.exp(logPrice)
    result

// Function to draw Fibonacci levels with logarithmic scale
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ —Å –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —à–∫–∞–ª–æ–π
// Returns [candleLow, candleHigh, isBullish] for table display
drawFibonacci(float candleLow, float candleHigh, int signalBar, bool isBullish) =>
    var float returnLow = na
    var float returnHigh = na
    var bool returnIsBullish = false

    if not na(candleLow) and not na(candleHigh) and candleLow > 0 and candleHigh > 0 and candleHigh > candleLow

        // Store for return values / –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–π
        returnLow := candleLow
        returnHigh := candleHigh
        returnIsBullish := isBullish

        // Define Fibonacci levels with trading annotations
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ —Å —Ç–æ—Ä–≥–æ–≤—ã–º–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏
        levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.5, 0.618, 0.820, 1.0)
        levelNames = array.from(
             "TP3 (-261.8%)",
             "TP2 (-161.8%)",
             "TP1 (-61.8%)",
             "Entry #1 (0%)",
             "Entry #2 (50%)",
             "Entry #3 (61.8%)",
             "STOP-LOSS (82%)",
             "Base (100%)"
         )

        // Trading annotations for levels
        // –¢–æ—Ä–≥–æ–≤—ã–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        levelAnnotations = array.from(
             "–ó–∞–∫—Ä—ã—Ç—å 40%",
             "–ó–∞–∫—Ä—ã—Ç—å 30%",
             "–ó–∞–∫—Ä—ã—Ç—å 30%",
             "1% –¥–µ–ø–æ–∑–∏—Ç–∞",
             "–õ–∏–º–∏—Ç–∫–∞ 1%",
             "–õ–∏–º–∏—Ç–∫–∞ 1%",
             "–°—Ç–æ–ø-–ª–æ—Å—Å",
             "–û—Å–Ω–æ–≤–∞–Ω–∏–µ"
         )

        // Color scheme for levels / –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        levelColors = array.from(
             color.new(#00FF00, 20),    // TP3 - bright green
             color.new(#00CC00, 20),    // TP2 - green
             color.new(#009900, 20),    // TP1 - dark green
             color.new(#FF6600, 0),     // Entry #1 - orange (0% - High of candle)
             color.new(#FFFF00, 20),    // Entry #2 - yellow (50%)
             color.new(#FFD700, 20),    // Entry #3 - gold (61.8%)
             color.new(#FF0000, 0),     // STOP-LOSS - red (82%)
             color.new(#0066FF, 20)     // Base - blue (100% - Low of candle)
         )

        // Line widths / –¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–π
        levelWidths = array.from(2, 2, 2, 3, 2, 2, 3, 3)

        // Draw each level / –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–≤–Ω—è
        for i = 0 to array.size(levels) - 1
            levelRatio = array.get(levels, i)
            levelPrice = calcLogFibPrice(candleLow, candleHigh, levelRatio, isBullish)

            if not na(levelPrice) and levelPrice > 0
                levelName = array.get(levelNames, i)
                annotation = array.get(levelAnnotations, i)
                lineColor = array.get(levelColors, i)
                lineWidth = array.get(levelWidths, i)

                // Create horizontal line extending to the right
                // –°–æ–∑–¥–∞–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ —Å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º –≤–ø—Ä–∞–≤–æ
                newLine = line.new(
                     x1=signalBar,
                     y1=levelPrice,
                     x2=signalBar + lineExtension,
                     y2=levelPrice,
                     color=lineColor,
                     width=lineWidth,
                     style=line.style_solid
                 )

                array.push(activeFibLines, newLine)

                // Create label if enabled / –°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∫–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
                if showLabels
                    labelText = levelName + "\n" + annotation
                    labelBgColor = isBullish ? color.new(color.green, 70) : color.new(color.red, 70)

                    newLabel = label.new(
                         x=signalBar,
                         y=levelPrice,
                         text=labelText,
                         style=label.style_label_left,
                         color=labelBgColor,
                         textcolor=color.white,
                         size=size.small
                     )

                    array.push(activeFibLabels, newLabel)

    // Return values for table display / –í–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ
    [returnLow, returnHigh, returnIsBullish]

// ============================================================================
// –û–ë–†–ê–ë–û–¢–ö–ê –°–ò–ì–ù–ê–õ–û–í / SIGNAL HANDLING
// ============================================================================

// Handle bullish signals / –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—á—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bullishSignal and showBullishFib
    // Delete old Fibonacci levels / –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    deleteOldFibonacci()

    // Use the signal candle's Low and High
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Low –∏ High —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏
    candleLow = low[0]
    candleHigh = high[0]

    // Draw new Fibonacci levels from Low to High (bullish)
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ –æ—Ç Low –¥–æ High (–±—ã—á–∏–π)
    [returnedLow, returnedHigh, returnedIsBullish] = drawFibonacci(candleLow, candleHigh, bar_index, true)
    lastLowPrice := returnedLow
    lastHighPrice := returnedHigh
    lastSignalIsBullish := returnedIsBullish

// Handle bearish signals / –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bearishSignal and showBearishFib
    // Delete old Fibonacci levels / –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
    deleteOldFibonacci()

    // Use the signal candle's Low and High
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Low –∏ High —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏
    candleLow = low[0]
    candleHigh = high[0]

    // Draw new Fibonacci levels from High to Low (bearish)
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ –æ—Ç High –¥–æ Low (–º–µ–¥–≤–µ–∂–∏–π)
    [returnedLow, returnedHigh, returnedIsBullish] = drawFibonacci(candleLow, candleHigh, bar_index, false)
    lastLowPrice := returnedLow
    lastHighPrice := returnedHigh
    lastSignalIsBullish := returnedIsBullish

// ============================================================================
// –¢–ê–ë–õ–ò–¶–ê –£–†–û–í–ù–ï–ô / LEVELS TABLE
// ============================================================================

// Create table to display Fibonacci levels
// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏
var table fibTable = table.new(position.top_right, 3, 9, border_width=1)

if showTable and barstate.islast and not na(lastLowPrice) and not na(lastHighPrice)
    // Table header / –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    table.cell(fibTable, 0, 0, "–£—Ä–æ–≤–µ–Ω—å / Level", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    table.cell(fibTable, 1, 0, "–¶–µ–Ω–∞ / Price", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)
    table.cell(fibTable, 2, 0, "–î–µ–π—Å—Ç–≤–∏–µ / Action", text_color=color.white, bgcolor=color.new(color.gray, 30), text_size=size.small)

    // Define levels for table / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    levels = array.from(-2.618, -1.618, -0.618, 0.0, 0.5, 0.618, 0.820, 1.0)
    levelNames = array.from("TP3 (-261.8%)", "TP2 (-161.8%)", "TP1 (-61.8%)", "Entry #1 (0%)", "Entry #2 (50%)", "Entry #3 (61.8%)", "STOP-LOSS (82%)", "Base (100%)")
    levelAnnotations = array.from("–ó–∞–∫—Ä—ã—Ç—å 40%", "–ó–∞–∫—Ä—ã—Ç—å 30%", "–ó–∞–∫—Ä—ã—Ç—å 30%", "1% –¥–µ–ø–æ–∑–∏—Ç–∞", "–õ–∏–º–∏—Ç–∫–∞ 1%", "–õ–∏–º–∏—Ç–∫–∞ 1%", "–°—Ç–æ–ø-–ª–æ—Å—Å", "–û—Å–Ω–æ–≤–∞–Ω–∏–µ")

    // Colors matching the lines / –¶–≤–µ—Ç–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ª–∏–Ω–∏—è–º
    levelColors = array.from(
         color.new(#00FF00, 60),    // TP3
         color.new(#00CC00, 60),    // TP2
         color.new(#009900, 60),    // TP1
         color.new(#FF6600, 60),    // Entry #1
         color.new(#FFFF00, 60),    // Entry #2
         color.new(#FFD700, 60),    // Entry #3
         color.new(#FF0000, 60),    // STOP-LOSS
         color.new(#0066FF, 60)     // Base
     )

    // Fill table rows / –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    for i = 0 to array.size(levels) - 1
        levelRatio = array.get(levels, i)
        levelPrice = calcLogFibPrice(lastLowPrice, lastHighPrice, levelRatio, lastSignalIsBullish)

        if not na(levelPrice) and levelPrice > 0
            levelName = array.get(levelNames, i)
            annotation = array.get(levelAnnotations, i)
            bgColor = array.get(levelColors, i)

            table.cell(fibTable, 0, i + 1, levelName, text_color=color.white, bgcolor=bgColor, text_size=size.small)
            table.cell(fibTable, 1, i + 1, str.tostring(levelPrice, format.mintick), text_color=color.white, bgcolor=bgColor, text_size=size.small)
            table.cell(fibTable, 2, i + 1, annotation, text_color=color.white, bgcolor=bgColor, text_size=size.small)

// ============================================================================
// –ú–ê–†–ö–ï–†–´ –°–í–ï–ß–ï–ô / CANDLE MARKERS
// ============================================================================

// Mark bullish signal candles / –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –±—ã—á—å–∏—Ö —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π
plotshape(
     showBullishMarkers and bullishSignal,
     title="Bullish Signal Candle / –ë—ã—á—å—è —Å–∏–≥–Ω–∞–ª—å–Ω–∞—è —Å–≤–µ—á–∞",
     location=location.belowbar,
     color=color.new(color.green, 0),
     style=shape.triangleup,
     size=size.normal,
     text="BUY\n–ü–û–ö–£–ü–ö–ê"
 )

// Mark bearish signal candles / –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π
plotshape(
     showBearishMarkers and bearishSignal,
     title="Bearish Signal Candle / –ú–µ–¥–≤–µ–∂—å—è —Å–∏–≥–Ω–∞–ª—å–Ω–∞—è —Å–≤–µ—á–∞",
     location=location.abovebar,
     color=color.new(color.red, 0),
     style=shape.triangledown,
     size=size.normal,
     text="SELL\n–ü–†–û–î–ê–ñ–ê"
 )

// Highlight signal candles with bar color
// –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–≤–µ—á–µ–π —Ü–≤–µ—Ç–æ–º –±–∞—Ä–∞
barcolor(
     highlightSignalCandles and bullishSignal and showBullishMarkers ? color.new(color.green, 60) :
     highlightSignalCandles and bearishSignal and showBearishMarkers ? color.new(color.red, 60) : na,
     title="Signal Candle Highlight / –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–π —Å–≤–µ—á–∏"
 )

// ============================================================================
// –ú–ï–¢–ö–ò –ü–ê–¢–¢–ï–†–ù–û–í –°–í–ï–ß–ï–ô / CANDLESTICK PATTERN LABELS
// ============================================================================

// Display candlestick pattern labels
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å–≤–µ—á–µ–π
if showCandlePatterns and enableCandlePatterns
    if hammer
        label.new(bar_index, low, "üî® Hammer",
                 color=color.new(color.green, 30),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.tiny)

    if bullishEngulfing
        label.new(bar_index, low, "‚¨ÜÔ∏è Bull Engulf",
                 color=color.new(color.green, 30),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.tiny)

    if morningStar
        label.new(bar_index, low, "‚≠ê Morning Star",
                 color=color.new(color.green, 30),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.tiny)

    if shootingStar
        label.new(bar_index, high, "üí´ Shooting Star",
                 color=color.new(color.red, 30),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.tiny)

    if bearishEngulfing
        label.new(bar_index, high, "‚¨áÔ∏è Bear Engulf",
                 color=color.new(color.red, 30),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.tiny)

    if eveningStar
        label.new(bar_index, high, "üåô Evening Star",
                 color=color.new(color.red, 30),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.tiny)

    if doji
        label.new(bar_index, high, "‚ûï Doji",
                 color=color.new(color.gray, 50),
                 textcolor=color.white,
                 style=label.style_label_center,
                 size=size.tiny)

// ============================================================================
// –¢–ê–ë–õ–ò–¶–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–ê–¢–¢–ï–†–ù–û–í / PATTERN STATISTICS TABLE
// ============================================================================

// Display pattern statistics table
// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
if showPatternStats and enableCandlePatterns and barstate.islast
    var table patternStatsTable = table.new(position.bottom_left, 2, 8, border_width=1)

    // Table header / –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã
    table.cell(patternStatsTable, 0, 0, "Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω",
              text_color=color.white,
              bgcolor=color.new(color.blue, 30),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 0, "Count / –ö–æ–ª-–≤–æ",
              text_color=color.white,
              bgcolor=color.new(color.blue, 30),
              text_size=size.small)

    // Pattern rows / –°—Ç—Ä–æ–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    table.cell(patternStatsTable, 0, 1, "üî® Hammer / –ú–æ–ª–æ—Ç",
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 1, str.tostring(hammerCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 2, "üí´ Shooting Star / –ü–∞–¥–∞—é—â–∞—è –∑–≤–µ–∑–¥–∞",
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 2, str.tostring(shootingStarCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 3, "‚¨ÜÔ∏è Bullish Engulf / –ë—ã—á—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ",
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 3, str.tostring(bullishEngulfCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 4, "‚¨áÔ∏è Bearish Engulf / –ú–µ–¥–≤–µ–∂—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ",
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 4, str.tostring(bearishEngulfCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 5, "‚≠ê Morning Star / –£—Ç—Ä–µ–Ω–Ω—è—è –∑–≤–µ–∑–¥–∞",
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 5, str.tostring(morningStarCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 6, "üåô Evening Star / –í–µ—á–µ—Ä–Ω—è—è –∑–≤–µ–∑–¥–∞",
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 6, str.tostring(eveningStarCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 70),
              text_size=size.small)

    table.cell(patternStatsTable, 0, 7, "‚ûï Doji / –î–æ–¥–∂–∏",
              text_color=color.white,
              bgcolor=color.new(color.gray, 70),
              text_size=size.small)
    table.cell(patternStatsTable, 1, 7, str.tostring(dojiCount),
              text_color=color.white,
              bgcolor=color.new(color.gray, 70),
              text_size=size.small)

// ============================================================================
// –ê–õ–ï–†–¢–´ / ALERTS
// ============================================================================

alertcondition(bullishSignal, "Bullish Fibonacci Signal / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª —Å –§–∏–±–æ–Ω–∞—á—á–∏",
               "Bullish signal with logarithmic Fibonacci levels drawn / –ë—ã—á–∏–π —Å–∏–≥–Ω–∞–ª —Å –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –§–∏–±–æ–Ω–∞—á—á–∏")

alertcondition(bearishSignal, "Bearish Fibonacci Signal / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª —Å –§–∏–±–æ–Ω–∞—á—á–∏",
               "Bearish signal with logarithmic Fibonacci levels drawn / –ú–µ–¥–≤–µ–∂–∏–π —Å–∏–≥–Ω–∞–ª —Å –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –§–∏–±–æ–Ω–∞—á—á–∏")

// Candlestick pattern alerts
// –ê–ª–µ—Ä—Ç—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å–≤–µ—á–µ–π
alertcondition(bullishCandlePattern, "Bullish Candlestick Pattern / –ë—ã—á–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–≤–µ—á–µ–π",
               "Bullish candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –±—ã—á–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–≤–µ—á–µ–π")

alertcondition(bearishCandlePattern, "Bearish Candlestick Pattern / –ú–µ–¥–≤–µ–∂–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–≤–µ—á–µ–π",
               "Bearish candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –º–µ–¥–≤–µ–∂–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–≤–µ—á–µ–π")

alertcondition(hammer, "Hammer Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –ú–æ–ª–æ—Ç",
               "Hammer candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –ú–æ–ª–æ—Ç")

alertcondition(shootingStar, "Shooting Star Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –ü–∞–¥–∞—é—â–∞—è –∑–≤–µ–∑–¥–∞",
               "Shooting Star candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –ü–∞–¥–∞—é—â–∞—è –∑–≤–µ–∑–¥–∞")

alertcondition(bullishEngulfing, "Bullish Engulfing Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –ë—ã—á—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ",
               "Bullish Engulfing candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –ë—ã—á—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ")

alertcondition(bearishEngulfing, "Bearish Engulfing Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –ú–µ–¥–≤–µ–∂—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ",
               "Bearish Engulfing candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –ú–µ–¥–≤–µ–∂—å–µ –ø–æ–≥–ª–æ—â–µ–Ω–∏–µ")

alertcondition(morningStar, "Morning Star Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –£—Ç—Ä–µ–Ω–Ω—è—è –∑–≤–µ–∑–¥–∞",
               "Morning Star candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –£—Ç—Ä–µ–Ω–Ω—è—è –∑–≤–µ–∑–¥–∞")

alertcondition(eveningStar, "Evening Star Pattern / –ü–∞—Ç—Ç–µ—Ä–Ω –í–µ—á–µ—Ä–Ω—è—è –∑–≤–µ–∑–¥–∞",
               "Evening Star candlestick pattern detected / –û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω –í–µ—á–µ—Ä–Ω—è—è –∑–≤–µ–∑–¥–∞")

// ============================================================================
// –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø / NOTES
// ============================================================================

// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é / Usage recommendations:
//
// 1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤–º–µ—Å—Ç–µ:
//    - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä v2 (–æ—Å–Ω–æ–≤–Ω–æ–π, overlay=false)
//    - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä v3 - Fibonacci Overlay (—ç—Ç–æ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä)
//
// 2. Use both indicators together:
//    - Universal Indicator v2 (main, overlay=false)
//    - Universal Indicator v3 - Fibonacci Overlay (this indicator)
//
// 3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—Ç –º–µ–∂–¥—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏
//    Make sure all settings match between indicators
//
// 4. –£—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏ —Å—Ç—Ä–æ—è—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–π —à–∫–∞–ª—ã
//    Fibonacci levels are built using logarithmic scale
//
// 5. –î–ª—è –±—ã—á—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤: –§–∏–±–æ–Ω–∞—á—á–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –æ—Ç Low –¥–æ High —Å–≤–µ—á–∏
//    For bullish signals: Fibonacci is built from Low to High of candle
//
// 6. –î–ª—è –º–µ–¥–≤–µ–∂—å–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤: –§–∏–±–æ–Ω–∞—á—á–∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –æ—Ç High –¥–æ Low —Å–≤–µ—á–∏
//    For bearish signals: Fibonacci is built from High to Low of candle
//
// 7. –£—Ä–æ–≤–Ω–∏:
//    - TP1, TP2, TP3: –¶–µ–ª–∏ –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –ø—Ä–∏–±—ã–ª–∏ (–≤—ã—à–µ –≤—Ö–æ–¥–∞ –¥–ª—è –ª–æ–Ω–≥–æ–≤)
//    - Entry #1: –í—Ö–æ–¥ –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ –Ω–∞ High —Å–≤–µ—á–∏ (0%)
//    - Entry #2, #3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—Ö–æ–¥—ã –ª–∏–º–∏—Ç–Ω—ã–º–∏ –æ—Ä–¥–µ—Ä–∞–º–∏ (50%, 61.8%)
//    - STOP-LOSS: –£—Ä–æ–≤–µ–Ω—å —Å—Ç–æ–ø-–ª–æ—Å—Å–∞ (82%)
//    - Base: –û—Å–Ω–æ–≤–∞–Ω–∏–µ, Low —Å–≤–µ—á–∏ (100%)
//
// 8. Levels:
//    - TP1, TP2, TP3: Take-profit targets (above entry for longs)
//    - Entry #1: Market entry at candle High (0%)
//    - Entry #2, #3: Additional limit entries (50%, 61.8%)
//    - STOP-LOSS: Stop-loss level (82%)
//    - Base: Foundation, candle Low (100%)
