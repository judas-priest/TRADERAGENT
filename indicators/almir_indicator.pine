// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// ¬© TRADERAGENT

//@version=6
indicator("ALMIR - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–≤–µ—á–µ–π –¥–ª—è –§–∏–±–æ–Ω–∞—á—á–∏", shorttitle="ALMIR", overlay=false, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ============================================================================
// –û–ü–ò–°–ê–ù–ò–ï / DESCRIPTION
// ============================================================================
// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä ALMIR –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö —Å–≤–µ—á–µ–π –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
// —É—Ä–æ–≤–Ω–µ–π –§–∏–±–æ–Ω–∞—á—á–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä–æ–≤.
//
// ALMIR indicator for automatic detection of key candles and Fibonacci levels
// based on multiple oscillator states.
//
// –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ RSIV_Step_[Almir] —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
// (1, 10, 3, 50, 30, 10, 10, 0, 2, 0, 2, 30, 10, 20, 3, 14, 24, 5, 0,85, 6, 200, 5, 9, 2, 65, 30, 83, 12, 3, 0,6, 2)
//
// Based on RSIV_Step_[Almir] indicator analysis with parameters above.
// ============================================================================

// ============================================================================
// –í–•–û–î–ù–´–ï –ü–ê–†–ê–ú–ï–¢–†–´ / INPUT PARAMETERS
// ============================================================================

// === RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI ===
rsiLength = input.int(10, "RSI Length / –ü–µ—Ä–∏–æ–¥ RSI", minval=1, group="üìä RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI")
rsiSmoothLength = input.int(3, "RSI Smoothing / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ RSI", minval=1, group="üìä RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI")
rsiOversold = input.int(30, "Oversold Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏", minval=1, maxval=50, group="üìä RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI")
rsiOverbought = input.int(70, "Overbought Level / –£—Ä–æ–≤–µ–Ω—å –ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏", minval=50, maxval=100, group="üìä RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI")
rsiMidLevel = input.int(50, "Mid Level / –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å", minval=30, maxval=70, group="üìä RSI Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ RSI")

// === MACD Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MACD ===
macdFast = input.int(10, "MACD Fast Length / –ë—ã—Å—Ç—Ä–∞—è –ª–∏–Ω–∏—è", minval=1, group="üìà MACD Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MACD")
macdSlow = input.int(30, "MACD Slow Length / –ú–µ–¥–ª–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è", minval=1, group="üìà MACD Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MACD")
macdSignal = input.int(20, "MACD Signal Length / –°–∏–≥–Ω–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è", minval=1, group="üìà MACD Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MACD")

// === Stochastic Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stochastic ===
stochLength = input.int(14, "Stochastic Length / –ü–µ—Ä–∏–æ–¥ Stochastic", minval=1, group="üìâ Stochastic Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stochastic")
stochSmooth = input.int(3, "Stochastic Smooth / –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ", minval=1, group="üìâ Stochastic Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stochastic")
stochOversold = input.int(20, "Stochastic Oversold / –ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å", minval=1, maxval=50, group="üìâ Stochastic Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stochastic")
stochOverbought = input.int(80, "Stochastic Overbought / –ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å", minval=50, maxval=100, group="üìâ Stochastic Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Stochastic")

// === Volume Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞ ===
volumeMaLength = input.int(20, "Volume MA Length / –ü–µ—Ä–∏–æ–¥ MA –æ–±—ä–µ–º–∞", minval=1, group="üìä Volume Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞")
volumeMultiplier = input.float(1.5, "Volume Multiplier / –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–±—ä–µ–º–∞", minval=1.0, step=0.1, group="üìä Volume Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞")
useDirectionalVolume = input.bool(true, "Use Directional Volume / –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä—ë–º", group="üìä Volume Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–º–∞")

// === EMA Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ EMA ===
ema1Length = input.int(9, "EMA 1 Length / –ü–µ—Ä–∏–æ–¥ EMA 1", minval=1, group="üìà EMA Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ EMA")
ema2Length = input.int(50, "EMA 2 Length / –ü–µ—Ä–∏–æ–¥ EMA 2", minval=1, group="üìà EMA Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ EMA")
ema3Length = input.int(200, "EMA 3 Length / –ü–µ—Ä–∏–æ–¥ EMA 3", minval=1, group="üìà EMA Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ EMA")

// === Confluence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Confluence ===
minConfluenceScore = input.int(5, "Min Confluence Score / –ú–∏–Ω. –±–∞–ª–ª confluence", minval=2, maxval=15, group="üéØ Confluence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Confluence")
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / –ú–∏–Ω. –±–∞—Ä–æ–≤ –º–µ–∂–¥—É —Å–∏–≥–Ω–∞–ª–∞–º–∏", minval=1, group="üéØ Confluence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Confluence")

// Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
rsiWeight = input.int(2, "RSI Weight / –í–µ—Å RSI", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
macdWeight = input.int(2, "MACD Weight / –í–µ—Å MACD", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
stochWeight = input.int(1, "Stochastic Weight / –í–µ—Å Stochastic", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
volumeWeight = input.int(2, "Volume Weight / –í–µ—Å –æ–±—ä—ë–º–∞", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
priceActionWeight = input.int(1, "Price Action Weight / –í–µ—Å Price Action", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
maWeight = input.int(1, "EMA Weight / –í–µ—Å EMA", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")
divergenceWeight = input.int(2, "Divergence Weight / –í–µ—Å –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏", minval=0, maxval=5, group="‚öñÔ∏è Indicator Weights / –í–µ—Å–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤")

// === Divergence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π ===
enableDivergence = input.bool(true, "Enable Divergence Detection / –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π", group="üîÑ Divergence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π")
divergenceLookback = input.int(5, "Divergence Lookback / –ü–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞", minval=2, maxval=20, group="üîÑ Divergence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π")
minDivergenceStrength = input.float(0.05, "Min Divergence Strength / –ú–∏–Ω. —Å–∏–ª–∞ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏", minval=0.01, step=0.01, group="üîÑ Divergence Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π")

// === Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã ===
enableAdaptiveFilters = input.bool(true, "Enable Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã", group="üîß Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã")
enableTrendFilter = input.bool(true, "Filter Against Strong Trend / –§–∏–ª—å—Ç—Ä –ø—Ä–æ—Ç–∏–≤ —Ç—Ä–µ–Ω–¥–∞", group="üîß Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã")
enableVolatilityFilter = input.bool(true, "Enable Volatility Filter / –§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", group="üîß Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã")
highVolThreshold = input.float(1.5, "High Volatility Threshold / –ü–æ—Ä–æ–≥ –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", minval=1.0, step=0.1, group="üîß Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã")
lowVolThreshold = input.float(0.8, "Low Volatility Threshold / –ü–æ—Ä–æ–≥ –Ω–∏–∑–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏", minval=0.1, maxval=1.0, step=0.1, group="üîß Adaptive Filters / –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã")

// === Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ===
showBullishSignals = input.bool(true, "Show Bullish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –±—ã—á—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="üé® Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
showBearishSignals = input.bool(true, "Show Bearish Signals / –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–¥–≤–µ–∂—å–∏ —Å–∏–≥–Ω–∞–ª—ã", group="üé® Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
showZones = input.bool(true, "Show Colored Zones / –ü–æ–∫–∞–∑–∞—Ç—å —Ü–≤–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã", group="üé® Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
showTable = input.bool(true, "Show Info Table / –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É", group="üé® Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
showConfluenceDetails = input.bool(true, "Show Confluence Details / –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ confluence", group="üé® Display Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")

// ============================================================================
// –í–´–ß–ò–°–õ–ï–ù–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–û–í / INDICATOR CALCULATIONS
// ============================================================================

// === RSI Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RSI ===
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// RSI Zone Colors / –¶–≤–µ—Ç–∞ –∑–æ–Ω RSI
rsiColor = rsi >= rsiOverbought ? color.new(color.red, 70) :
           rsi <= rsiOversold ? color.new(color.green, 70) :
           color.new(color.gray, 90)

// === MACD Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ MACD ===
[macdLine, signalLine, macdHist] = ta.macd(close, macdFast, macdSlow, macdSignal)
macdBullish = ta.crossover(macdLine, signalLine) and macdLine < 0
macdBearish = ta.crossunder(macdLine, signalLine) and macdLine > 0

// === Stochastic Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Stochastic ===
stochK = ta.stoch(close, high, low, stochLength)
stochD = ta.sma(stochK, stochSmooth)
stochBullish = ta.crossover(stochK, stochD) and stochK < stochOversold
stochBearish = ta.crossunder(stochK, stochD) and stochK > stochOverbought

// === Volume Analysis / –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–º–∞ ===
volumeMa = ta.sma(volume, volumeMaLength)
volumeRatio = volume / volumeMa
strongVolume = volumeRatio > volumeMultiplier

// Directional Volume / –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–º
isBuyingPressure = close > open and strongVolume
isSellingPressure = close < open and strongVolume

// === EMA Calculation / –í—ã—á–∏—Å–ª–µ–Ω–∏–µ EMA ===
ema1 = ta.ema(close, ema1Length)
ema2 = ta.ema(close, ema2Length)
ema3 = ta.ema(close, ema3Length)

// EMA Signals / –°–∏–≥–Ω–∞–ª—ã EMA
emaBullish = ta.crossover(ema1, ema2) and ema1 > ema3
emaBearish = ta.crossunder(ema1, ema2) and ema1 < ema3

// === Price Action Analysis / –ê–Ω–∞–ª–∏–∑ Price Action ===
candleRange = high - low
candleBody = math.abs(close - open)
isBullishCandle = (close > open) and (candleBody > candleRange * 0.6) and candleRange > 0
isBearishCandle = (open > close) and (candleBody > candleRange * 0.6) and candleRange > 0

// === ATR for Volatility / ATR –¥–ª—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ ===
atrLength = 14
atr = ta.atr(atrLength)
atrMa = ta.sma(atr, 20)
atrRatio = atr / atrMa
isHighVolatility = atrRatio > highVolThreshold
isLowVolatility = atrRatio < lowVolThreshold

// === ADX for Trend Strength / ADX –¥–ª—è —Å–∏–ª—ã —Ç—Ä–µ–Ω–¥–∞ ===
adxLength = 14
[diPlus, diMinus, adx] = ta.dmi(adxLength, adxLength)
isTrendingUp = adx > 25 and diPlus > diMinus
isTrendingDown = adx > 25 and diMinus > diPlus
isStrongTrend = adx > 30

// ============================================================================
// DIVERGENCE DETECTION / –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–ò–í–ï–†–ì–ï–ù–¶–ò–ô
// ============================================================================

// Find pivot points for price / –ü–æ–∏—Å–∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ —Ü–µ–Ω—ã
pivotLow = ta.pivotlow(low, divergenceLookback, divergenceLookback)
pivotHigh = ta.pivothigh(high, divergenceLookback, divergenceLookback)

// Find pivot points for RSI / –ü–æ–∏—Å–∫ —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤ RSI
rsiPivotLow = ta.pivotlow(rsi, divergenceLookback, divergenceLookback)
rsiPivotHigh = ta.pivothigh(rsi, divergenceLookback, divergenceLookback)

// Store previous pivot values / –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤
var float prevPriceLow = na
var float prevPriceHigh = na
var float prevRsiLow = na
var float prevRsiHigh = na
var int prevLowBar = na
var int prevHighBar = na

// Update previous pivots / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–∫—Å—Ç—Ä–µ–º—É–º–æ–≤
if not na(pivotLow)
    prevPriceLow := pivotLow
    prevLowBar := bar_index

if not na(pivotHigh)
    prevPriceHigh := pivotHigh
    prevHighBar := bar_index

if not na(rsiPivotLow)
    prevRsiLow := rsiPivotLow

if not na(rsiPivotHigh)
    prevRsiHigh := rsiPivotHigh

// Detect bullish divergence / –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –±—ã—á—å–µ–π –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
bullishDivergence = false
bullishDivergenceStrength = 0.0

if enableDivergence and not na(pivotLow) and not na(prevPriceLow) and not na(rsiPivotLow) and not na(prevRsiLow)
    priceLowerLow = pivotLow < prevPriceLow
    rsiHigherLow = rsiPivotLow > prevRsiLow
    inOversoldZone = rsiPivotLow < rsiOversold

    if priceLowerLow and rsiHigherLow and inOversoldZone
        bullishDivergence := true
        bullishDivergenceStrength := prevRsiLow != 0 ? (rsiPivotLow - prevRsiLow) / prevRsiLow : 0.0

// Detect bearish divergence / –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –º–µ–¥–≤–µ–∂—å–µ–π –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
bearishDivergence = false
bearishDivergenceStrength = 0.0

if enableDivergence and not na(pivotHigh) and not na(prevPriceHigh) and not na(rsiPivotHigh) and not na(prevRsiHigh)
    priceHigherHigh = pivotHigh > prevPriceHigh
    rsiLowerHigh = rsiPivotHigh < prevRsiHigh
    inOverboughtZone = rsiPivotHigh > rsiOverbought

    if priceHigherHigh and rsiLowerHigh and inOverboughtZone
        bearishDivergence := true
        bearishDivergenceStrength := prevRsiHigh != 0 ? (prevRsiHigh - rsiPivotHigh) / prevRsiHigh : 0.0

// Strong divergences / –°–∏–ª—å–Ω—ã–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–∏
strongBullishDivergence = bullishDivergence and bullishDivergenceStrength > minDivergenceStrength
strongBearishDivergence = bearishDivergence and bearishDivergenceStrength > minDivergenceStrength

// ============================================================================
// CONFLUENCE SCORE CALCULATION / –†–ê–°–ß–Å–¢ CONFLUENCE SCORE
// ============================================================================

// Initialize scores and reasons / –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–ª–ª–æ–≤ –∏ –ø—Ä–∏—á–∏–Ω
var int bullishScore = 0
var int bearishScore = 0
var array<string> bullishReasons = array.new<string>()
var array<string> bearishReasons = array.new<string>()

// Reset scores / –°–±—Ä–æ—Å –±–∞–ª–ª–æ–≤
bullishScore := 0
bearishScore := 0
array.clear(bullishReasons)
array.clear(bearishReasons)

// === RSI Signals / –°–∏–≥–Ω–∞–ª—ã RSI ===
rsiBullishSignal = ta.crossover(rsi, rsiOversold) and rsiSmooth > rsiSmooth[1]
rsiBearishSignal = ta.crossunder(rsi, rsiOverbought) and rsiSmooth < rsiSmooth[1]

if rsiBullishSignal
    bullishScore += rsiWeight
    array.push(bullishReasons, "RSI bullish reversal")

if rsiBearishSignal
    bearishScore += rsiWeight
    array.push(bearishReasons, "RSI bearish reversal")

// === MACD Signals / –°–∏–≥–Ω–∞–ª—ã MACD ===
if macdBullish
    bullishScore += macdWeight
    array.push(bullishReasons, "MACD bullish cross")

if macdBearish
    bearishScore += macdWeight
    array.push(bearishReasons, "MACD bearish cross")

// === Stochastic Signals / –°–∏–≥–Ω–∞–ª—ã Stochastic ===
if stochBullish
    bullishScore += stochWeight
    array.push(bullishReasons, "Stochastic oversold")

if stochBearish
    bearishScore += stochWeight
    array.push(bearishReasons, "Stochastic overbought")

// === Volume Signals / –°–∏–≥–Ω–∞–ª—ã –æ–±—ä—ë–º–∞ ===
volumeBullish = strongVolume and (useDirectionalVolume ? isBuyingPressure : close > open)
volumeBearish = strongVolume and (useDirectionalVolume ? isSellingPressure : close < open)

if volumeBullish
    bullishScore += volumeWeight
    array.push(bullishReasons, "Strong buying volume")

if volumeBearish
    bearishScore += volumeWeight
    array.push(bearishReasons, "Strong selling volume")

// === Price Action Signals / –°–∏–≥–Ω–∞–ª—ã Price Action ===
if isBullishCandle
    bullishScore += priceActionWeight
    array.push(bullishReasons, "Strong bullish candle")

if isBearishCandle
    bearishScore += priceActionWeight
    array.push(bearishReasons, "Strong bearish candle")

// === EMA Signals / –°–∏–≥–Ω–∞–ª—ã EMA ===
if emaBullish
    bullishScore += maWeight
    array.push(bullishReasons, "EMA bullish cross")

if emaBearish
    bearishScore += maWeight
    array.push(bearishReasons, "EMA bearish cross")

// === Divergence Signals / –°–∏–≥–Ω–∞–ª—ã –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π ===
if strongBullishDivergence
    bullishScore += divergenceWeight
    array.push(bullishReasons, "Bullish divergence")

if strongBearishDivergence
    bearishScore += divergenceWeight
    array.push(bearishReasons, "Bearish divergence")

// ============================================================================
// SIGNAL GENERATION WITH FILTERS / –ì–ï–ù–ï–†–ê–¶–ò–Ø –°–ò–ì–ù–ê–õ–û–í –° –§–ò–õ–¨–¢–†–ê–ú–ò
// ============================================================================

// Track last signal bar / –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
var int lastBullishBar = 0
var int lastBearishBar = 0

// Check minimum distance between signals / –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
barsSinceLastBullish = bar_index - lastBullishBar
barsSinceLastBearish = bar_index - lastBearishBar

// Raw signals based on confluence score / –°—ã—Ä—ã–µ —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ confluence
bullishSignalRaw = bullishScore >= minConfluenceScore and barsSinceLastBullish >= minBarsBetweenSignals
bearishSignalRaw = bearishScore >= minConfluenceScore and barsSinceLastBearish >= minBarsBetweenSignals

// === Apply Adaptive Filters / –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ ===
bool bullishSignalFiltered = bullishSignalRaw
bool bearishSignalFiltered = bearishSignalRaw

if enableAdaptiveFilters
    // Trend Filter / –§–∏–ª—å—Ç—Ä —Ç—Ä–µ–Ω–¥–∞
    if enableTrendFilter and isStrongTrend
        // Don't take signals against strong trend
        // –ù–µ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ —Å–∏–ª—å–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞
        if isTrendingDown
            bullishSignalFiltered := false
        if isTrendingUp
            bearishSignalFiltered := false

    // Volatility Filter / –§–∏–ª—å—Ç—Ä –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
    if enableVolatilityFilter
        // In high volatility, only trade with trend
        // –í –≤—ã—Å–æ–∫–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ —Ç—Ä–µ–Ω–¥—É
        if isHighVolatility
            if not isTrendingUp
                bullishSignalFiltered := false
            if not isTrendingDown
                bearishSignalFiltered := false

// Final signals / –§–∏–Ω–∞–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
bullishSignal = bullishSignalFiltered and showBullishSignals
bearishSignal = bearishSignalFiltered and showBearishSignals

// Update last signal bars / –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—Ä–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
if bullishSignal
    lastBullishBar := bar_index

if bearishSignal
    lastBearishBar := bar_index

// ============================================================================
// PLOTTING / –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================================

// === Plot RSI / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ RSI ===
plot(rsi, "RSI", color=color.new(color.blue, 0), linewidth=2)
plot(rsiSmooth, "RSI Smooth", color=color.new(color.orange, 0), linewidth=1)

// RSI Levels / –£—Ä–æ–≤–Ω–∏ RSI
hline(rsiOverbought, "Overbought", color=color.new(color.red, 50), linestyle=hline.style_dashed)
hline(rsiOversold, "Oversold", color=color.new(color.green, 50), linestyle=hline.style_dashed)
hline(rsiMidLevel, "Mid Level", color=color.new(color.gray, 70), linestyle=hline.style_dotted)

// === Colored Zones / –¶–≤–µ—Ç–Ω—ã–µ –∑–æ–Ω—ã ===
if showZones
    // Bullish zone / –ë—ã—á—å—è –∑–æ–Ω–∞ (–∑–µ–ª–µ–Ω–∞—è)
    bullishZone = rsi < rsiOversold
    bgcolor(bullishZone ? color.new(color.green, 85) : na, title="Bullish Zone")

    // Bearish zone / –ú–µ–¥–≤–µ–∂—å—è –∑–æ–Ω–∞ (—Ä–æ–∑–æ–≤–∞—è/–∫—Ä–∞—Å–Ω–∞—è)
    bearishZone = rsi > rsiOverbought
    bgcolor(bearishZone ? color.new(color.red, 85) : na, title="Bearish Zone")

// === Plot Signals / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ ===
plotshape(bullishSignal, "Bullish Signal", shape.labelup, location.bottom,
     color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.normal)

plotshape(bearishSignal, "Bearish Signal", shape.labeldown, location.top,
     color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.normal)

// === Plot Divergences / –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏–π ===
plotshape(strongBullishDivergence and not bullishSignal, "Bullish Div", shape.circle, location.bottom,
     color=color.new(color.lime, 50), size=size.tiny)

plotshape(strongBearishDivergence and not bearishSignal, "Bearish Div", shape.circle, location.top,
     color=color.new(color.fuchsia, 50), size=size.tiny)

// ============================================================================
// INFO TABLE / –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–ê–Ø –¢–ê–ë–õ–ò–¶–ê
// ============================================================================

if showTable and barstate.islast
    var table infoTable = table.new(position.top_right, 3, 15,
         border_width=2, border_color=color.gray, frame_width=1, frame_color=color.gray)

    // Header / –ó–∞–≥–æ–ª–æ–≤–æ–∫
    table.cell(infoTable, 0, 0, "ALMIR Indicator", text_color=color.white,
         bgcolor=color.new(color.blue, 30), text_size=size.normal)
    table.merge_cells(infoTable, 0, 0, 2, 0)

    // Market State / –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞
    table.cell(infoTable, 0, 1, "Market State", text_color=color.gray, text_size=size.small)
    trendText = isTrendingUp ? "Uptrend" : isTrendingDown ? "Downtrend" : "Sideways"
    trendColor = isTrendingUp ? color.green : isTrendingDown ? color.red : color.gray
    table.cell(infoTable, 1, 1, trendText, text_color=trendColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 1, 2, 1)

    // Volatility / –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å
    table.cell(infoTable, 0, 2, "Volatility", text_color=color.gray, text_size=size.small)
    volText = isHighVolatility ? "High" : isLowVolatility ? "Low" : "Medium"
    volColor = isHighVolatility ? color.orange : color.gray
    table.cell(infoTable, 1, 2, volText, text_color=volColor, text_size=size.small)
    table.merge_cells(infoTable, 1, 2, 2, 2)

    // Separator
    table.cell(infoTable, 0, 3, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
    table.merge_cells(infoTable, 0, 3, 2, 3)

    // Confluence Scores / –ë–∞–ª–ª—ã Confluence
    table.cell(infoTable, 0, 4, "Confluence Score", text_color=color.white,
         bgcolor=color.new(color.blue, 70), text_size=size.small)
    table.merge_cells(infoTable, 0, 4, 2, 4)

    table.cell(infoTable, 0, 5, "Bullish", text_color=color.gray, text_size=size.small)
    bullScoreColor = bullishScore >= minConfluenceScore ? color.green : color.gray
    table.cell(infoTable, 1, 5, str.tostring(bullishScore), text_color=bullScoreColor, text_size=size.small)
    table.cell(infoTable, 2, 5, "/" + str.tostring(minConfluenceScore), text_color=color.gray, text_size=size.small)

    table.cell(infoTable, 0, 6, "Bearish", text_color=color.gray, text_size=size.small)
    bearScoreColor = bearishScore >= minConfluenceScore ? color.red : color.gray
    table.cell(infoTable, 1, 6, str.tostring(bearishScore), text_color=bearScoreColor, text_size=size.small)
    table.cell(infoTable, 2, 6, "/" + str.tostring(minConfluenceScore), text_color=color.gray, text_size=size.small)

    // Show confluence details if enabled
    if showConfluenceDetails
        // Separator
        table.cell(infoTable, 0, 7, "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ", text_color=color.gray, text_size=size.small)
        table.merge_cells(infoTable, 0, 7, 2, 7)

        // Active Signals / –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
        table.cell(infoTable, 0, 8, "Active Signals", text_color=color.white,
             bgcolor=color.new(color.blue, 70), text_size=size.small)
        table.merge_cells(infoTable, 0, 8, 2, 8)

        // Show reasons for bullish signal
        if bullishScore > 0
            reasonsText = array.size(bullishReasons) > 0 ? array.get(bullishReasons, 0) : "None"
            for i = 1 to math.min(2, array.size(bullishReasons) - 1)
                reasonsText += "\n" + array.get(bullishReasons, i)
            table.cell(infoTable, 0, 9, "üü¢ Bullish:", text_color=color.green, text_size=size.small)
            table.cell(infoTable, 1, 9, reasonsText, text_color=color.gray, text_size=size.small)
            table.merge_cells(infoTable, 1, 9, 2, 9)

        // Show reasons for bearish signal
        if bearishScore > 0
            reasonsText = array.size(bearishReasons) > 0 ? array.get(bearishReasons, 0) : "None"
            for i = 1 to math.min(2, array.size(bearishReasons) - 1)
                reasonsText += "\n" + array.get(bearishReasons, i)
            rowIdx = bullishScore > 0 ? 10 : 9
            table.cell(infoTable, 0, rowIdx, "üî¥ Bearish:", text_color=color.red, text_size=size.small)
            table.cell(infoTable, 1, rowIdx, reasonsText, text_color=color.gray, text_size=size.small)
            table.merge_cells(infoTable, 1, rowIdx, 2, rowIdx)

// ============================================================================
// ALERTS / –ê–õ–ï–†–¢–´
// ============================================================================

alertcondition(bullishSignal, title="ALMIR Bullish Signal",
     message="ALMIR: Bullish signal detected! Score: {{plot_0}}")

alertcondition(bearishSignal, title="ALMIR Bearish Signal",
     message="ALMIR: Bearish signal detected! Score: {{plot_0}}")

alertcondition(strongBullishDivergence, title="ALMIR Bullish Divergence",
     message="ALMIR: Bullish divergence detected!")

alertcondition(strongBearishDivergence, title="ALMIR Bearish Divergence",
     message="ALMIR: Bearish divergence detected!")
