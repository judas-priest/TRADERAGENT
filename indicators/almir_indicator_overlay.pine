// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("ALMIR - Fibonacci Overlay", shorttitle="ALMIR Fib", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// ============================================================================
// ÐžÐŸÐ˜Ð¡ÐÐÐ˜Ð• / DESCRIPTION
// ============================================================================
// Overlay ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° ALMIR Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸ Ð½Ð° Ð³Ñ€Ð°Ñ„Ð¸ÐºÐµ Ñ†ÐµÐ½Ñ‹.
// ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ð¾Ñ‚ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ²ÐµÑ‡ÐµÐ¹, Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð¼.
//
// ALMIR overlay component for displaying Fibonacci levels on price chart.
// Automatically draws levels from key candles identified by main indicator.
// ============================================================================

// ============================================================================
// Ð’Ð¥ÐžÐ”ÐÐ«Ð• ÐŸÐÐ ÐÐœÐ•Ð¢Ð Ð« / INPUT PARAMETERS
// ============================================================================

// === RSI Settings (must match main indicator) / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RSI (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð¼) ===
rsiLength = input.int(10, "RSI Length / ÐŸÐµÑ€Ð¸Ð¾Ð´ RSI", minval=1, group="ðŸ“Š RSI Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RSI")
rsiSmoothLength = input.int(3, "RSI Smoothing / Ð¡Ð³Ð»Ð°Ð¶Ð¸Ð²Ð°Ð½Ð¸Ðµ RSI", minval=1, group="ðŸ“Š RSI Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RSI")
rsiOversold = input.int(30, "Oversold Level / Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð¿ÐµÑ€ÐµÐ¿Ñ€Ð¾Ð´Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸", minval=1, maxval=50, group="ðŸ“Š RSI Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RSI")
rsiOverbought = input.int(70, "Overbought Level / Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ Ð¿ÐµÑ€ÐµÐºÑƒÐ¿Ð»ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸", minval=50, maxval=100, group="ðŸ“Š RSI Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ RSI")

// === Volume Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ð±ÑŠÐµÐ¼Ð° ===
volumeMaLength = input.int(20, "Volume MA Length / ÐŸÐµÑ€Ð¸Ð¾Ð´ MA Ð¾Ð±ÑŠÐµÐ¼Ð°", minval=1, group="ðŸ“Š Volume Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ð±ÑŠÐµÐ¼Ð°")
volumeMultiplier = input.float(1.5, "Volume Multiplier / ÐœÐ½Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑŠÐµÐ¼Ð°", minval=1.0, step=0.1, group="ðŸ“Š Volume Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ð±ÑŠÐµÐ¼Ð°")

// === Confluence Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Confluence ===
minConfluenceScore = input.int(5, "Min Confluence Score / ÐœÐ¸Ð½. Ð±Ð°Ð»Ð» confluence", minval=2, maxval=15, group="ðŸŽ¯ Confluence Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Confluence")
minBarsBetweenSignals = input.int(10, "Min Bars Between Signals / ÐœÐ¸Ð½. Ð±Ð°Ñ€Ð¾Ð² Ð¼ÐµÐ¶Ð´Ñƒ ÑÐ¸Ð³Ð½Ð°Ð»Ð°Ð¼Ð¸", minval=1, group="ðŸŽ¯ Confluence Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Confluence")

// Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²
rsiWeight = input.int(2, "RSI Weight / Ð’ÐµÑ RSI", minval=0, maxval=5, group="âš–ï¸ Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²")
macdWeight = input.int(2, "MACD Weight / Ð’ÐµÑ MACD", minval=0, maxval=5, group="âš–ï¸ Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²")
stochWeight = input.int(1, "Stochastic Weight / Ð’ÐµÑ Stochastic", minval=0, maxval=5, group="âš–ï¸ Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²")
volumeWeight = input.int(2, "Volume Weight / Ð’ÐµÑ Ð¾Ð±ÑŠÑ‘Ð¼Ð°", minval=0, maxval=5, group="âš–ï¸ Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²")
priceActionWeight = input.int(1, "Price Action Weight / Ð’ÐµÑ Price Action", minval=0, maxval=5, group="âš–ï¸ Indicator Weights / Ð’ÐµÑÐ° Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð¾Ð²")

// === Fibonacci Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸ ===
showFibLevels = input.bool(true, "Show Fibonacci Levels / ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸", group="ðŸ“ Fibonacci Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
fibExtension = input.int(50, "Fib Extension Bars / ÐŸÑ€Ð¾Ð´Ð»ÐµÐ½Ð¸Ðµ Ð±Ð°Ñ€Ð¾Ð²", minval=10, maxval=200, group="ðŸ“ Fibonacci Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFibLabels = input.bool(true, "Show Fib Labels / ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÑ‚ÐºÐ¸", group="ðŸ“ Fibonacci Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
fibLineWidth = input.int(1, "Fib Line Width / Ð¢Ð¾Ð»Ñ‰Ð¸Ð½Ð° Ð»Ð¸Ð½Ð¸Ð¹", minval=1, maxval=3, group="ðŸ“ Fibonacci Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")

// Fibonacci Trading Levels / Ð¢Ð¾Ñ€Ð³Ð¾Ð²Ñ‹Ðµ ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸
// Based on trading strategy with entries, take-profits, and stop-loss
// ÐžÑÐ½Ð¾Ð²Ð°Ð½Ñ‹ Ð½Ð° Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¸ Ñ Ð²Ñ…Ð¾Ð´Ð°Ð¼Ð¸, Ñ‚ÐµÐ¹Ðº-Ð¿Ñ€Ð¾Ñ„Ð¸Ñ‚Ð°Ð¼Ð¸ Ð¸ ÑÑ‚Ð¾Ð¿-Ð»Ð¾ÑÑÐ¾Ð¼

// Base Level / Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ
showFib1 = input.bool(true, "1.0 - Base / ÐžÑÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")

// Retracement & Entry Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ†Ð¸Ð¸ Ð¸ Ð²Ñ…Ð¾Ð´Ð°
showFib820 = input.bool(true, "0.820 - Stop-Loss / Ð¡Ñ‚Ð¾Ð¿-Ð»Ð¾ÑÑ", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFib618 = input.bool(true, "0.618 - Entry #3 / Ð’Ñ…Ð¾Ð´ #3", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFib5 = input.bool(true, "0.5 - Entry #2 / Ð’Ñ…Ð¾Ð´ #2", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFib0 = input.bool(true, "0.0 - Entry #1 / Ð’Ñ…Ð¾Ð´ #1", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")

// Target Levels (Negative values = above entry for long, below entry for short)
// Ð¦ÐµÐ»ÐµÐ²Ñ‹Ðµ ÑƒÑ€Ð¾Ð²Ð½Ð¸ (ÐžÑ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ = Ð²Ñ‹ÑˆÐµ Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ð»Ð¾Ð½Ð³Ð°, Ð½Ð¸Ð¶Ðµ Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ ÑˆÐ¾Ñ€Ñ‚Ð°)
showFibN0618 = input.bool(true, "-0.618 - TP1 (30%) / Ð¢ÐµÐ¹Ðº-Ð¿Ñ€Ð¾Ñ„Ð¸Ñ‚ 1", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFibN1618 = input.bool(true, "-1.618 - TP2 (30%) / Ð¢ÐµÐ¹Ðº-Ð¿Ñ€Ð¾Ñ„Ð¸Ñ‚ 2", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")
showFibN2618 = input.bool(true, "-2.618 - TP3 (40%) / Ð¢ÐµÐ¹Ðº-Ð¿Ñ€Ð¾Ñ„Ð¸Ñ‚ 3", group="ðŸ“ Fibonacci Levels / Ð£Ñ€Ð¾Ð²Ð½Ð¸ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸")

// === Display Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ===
showBullishSignals = input.bool(true, "Show Bullish Signals / ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð±Ñ‹Ñ‡ÑŒÐ¸ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹", group="ðŸŽ¨ Display Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ")
showBearishSignals = input.bool(true, "Show Bearish Signals / ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÐ´Ð²ÐµÐ¶ÑŒÐ¸ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹", group="ðŸŽ¨ Display Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ")
showSignalLabels = input.bool(true, "Show Signal Labels / ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¼ÐµÑ‚ÐºÐ¸ ÑÐ¸Ð³Ð½Ð°Ð»Ð¾Ð²", group="ðŸŽ¨ Display Settings / ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ")

// ============================================================================
// SIGNAL DETECTION (simplified version from main indicator)
// ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ˜Ð• Ð¡Ð˜Ð“ÐÐÐ›ÐžÐ’ (ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ð¸Ð· Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð°)
// ============================================================================

// RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume
volumeMa = ta.sma(volume, volumeMaLength)
volumeRatio = volume / volumeMa
strongVolume = volumeRatio > volumeMultiplier

// MACD
[macdLine, signalLine, _] = ta.macd(close, 10, 30, 20)
macdBullish = ta.crossover(macdLine, signalLine) and macdLine < 0
macdBearish = ta.crossunder(macdLine, signalLine) and macdLine > 0

// Stochastic
stochK = ta.stoch(close, high, low, 14)
stochD = ta.sma(stochK, 3)
stochBullish = ta.crossover(stochK, stochD) and stochK < 20
stochBearish = ta.crossunder(stochK, stochD) and stochK > 80

// Price Action
candleRange = high - low
candleBody = math.abs(close - open)
isBullishCandle = (close > open) and (candleBody > candleRange * 0.6) and candleRange > 0
isBearishCandle = (open > close) and (candleBody > candleRange * 0.6) and candleRange > 0

// Confluence Score
var int bullishScore = 0
var int bearishScore = 0

bullishScore := 0
bearishScore := 0

// RSI Signal
rsiBullishSignal = ta.crossover(rsi, rsiOversold) and rsiSmooth > rsiSmooth[1]
rsiBearishSignal = ta.crossunder(rsi, rsiOverbought) and rsiSmooth < rsiSmooth[1]

if rsiBullishSignal
    bullishScore += rsiWeight
if rsiBearishSignal
    bearishScore += rsiWeight

// MACD Signal
if macdBullish
    bullishScore += macdWeight
if macdBearish
    bearishScore += macdWeight

// Stochastic Signal
if stochBullish
    bullishScore += stochWeight
if stochBearish
    bearishScore += stochWeight

// Volume Signal
isBuyingPressure = close > open and strongVolume
isSellingPressure = close < open and strongVolume

if strongVolume and isBuyingPressure
    bullishScore += volumeWeight
if strongVolume and isSellingPressure
    bearishScore += volumeWeight

// Price Action Signal
if isBullishCandle
    bullishScore += priceActionWeight
if isBearishCandle
    bearishScore += priceActionWeight

// Track last signal bar
var int lastBullishBar = 0
var int lastBearishBar = 0

barsSinceLastBullish = bar_index - lastBullishBar
barsSinceLastBearish = bar_index - lastBearishBar

// Generate signals
bullishSignal = bullishScore >= minConfluenceScore and barsSinceLastBullish >= minBarsBetweenSignals and showBullishSignals
bearishSignal = bearishScore >= minConfluenceScore and barsSinceLastBearish >= minBarsBetweenSignals and showBearishSignals

// ============================================================================
// FIBONACCI LEVEL CALCULATION / Ð ÐÐ¡Ð§ÐÐ¢ Ð£Ð ÐžÐ’ÐÐ•Ð™ Ð¤Ð˜Ð‘ÐžÐÐÐ§Ð§Ð˜
// ============================================================================

// Store signal candle data / Ð¥Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ²ÐµÑ‡Ð¸ ÑÐ¸Ð³Ð½Ð°Ð»Ð°
var float bullishStartPrice = na
var float bullishEndPrice = na
var int bullishStartBar = na

var float bearishStartPrice = na
var float bearishEndPrice = na
var int bearishStartBar = na

// Update on new bullish signal / ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ð¾Ð¼ Ð±Ñ‹Ñ‡ÑŒÐµÐ¼ ÑÐ¸Ð³Ð½Ð°Ð»Ðµ
// For bullish: 1.0 = High (base), 0.0 = Low (entry)
if bullishSignal
    lastBullishBar := bar_index
    bullishStartBar := bar_index
    bullishStartPrice := high  // 1.0 level = High of green candle (base)
    bullishEndPrice := low     // 0.0 level = Low of green candle (entry #1)

// Update on new bearish signal / ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð½Ð¾Ð²Ð¾Ð¼ Ð¼ÐµÐ´Ð²ÐµÐ¶ÑŒÐµÐ¼ ÑÐ¸Ð³Ð½Ð°Ð»Ðµ
// For bearish: 1.0 = Low (base), 0.0 = High (entry)
if bearishSignal
    lastBearishBar := bar_index
    bearishStartBar := bar_index
    bearishStartPrice := low   // 1.0 level = Low of red candle (base)
    bearishEndPrice := high    // 0.0 level = High of red candle (entry #1)

// ============================================================================
// DRAW FIBONACCI LEVELS / ÐžÐ¢Ð Ð˜Ð¡ÐžÐ’ÐšÐ Ð£Ð ÐžÐ’ÐÐ•Ð™ Ð¤Ð˜Ð‘ÐžÐÐÐ§Ð§Ð˜
// ============================================================================

// Function to draw Fibonacci level / Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ¸ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸
drawFibLevel(startPrice, endPrice, level, levelName, levelColor, startBar) =>
    if showFibLevels and not na(startPrice) and not na(endPrice)
        price = startPrice + (endPrice - startPrice) * level
        currentBar = bar_index
        barsFromSignal = currentBar - startBar

        // Only draw if within extension range
        if barsFromSignal <= fibExtension
            line fibLine = line.new(startBar, price, currentBar, price,
                 color=levelColor, width=fibLineWidth, style=line.style_solid)

            if showFibLabels and barsFromSignal == 0
                label.new(startBar, price, str.tostring(price, format.mintick) + " (" + levelName + ")",
                     color=color.new(color.white, 100), textcolor=levelColor,
                     style=label.style_label_down, size=size.small, yloc=yloc.price)

// Draw Bullish Fibonacci Levels / ÐžÑ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ° Ð±Ñ‹Ñ‡ÑŒÐ¸Ñ… ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸
// For LONG: 1.0 = High (base), 0.0 = Low (entry), negative = targets below
// More vibrant colors for better visibility
if not na(bullishStartPrice) and not na(bullishEndPrice) and not na(bullishStartBar)
    barsFromSignal = bar_index - bullishStartBar
    if barsFromSignal <= fibExtension
        // Base level
        if showFib1
            drawFibLevel(bullishStartPrice, bullishEndPrice, 1.0, "1.0 Base", color.new(#808080, 0), bullishStartBar)

        // Stop-Loss level
        if showFib820
            drawFibLevel(bullishStartPrice, bullishEndPrice, 0.820, "0.820 SL", color.new(#FF0000, 0), bullishStartBar)

        // Entry levels (retracement from high to low)
        if showFib618
            drawFibLevel(bullishStartPrice, bullishEndPrice, 0.618, "0.618 Entry #3", color.new(#0080FF, 0), bullishStartBar)
        if showFib5
            drawFibLevel(bullishStartPrice, bullishEndPrice, 0.5, "0.5 Entry #2", color.new(#00BFFF, 0), bullishStartBar)
        if showFib0
            drawFibLevel(bullishStartPrice, bullishEndPrice, 0.0, "0.0 Entry #1", color.new(#00FF00, 0), bullishStartBar)

        // Target levels (negative = above 0.0 level for long)
        if showFibN0618
            drawFibLevel(bullishStartPrice, bullishEndPrice, -0.618, "-0.618 TP1 (30%)", color.new(#00FF00, 0), bullishStartBar)
        if showFibN1618
            drawFibLevel(bullishStartPrice, bullishEndPrice, -1.618, "-1.618 TP2 (30%)", color.new(#FFFF00, 0), bullishStartBar)
        if showFibN2618
            drawFibLevel(bullishStartPrice, bullishEndPrice, -2.618, "-2.618 TP3 (40%)", color.new(#FFA500, 0), bullishStartBar)

// Draw Bearish Fibonacci Levels / ÐžÑ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÐ° Ð¼ÐµÐ´Ð²ÐµÐ¶ÑŒÐ¸Ñ… ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹ Ð¤Ð¸Ð±Ð¾Ð½Ð°Ñ‡Ñ‡Ð¸
// For SHORT: 1.0 = Low (base), 0.0 = High (entry), negative = targets above
// More vibrant colors for better visibility
if not na(bearishStartPrice) and not na(bearishEndPrice) and not na(bearishStartBar)
    barsFromSignal = bar_index - bearishStartBar
    if barsFromSignal <= fibExtension
        // Base level
        if showFib1
            drawFibLevel(bearishStartPrice, bearishEndPrice, 1.0, "1.0 Base", color.new(#808080, 0), bearishStartBar)

        // Stop-Loss level
        if showFib820
            drawFibLevel(bearishStartPrice, bearishEndPrice, 0.820, "0.820 SL", color.new(#FF0000, 0), bearishStartBar)

        // Entry levels (retracement from low to high)
        if showFib618
            drawFibLevel(bearishStartPrice, bearishEndPrice, 0.618, "0.618 Entry #3", color.new(#0080FF, 0), bearishStartBar)
        if showFib5
            drawFibLevel(bearishStartPrice, bearishEndPrice, 0.5, "0.5 Entry #2", color.new(#00BFFF, 0), bearishStartBar)
        if showFib0
            drawFibLevel(bearishStartPrice, bearishEndPrice, 0.0, "0.0 Entry #1", color.new(#FF0000, 0), bearishStartBar)

        // Target levels (negative = below 0.0 level for short)
        if showFibN0618
            drawFibLevel(bearishStartPrice, bearishEndPrice, -0.618, "-0.618 TP1 (30%)", color.new(#FF00FF, 0), bearishStartBar)
        if showFibN1618
            drawFibLevel(bearishStartPrice, bearishEndPrice, -1.618, "-1.618 TP2 (30%)", color.new(#FFFF00, 0), bearishStartBar)
        if showFibN2618
            drawFibLevel(bearishStartPrice, bearishEndPrice, -2.618, "-2.618 TP3 (40%)", color.new(#FFA500, 0), bearishStartBar)

// ============================================================================
// MARK KEY CANDLES ON CHART / ÐžÐ¢ÐœÐ•Ð¢ÐšÐ˜ ÐšÐ›Ð®Ð§Ð•Ð’Ð«Ð¥ Ð¡Ð’Ð•Ð§Ð•Ð™ ÐÐ Ð“Ð ÐÐ¤Ð˜ÐšÐ•
// ============================================================================

// Mark bullish signal candles with TRIANGLES (like in RSIV_Step_[Almir])
// Ð¢Ñ€ÐµÑƒÐ³Ð¾Ð»ÑŒÐ½Ð¸ÐºÐ¸ Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¹ ÐºÐ°Ðº Ð² Ñ€ÐµÑ„ÐµÑ€ÐµÐ½ÑÐ½Ð¾Ð¼ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ðµ
plotshape(showSignalLabels and bullishSignal, title="Entry UP", style=shape.triangleup, location=location.belowbar,
     color=color.new(#00FF00, 0), size=size.large, text="")

// Mark bearish signal candles with TRIANGLES (like in RSIV_Step_[Almir])
plotshape(showSignalLabels and bearishSignal, title="Entry DOWN", style=shape.triangledown, location=location.abovebar,
     color=color.new(#FF0000, 0), size=size.large, text="")

// Optional: Add small labels with confluence score
if showSignalLabels and bullishSignal
    label.new(bar_index, low * 0.999, str.tostring(bullishScore),
         color=color.new(#00FF00, 20), textcolor=color.white,
         style=label.style_label_up, size=size.tiny,
         tooltip="Bullish Signal\nConfluence Score: " + str.tostring(bullishScore))

if showSignalLabels and bearishSignal
    label.new(bar_index, high * 1.001, str.tostring(bearishScore),
         color=color.new(#FF0000, 20), textcolor=color.white,
         style=label.style_label_down, size=size.tiny,
         tooltip="Bearish Signal\nConfluence Score: " + str.tostring(bearishScore))

// ============================================================================
// BACKGROUND HIGHLIGHTS / ÐŸÐžÐ”Ð¡Ð’Ð•Ð¢ÐšÐ Ð¤ÐžÐÐ
// ============================================================================

// Highlight signal candles with more visible background
bgcolor(bullishSignal ? color.new(#00FF00, 85) : na, title="Bullish Signal BG")
bgcolor(bearishSignal ? color.new(#FF0000, 85) : na, title="Bearish Signal BG")
