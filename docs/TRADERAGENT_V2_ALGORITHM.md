# TRADERAGENT v2.0 ‚Äî Unified Trading Algorithm

## 1. –§–∏–ª–æ—Å–æ—Ñ–∏—è

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–∞–∫ **–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –±–æ—Ç—ã** ‚Äî –∫–∞–∂–¥—ã–π —Å–æ —Å–≤–æ–∏–º –∫–∞–ø–∏—Ç–∞–ª–æ–º, —Ä–∏—Å–∫–∞–º–∏ –∏ –ª–æ–≥–∏–∫–æ–π. –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –¥–µ–º–æ, –Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–±–ª–µ–º—ã:

- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –Ω–∞ –æ–¥–Ω–æ–π –ø–∞—Ä–µ (Grid –ø—Ä–æ–¥–∞—ë—Ç ‚Üî Trend Follower –ø–æ–∫—É–ø–∞–µ—Ç)
- –ö–∞–ø–∏—Ç–∞–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ (60/30/10 –≤ HYBRID) –±–µ–∑ —É—á—ë—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
- –†–∏—Å–∫ —Å—á–∏—Ç–∞–µ—Ç—Å—è per-bot, –∞ –Ω–µ –ø–æ –≤—Å–µ–º—É –ø–æ—Ä—Ç—Ñ–µ–ª—é
- SMC –¥—É–±–ª–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã —É—Å–∏–ª–∏–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–¶–µ–ª—å v2.0:** –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å "–Ω–∞–±–æ—Ä –±–æ—Ç–æ–≤" –≤ **–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–æ—Ä–≥–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å** —Å –µ–¥–∏–Ω—ã–º –º–æ–∑–≥–æ–º.

---

## 2. –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª (Master Loop)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    MASTER LOOP (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫)                  ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  Market   ‚îÇ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ   Strategy   ‚îÇ‚îÄ‚îÄ‚îÄ‚Üí‚îÇ  Capital          ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  Scanner  ‚îÇ    ‚îÇ   Router     ‚îÇ    ‚îÇ  Allocator        ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ       ‚îÇ                ‚îÇ                      ‚îÇ                  ‚îÇ
‚îÇ       ‚ñº                ‚ñº                      ‚ñº                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îÇ
‚îÇ  ‚îÇ  Regime   ‚îÇ    ‚îÇ   SMC        ‚îÇ    ‚îÇ  Risk             ‚îÇ      ‚îÇ
‚îÇ  ‚îÇ  Detector ‚îÇ    ‚îÇ   Filter     ‚îÇ    ‚îÇ  Aggregator       ‚îÇ      ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îÇ
‚îÇ                        ‚îÇ                      ‚îÇ                  ‚îÇ
‚îÇ                        ‚ñº                      ‚ñº                  ‚îÇ
‚îÇ                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ
‚îÇ                 ‚îÇ     STRATEGY EXECUTION LAYER      ‚îÇ             ‚îÇ
‚îÇ                 ‚îÇ  Grid | DCA | Trend Follower       ‚îÇ             ‚îÇ
‚îÇ                 ‚îÇ     (–∫–∞–∂–¥—ã–µ 1-5 —Å–µ–∫ –≤–Ω—É—Ç—Ä–∏)       ‚îÇ             ‚îÇ
‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Ç–µ–∫—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã: **–¥–≤–∞ —É—Ä–æ–≤–Ω—è —Ü–∏–∫–ª–∞**.

- **Master Loop (60 —Å–µ–∫):** –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞, –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
- **Strategy Loop (1-5 —Å–µ–∫):** –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–∞—Ä–µ (–∫–∞–∫ —Å–µ–π—á–∞—Å)

### 2.1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** Master Loop –∏ Strategy Loop —Ä–∞–±–æ—Ç–∞—é—Ç —Å —Ä–∞–∑–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π. –ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ Master Loop –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ, –ø–æ–∫–∞ Strategy Loop —É–∂–µ —Ä–∞–∑–º–µ—Å—Ç–∏–ª –æ—Ä–¥–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:** Transition Lock ‚Äî –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:

```python
class MasterLoop:
    async def switch_strategy(self, pair: str, old: Strategy, new: Strategy):
        # 1. LOCK: Strategy Loop —Å—Ç–∞–≤–∏—Ç—Å—è –Ω–∞ –ø–∞—É–∑—É –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã
        self.strategy_locks[pair].acquire()

        # 2. CANCEL: –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ pending –æ—Ä–¥–µ—Ä–∞ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ –±–∏—Ä–∂–µ
        cancelled = await self.exchange.cancel_all_orders(pair)

        # 3. WAIT: –ü–æ–¥–æ–∂–¥–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–º–µ–Ω—ã (–¥–æ 10 —Å–µ–∫—É–Ω–¥)
        await self._confirm_cancellations(cancelled, timeout=10)

        # 4. RECONCILE: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∏—Å–ø–æ–ª–Ω–∏–ª–∏—Å—å –ª–∏ –æ—Ä–¥–µ—Ä–∞ –∑–∞ –≤—Ä–µ–º—è –æ—Ç–º–µ–Ω—ã
        fills = await self.exchange.get_recent_fills(pair, since=lock_time)
        if fills:
            # –ê—Ç—Ä–∏–±—É—Ç–∏—Ä–æ–≤–∞—Ç—å fills —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –∑–∞–∫—Ä—ã—Ç—å –ø–æ market
            await self._close_orphaned_fills(fills, pair)

        # 5. START: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        self.active_strategies[pair] = new
        await new.initialize(pair, self.allocations[pair])

        # 6. UNLOCK: Strategy Loop –≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
        self.strategy_locks[pair].release()
```

---

## 3. Market Scanner ‚Äî –°–∫–∞–Ω–µ—Ä —Ä—ã–Ω–∫–∞

### 3.1. –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º

–î–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—Ä–≥—É–µ–º–æ–π –ø–∞—Ä—ã —Å–æ–±–∏—Ä–∞–µ–º:

```python
class MarketSnapshot:
    symbol: str               # "BTC/USDT"
    price: Decimal            # —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞
    adx_14: float             # ADX(14) ‚Äî —Å–∏–ª–∞ —Ç—Ä–µ–Ω–¥–∞
    adx_direction: str        # "bullish" | "bearish" | "neutral"
    atr_percent: float        # ATR(14) / price * 100 ‚Äî –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤ %
    ema_20: float             # EMA(20)
    ema_50: float             # EMA(50)
    rsi_14: float             # RSI(14)
    volume_ratio: float       # volume_24h / avg_volume_30d
    bb_width: float           # (upper - lower) / middle ‚Äî —à–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞
    range_score: float        # 0-1, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ü–µ–Ω–∞ –≤ –±–æ–∫–æ–≤–∏–∫–µ (–∏–∑ MarketRegimeDetector)
```

### 3.2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞

–ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –≤—Å—Ç—Ä–æ–µ–Ω **–≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä** (–∞ –Ω–µ –≤ Router), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

```python
class RegimeClassifier:
    """–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –æ —Ä–µ–∂–∏–º–µ —Ä—ã–Ω–∫–∞.
    –ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Å—Ü–∏–ª–ª—è—Ü–∏—é –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö."""

    # –ü–æ—Ä–æ–≥–∏ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
    ADX_ENTER_TRENDING = 32    # –≤–æ–π—Ç–∏ –≤ "—Ç—Ä–µ–Ω–¥" —Å—Ç—Ä–æ–∂–µ
    ADX_EXIT_TRENDING = 25     # –≤—ã–π—Ç–∏ –∏–∑ "—Ç—Ä–µ–Ω–¥–∞" –ª–µ–≥—á–µ
    ADX_ENTER_RANGING = 18     # –≤–æ–π—Ç–∏ –≤ "–±–æ–∫–æ–≤–∏–∫" —Å—Ç—Ä–æ–∂–µ
    ADX_EXIT_RANGING = 22      # –≤—ã–π—Ç–∏ –∏–∑ "–±–æ–∫–æ–≤–∏–∫–∞" –ª–µ–≥—á–µ

    ATR_WIDE_THRESHOLD = 1.0   # %
    ATR_VOLATILE_THRESHOLD = 2.0  # %

    def classify(self, snapshot: MarketSnapshot,
                 current_regime: MarketRegime) -> MarketRegime:
        adx = snapshot.adx_14
        atr = snapshot.atr_percent

        # –ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å: –ø–æ—Ä–æ–≥–∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
        if current_regime in (MarketRegime.BULL_TREND, MarketRegime.BEAR_TREND):
            # –°–µ–π—á–∞—Å –≤ —Ç—Ä–µ–Ω–¥–µ ‚Üí –Ω—É–∂–µ–Ω ADX < 25 —á—Ç–æ–±—ã –í–´–ô–¢–ò
            if adx >= self.ADX_EXIT_TRENDING:
                return self._classify_trend(snapshot)
            else:
                # –¢—Ä–µ–Ω–¥ –æ—Å–ª–∞–± ‚Üí –ø–µ—Ä–µ—Ö–æ–¥
                return self._classify_transition(snapshot)

        elif current_regime in (MarketRegime.TIGHT_RANGE, MarketRegime.WIDE_RANGE):
            # –°–µ–π—á–∞—Å –≤ –±–æ–∫–æ–≤–∏–∫–µ ‚Üí –Ω—É–∂–µ–Ω ADX > 32 —á—Ç–æ–±—ã –í–û–ô–¢–ò –≤ —Ç—Ä–µ–Ω–¥
            if adx > self.ADX_ENTER_TRENDING:
                return self._classify_trend(snapshot)
            elif adx > self.ADX_EXIT_RANGING:
                return self._classify_transition(snapshot)
            else:
                return self._classify_range(snapshot)

        else:
            # –ü–µ—Ä–µ—Ö–æ–¥–Ω–∞—è –∑–æ–Ω–∞ ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä–æ–≥–∏
            if adx > self.ADX_ENTER_TRENDING:
                return self._classify_trend(snapshot)
            elif adx < self.ADX_ENTER_RANGING:
                return self._classify_range(snapshot)
            else:
                return self._classify_transition(snapshot)

    def _classify_trend(self, s: MarketSnapshot) -> MarketRegime:
        if s.ema_20 > s.ema_50:
            return MarketRegime.BULL_TREND
        return MarketRegime.BEAR_TREND

    def _classify_range(self, s: MarketSnapshot) -> MarketRegime:
        if s.atr_percent < self.ATR_WIDE_THRESHOLD:
            return MarketRegime.TIGHT_RANGE
        return MarketRegime.WIDE_RANGE

    def _classify_transition(self, s: MarketSnapshot) -> MarketRegime:
        if s.atr_percent < self.ATR_VOLATILE_THRESHOLD:
            return MarketRegime.QUIET_TRANSITION
        return MarketRegime.VOLATILE_TRANSITION
```

**6 —Ä–µ–∂–∏–º–æ–≤ —Ä—ã–Ω–∫–∞:**

| –†–µ–∂–∏–º | –£—Å–ª–æ–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|---------|----------|
| `TIGHT_RANGE` | ADX < 18 (–≤—Ö–æ–¥) / < 22 (–≤—ã—Ö–æ–¥), ATR < 1% | –£–∑–∫–∏–π –±–æ–∫–æ–≤–∏–∫, –∏–¥–µ–∞–ª—å–Ω—ã–π –¥–ª—è Grid |
| `WIDE_RANGE` | ADX < 18 (–≤—Ö–æ–¥) / < 22 (–≤—ã—Ö–æ–¥), ATR >= 1% | –®–∏—Ä–æ–∫–∏–π –±–æ–∫–æ–≤–∏–∫, Grid —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º |
| `QUIET_TRANSITION` | ADX 22-32 (–ø–µ—Ä–µ—Ö–æ–¥), ATR < 2% | –°–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è, –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å |
| `VOLATILE_TRANSITION` | ADX 22-32 (–ø–µ—Ä–µ—Ö–æ–¥), ATR >= 2% | –í—ã—Å–æ–∫–∞—è –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å, SMC-—Ñ–∏–ª—å—Ç—Ä –∫—Ä–∏—Ç–∏—á–µ–Ω |
| `BULL_TREND` | ADX > 32 (–≤—Ö–æ–¥) / > 25 (–≤—ã—Ö–æ–¥), EMA20 > EMA50 | –í–æ—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥, Trend Follower |
| `BEAR_TREND` | ADX > 32 (–≤—Ö–æ–¥) / > 25 (–≤—ã—Ö–æ–¥), EMA20 < EMA50 | –ù–∏—Å—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–Ω–¥, DCA accumulation |

---

## 4. Strategy Router ‚Äî –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

### 4.1. –ú–∞—Ç—Ä–∏—Ü–∞ ¬´–†–µ–∂–∏–º ‚Üí –°—Ç—Ä–∞—Ç–µ–≥–∏—è¬ª

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** HYBRID —É–¥–∞–ª—ë–Ω –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è. –ï–≥–æ —Ñ—É–Ω–∫—Ü–∏—è (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ Grid/DCA
> –ø–æ ADX) —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∞–º–∏–º Strategy Router, —á—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥–≤–æ–π–Ω–æ–π —Ä–æ—É—Ç–∏–Ω–≥.
> –ö–∞–ø–∏—Ç–∞–ª—å–Ω–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è HYBRID (60/30/10) –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ Capital Allocator.

| –†–µ–∂–∏–º | –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è | –†–µ–∑–µ—Ä–≤–Ω–∞—è | –ó–∞–ø—Ä–µ—â–µ–Ω—ã |
|-------|-------------------|-----------|-----------|
| `TIGHT_RANGE` | Grid (arithmetic) | ‚Äî | Trend Follower |
| `WIDE_RANGE` | Grid (geometric) | ‚Äî | ‚Äî |
| `QUIET_TRANSITION` | Grid (–æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π, —Å—É–∂–µ–Ω–Ω—ã–π range √ó 0.7) | DCA (–æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π) | Grid + DCA –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (—Å–º. 7.2) |
| `VOLATILE_TRANSITION` | DCA (–æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π) | ‚Äî | Grid –±–µ–∑ SMC —Ñ–∏–ª—å—Ç—Ä–∞ |
| `BULL_TREND` | Trend Follower (long) | ‚Äî | Grid, DCA (long) |
| `BEAR_TREND` | DCA (accumulation) | Trend Follower (short) | Grid |

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-C1:** –†–∞–Ω–µ–µ QUIET_TRANSITION –Ω–∞–∑–Ω–∞—á–∞–ª Grid (60%) + DCA (40%)
> –Ω–∞ –æ–¥–Ω—É –ø–∞—Ä—É –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–ª–æ –ø—Ä–∞–≤–∏–ª—É 7.2 (Grid + DCA –Ω–∞ –æ–¥–Ω–æ–π –ø–∞—Ä–µ = –ó–ê–ü–†–ï–©–ï–ù–û).
> –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –û–î–ù–ê —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: Grid —Å —Å—É–∂–µ–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º (√ó0.7 –æ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ),
> –ª–∏–±–æ DCA –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Router –±–µ–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

### 4.2. –ü—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

```python
class StrategyRouter:
    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ñ–ª–∏–ø-—Ñ–ª–æ–ø)
    MIN_REGIME_DURATION = timedelta(hours=4)

    # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–´–• –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –¥–ª—è —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞
    CONFIRMATION_COUNT = 3

    def evaluate_transition(self, new_regime: MarketRegime,
                            current_regime: MarketRegime) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é."""

        if new_regime == current_regime:
            # –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ —Ç–µ–∫—É—â–µ–º—É ‚Äî –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –æ–∂–∏–¥–∞–Ω–∏—è
            self._pending_regime = None
            self._confirmation_counter = 0
            return False

        if new_regime == self._pending_regime:
            # –¢–æ—Ç –∂–µ –∫–∞–Ω–¥–∏–¥–∞—Ç —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ ‚Äî –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
            self._confirmation_counter += 1
        else:
            # –ù–æ–≤—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç ‚Äî —Å–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
            self._pending_regime = new_regime
            self._confirmation_counter = 1

        if self._confirmation_counter < self.CONFIRMATION_COUNT:
            return False  # –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π

        elapsed = datetime.utcnow() - self._last_switch_time
        if elapsed < self.MIN_REGIME_DURATION:
            return False  # —Å–ª–∏—à–∫–æ–º —Ä–∞–Ω–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

        # –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
        self._last_switch_time = datetime.utcnow()
        self._pending_regime = None
        self._confirmation_counter = 0
        return True
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –æ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞:**

1. `_pending_regime` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞. –ï—Å–ª–∏ —Ä–µ–∂–∏–º ¬´–º–µ—Ä—Ü–∞–µ—Ç¬ª (RANGE ‚Üí TRANSITION ‚Üí RANGE ‚Üí TRANSITION), counter —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Ç–µ–∫—É—â–µ–º—É.
2. –ï—Å–ª–∏ –∫–∞–Ω–¥–∏–¥–∞—Ç —Å–º–µ–Ω–∏–ª—Å—è (–±—ã–ª TRANSITION, —Å—Ç–∞–ª TREND), counter –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1.
3. –≠—Ç–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –ª–æ–∂–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç –æ—Å—Ü–∏–ª–ª—è—Ü–∏–∏ ADX.

### 4.3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (Cold Start)

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-M1:** –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã (–∏–ª–∏ –ø–æ—Å–ª–µ crash recovery)
> `current_regime = None`, –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `CONFIRMATION_COUNT = 3` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ 3-–º–∏–Ω—É—Ç–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–µ
> –±–µ–∑ —Ç–æ—Ä–≥–æ–≤–ª–∏. –≠—Ç–æ –Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ.

```python
class StrategyRouter:
    def evaluate_transition(self, new_regime, current_regime) -> bool:
        # COLD START: –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
        if current_regime is None:
            self._last_switch_time = datetime.utcnow()
            return True

        # –î–∞–ª–µ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å confirmation_counter...
```

**–ü—Ä–∞–≤–∏–ª–æ:** –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∏–ª–∏ crash recovery –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ** –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π. –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π `CONFIRMATION_COUNT`.

---

## 5. SMC Enhancement Layer ‚Äî –§–∏–ª—å—Ç—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –≤—Ö–æ–¥–æ–≤

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** SMC –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, –∞ **–ø–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –≤—Ö–æ–¥–æ–≤** –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.

### 5.1. –¢–∏–ø—ã —Å–∏–≥–Ω–∞–ª–æ–≤ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ñ–∏–ª—å—Ç—Ä

> **–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û:** SMC Filter –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫ –≤—Ö–æ–¥–Ω—ã–º —Å–∏–≥–Ω–∞–ª–∞–º.
> Exit-—Å–∏–≥–Ω–∞–ª—ã (Stop-Loss, Take-Profit, Transition close) –æ–±—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä –í–°–ï–ì–î–ê.

```python
class Signal:
    """–¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏."""
    symbol: str
    side: Literal["buy", "sell"]
    qty: Decimal
    price: Decimal | None           # None = market order
    type: SignalType

class SignalType(Enum):
    ENTRY = "entry"                 # –í—Ö–æ–¥ –≤ –ø–æ–∑–∏—Ü–∏—é ‚Üí –ø—Ä–æ—Ö–æ–¥–∏—Ç SMC Filter
    EXIT_TP = "exit_tp"             # Take-Profit ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC
    EXIT_SL = "exit_sl"             # Stop-Loss ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC
    EXIT_TRANSITION = "exit_transition"  # –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC
    EXIT_EMERGENCY = "exit_emergency"    # Emergency Halt ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC
    GRID_COUNTER = "grid_counter"   # Grid counter-order ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC (—á–∞—Å—Ç—å —Ü–∏–∫–ª–∞)
```

```python
def process_signal(signal: Signal, smc_filter: SMCFilter, candle) -> Signal | None:
    # –¢–û–õ–¨–ö–û entry-—Å–∏–≥–Ω–∞–ª—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ SMC
    if signal.type == SignalType.ENTRY:
        return smc_filter.filter(signal, candle)

    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã ‚Äî –ø—Ä—è–º–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    return signal
```

### 5.2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä

```
                    –°–∏–≥–Ω–∞–ª –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
                           ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ signal.type? ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ            ‚îÇ            ‚îÇ
           ENTRY      GRID_COUNTER  EXIT_*
              ‚îÇ            ‚îÇ            ‚îÇ
              ‚ñº            ‚ñº            ‚ñº
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å   –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        ‚îÇSMC Filter‚îÇ   –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞  –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ        ‚îÇ        ‚îÇ
ENHANCED  NEUTRAL   REJECT
(0.7-1.0) (0.4-0.7) (< 0.4)
    ‚îÇ        ‚îÇ        ‚îÇ
  –ü–æ–ª–Ω—ã–π  –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π  –û—Ç–∫–ª–æ–Ω—ë–Ω
  —Ä–∞–∑–º–µ—Ä  —Ä–∞–∑–º–µ—Ä (50%)
```

### 5.3. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ SMC –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**Grid + SMC ‚Äî –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –í–°–ï–ô –°–ï–¢–ö–ò, –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤:**

> **–ü—Ä–æ–±–ª–µ–º–∞:** –µ—Å–ª–∏ SMC —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ Grid-—É—Ä–æ–≤–Ω–∏, –ø–æ–ª—É—á–∞–µ—Ç—Å—è ¬´—Å–µ—Ç–∫–∞ —Å –¥—ã—Ä–∫–∞–º–∏¬ª ‚Äî
> counter-orders –ª–æ–º–∞—é—Ç—Å—è, —Ü–∏–∫–ª Grid-—Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è.

```python
class SMCGridFilter:
    """SMC –¥–ª—è Grid —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤—Å–µ–π —Å–µ—Ç–∫–∏, –∞ –Ω–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤."""

    def filter_grid(self, grid_center: float, grid_range: tuple[float, float],
                    candle: pd.Series) -> SMCVerdict:
        zones = self._find_zones_in_range(grid_range)

        # –û—Ü–µ–Ω–∫–∞: —Ü–µ–Ω—Ç—Ä —Å–µ—Ç–∫–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∑–æ–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è?
        center_score = self._score_center(grid_center, zones)

        # –ï—Å—Ç—å –ª–∏ –∑–æ–Ω–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∞—è > 30% —Å–µ—Ç–∫–∏?
        liquidity_risk = self._check_liquidity_sweep(grid_range, zones)

        if liquidity_risk > 0.3:
            return SMCVerdict.REJECT  # –≤—Å—è —Å–µ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞

        if center_score >= 0.7:
            return SMCVerdict.ENHANCED  # –≤—Å—è —Å–µ—Ç–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞ —Å –ø–æ–ª–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º

        # NEUTRAL: —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä. –ù–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:
        # –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –æ—Ä–¥–µ—Ä–∞ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å < min_order_size –±–∏—Ä–∂–∏, REJECT –≤–º–µ—Å—Ç–æ NEUTRAL.
        # (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-M3: ¬´–ø–æ–ª–æ–≤–∏–Ω–Ω–∞—è —Å–µ—Ç–∫–∞¬ª –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∏–∂–µ
        # –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –æ—Ä–¥–µ—Ä–∞, —á—Ç–æ —Å–¥–µ–ª–∞–µ—Ç Grid –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω—ã–º.)
        return SMCVerdict.NEUTRAL  # –≤—Å—è —Å–µ—Ç–∫–∞ —Å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º

    def _check_grid_viability(self, grid_qty: Decimal, num_levels: int,
                               neutral_multiplier: float,
                               min_order_size: Decimal) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Grid –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω—ã–º –ø–æ—Å–ª–µ SMC NEUTRAL."""
        per_level = grid_qty * Decimal(str(neutral_multiplier)) / num_levels
        return per_level >= min_order_size
```

> **–ü—Ä–∞–≤–∏–ª–æ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ Grid (NEW-M3):** –ï—Å–ª–∏ SMC –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç NEUTRAL –∏
> `adjusted_qty / num_levels < exchange.min_order_size`, –≤–µ—Ä–¥–∏–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
> –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –¥–æ REJECT. –õ—É—á—à–µ –Ω–µ —Å—Ç–∞–≤–∏—Ç—å —Å–µ—Ç–∫—É, —á–µ–º —Å—Ç–∞–≤–∏—Ç—å –Ω–µ—Ä–∞–±–æ—á—É—é.

**DCA + SMC ‚Äî –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ safety order –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ:**
- DCA —Ö–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å safety order –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –Ω–∞ -3%
- SMC –≤–∏–¥–∏—Ç Fair Value Gap –≤ —ç—Ç–æ–π –∑–æ–Ω–µ ‚Üí `ENHANCED` ‚Äî –ø–æ–ª–Ω—ã–π –æ–±—ä—ë–º
- SMC –Ω–µ –≤–∏–¥–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ‚Üí `NEUTRAL` ‚Üí –æ–±—ä—ë–º —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –Ω–∞ 50%

**Trend Follower + SMC ‚Äî –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∞ –≤—Ö–æ–¥–∞:**
- Trend Follower –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø—Ä–æ–±–æ–π EMA(50) –≤–≤–µ—Ä—Ö
- SMC –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: –ø—Ä–æ–±–æ–π –ø—Ä–æ–∏–∑–æ—à—ë–ª –∏–∑ –∑–æ–Ω—ã Order Block ‚Üí `ENHANCED`
- SMC –≤–∏–¥–∏—Ç: –¥–≤–∏–∂–µ–Ω–∏–µ –≤ –∑–æ–Ω—É –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–ª–æ–≤—É—à–∫–∞) ‚Üí `REJECT`

### 5.4. –¢—Ä–µ–∫–∏–Ω–≥ ¬´–∑–¥–æ—Ä–æ–≤—å—è¬ª –∑–æ–Ω (Zone Staleness)

> **–ü—Ä–æ–±–ª–µ–º–∞:** SMC-–∑–æ–Ω—ã –Ω–µ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç. –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ Order Block –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å ENHANCED
> –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏—è—Ö, —Ö–æ—Ç—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ –∑–æ–Ω–∞ –æ—Å–ª–∞–±–ª–µ–Ω–∞.

```python
class SMCZone:
    """–ó–æ–Ω–∞ SMC —Å —Ç—Ä–µ–∫–∏–Ω–≥–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è."""
    price_low: float
    price_high: float
    zone_type: Literal["order_block", "fvg", "liquidity"]
    created_candle: int           # –∏–Ω–¥–µ–∫—Å —Å–≤–µ—á–∏ —Å–æ–∑–¥–∞–Ω–∏—è
    touches: int = 0              # —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Ü–µ–Ω–∞ –í–•–û–î–ò–õ–ê –≤ –∑–æ–Ω—É (–Ω–µ per-candle!)
    max_touches: int = 2          # –º–∞–∫—Å–∏–º—É–º –∫–∞—Å–∞–Ω–∏–π –¥–æ ¬´—Å–º–µ—Ä—Ç–∏¬ª
    _was_inside: bool = False     # —Ç—Ä–µ–∫–∏–Ω–≥ –ø–µ—Ä–µ—Ö–æ–¥–∞ ¬´—Å–Ω–∞—Ä—É–∂–∏ ‚Üí –≤–Ω—É—Ç—Ä—å¬ª

    @property
    def is_alive(self) -> bool:
        return self.touches < self.max_touches

    @property
    def confidence_decay(self) -> float:
        """–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç —Å –∫–∞–∂–¥—ã–º –∫–∞—Å–∞–Ω–∏–µ–º."""
        if not self.is_alive:
            return 0.0
        # touch 0: 1.0, touch 1: 0.7, touch 2+: –∑–æ–Ω–∞ –º–µ—Ä—Ç–≤–∞
        return max(0.0, 1.0 - (self.touches * 0.3))

    def on_price_touch(self, price: float):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–π —Å–≤–µ—á–µ. –°—á–∏—Ç–∞–µ—Ç –£–ù–ò–ö–ê–õ–¨–ù–´–ï –≤—Ö–æ–¥—ã –≤ –∑–æ–Ω—É,
        –∞ –Ω–µ –∫–∞–∂–¥—É—é —Å–≤–µ—á—É –≤–Ω—É—Ç—Ä–∏ –∑–æ–Ω—ã.

        –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-H4: per-candle –ø–æ–¥—Å—á—ë—Ç –±—ã–ª —Å–ª–∏—à–∫–æ–º
        –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–º ‚Äî –∑–æ–Ω–∞ —É–º–∏—Ä–∞–ª–∞ –∑–∞ 2 —Å–≤–µ—á–∏ –ø–æ–¥—Ä—è–¥ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë.
        –¢–µ–ø–µ—Ä—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ—Ö–æ–¥ ¬´—Ü–µ–Ω–∞ –±—ã–ª–∞ –≤–Ω–µ –∑–æ–Ω—ã ‚Üí —Ü–µ–Ω–∞ –≤–æ—à–ª–∞ –≤ –∑–æ–Ω—É¬ª."""
        is_inside = self.price_low <= price <= self.price_high
        if is_inside and not self._was_inside:
            self.touches += 1  # –Ω–æ–≤—ã–π –≤—Ö–æ–¥ –≤ –∑–æ–Ω—É
        self._was_inside = is_inside
```

```python
class SMCFilter:
    """–§–∏–ª—å—Ç—Ä —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∑–æ–Ω."""

    MIN_CONFIDENCE = 0.4
    ENHANCED_THRESHOLD = 0.7
    NEUTRAL_SIZE_MULTIPLIER = 0.5
    LOOKBACK_CANDLES = 100
    TIMEFRAMES = ["1h", "4h"]

    def __init__(self):
        self.zones: list[SMCZone] = []
        self._last_recalc: datetime = None

    def recalculate_zones(self, candles_1h, candles_4h):
        """–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∑–æ–Ω—ã. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Master Loop (—Ä–∞–∑ –≤ 60 —Å–µ–∫),
        –∞ –ù–ï –∏–∑ Strategy Loop ‚Äî –∏–∑–±–µ–≥–∞–µ–º rate limit."""
        self._prune_dead_zones()
        new_zones = self._find_order_blocks(candles_4h)
        new_zones += self._find_fvg(candles_1h)
        self._merge_zones(new_zones)
        self._last_recalc = datetime.utcnow()

    def filter(self, signal: Signal, candle: pd.Series) -> Signal | None:
        """–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –ø–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∑–æ–Ω–∞–º."""
        # –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Å–∞–Ω–∏—è –∑–æ–Ω
        self._update_touches(candle.close)

        # –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à—É—é –∂–∏–≤—É—é –∑–æ–Ω—É
        zone = self._find_nearest_alive_zone(signal.price)
        if zone is None:
            # –ù–µ—Ç –∑–æ–Ω ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (0.5). –ü—Ä–∏ min_confidence=0.4 —Å–∏–≥–Ω–∞–ª
            # –ø—Ä–æ–π–¥—ë—Ç —Å —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º (NEUTRAL), –Ω–æ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω.
            # –≠—Ç–æ –û–°–û–ó–ù–ê–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ SMC-–¥–∞–Ω–Ω—ã—Ö ‚â† –ø–ª–æ—Ö–æ–π —Å–∏–≥–Ω–∞–ª.
            # –ü–æ–ª–Ω—ã–π REJECT –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –∑–æ–Ω–∞ –ï–°–¢–¨, –Ω–æ confidence < 0.4.
            confidence = 0.5
        else:
            confidence = zone.confidence_decay * self._zone_quality(zone, signal)

        if confidence >= self.ENHANCED_THRESHOLD:
            return signal  # –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        elif confidence >= self.MIN_CONFIDENCE:
            signal.qty *= Decimal(str(self.NEUTRAL_SIZE_MULTIPLIER))
            return signal  # —É–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä
        else:
            return None  # REJECT

    def _prune_dead_zones(self):
        """–£–¥–∞–ª–∏—Ç—å –º—ë—Ä—Ç–≤—ã–µ –∑–æ–Ω—ã (–∫–∞—Å–∞–Ω–∏—è >= max_touches)."""
        self.zones = [z for z in self.zones if z.is_alive]
```

### 5.5. Rate Limit –∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

> **–ü—Ä–æ–±–ª–µ–º–∞:** SMC —Ç—Ä–µ–±—É–µ—Ç –º—É–ª—å—Ç–∏-–¢–§ –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –∏—Ö –Ω–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
> Strategy Loop (1-5 —Å–µ–∫), –º–æ–∂–Ω–æ —É–ø–µ—Ä–µ—Ç—å—Å—è –≤ rate limit –±–∏—Ä–∂–∏.

**–†–µ—à–µ–Ω–∏–µ:** SMC Filter –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∑–æ–Ω—ã **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —Å Master Loop** (—Ä–∞–∑ –≤ 60 —Å–µ–∫—É–Ω–¥). Strategy Loop –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã** –º–µ–∂–¥—É –ø–µ—Ä–µ—Å—á—ë—Ç–∞–º–∏.

```
Master Loop (60 —Å–µ–∫):
  1. Fetch 1h –∏ 4h candles –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä (batch request)
  2. smc_filter.recalculate_zones(candles_1h, candles_4h)
  3. –ö–µ—à –∑–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω Strategy Loop'—É

Strategy Loop (1-5 —Å–µ–∫):
  1. signal = strategy.evaluate(candle, state)
  2. filtered = smc_filter.filter(signal, current_candle)  # –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ö–ï–® –∑–æ–Ω
  3. –ù–µ—Ç API-–∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è SMC –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ
```

---

## 6. Capital Allocator ‚Äî –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞

### 6.1. –§–æ—Ä–º—É–ª–∞ –∞–ª–ª–æ–∫–∞—Ü–∏–∏ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –≤ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –¥–∏–∑–∞–π–Ω–µ —Ñ–æ—Ä–º—É–ª–∞ `pair_weight √ó regime_confidence √ó
> performance_factor` –º–æ–≥–ª–∞ –¥–∞–≤–∞—Ç—å —Å—É–º–º—É > 100% Active Pool. –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è.

```python
class CapitalAllocator:
    RESERVE_PCT = 0.15  # 15% –Ω–µ–ø—Ä–∏–∫–æ—Å–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–∞–ø–∞—Å

    def allocate(self, pairs: list[str], snapshots: dict[str, MarketSnapshot],
                 performance: dict[str, PairPerformance]) -> dict[str, PairAllocation]:
        total_capital = self.get_total_capital()
        reserve = total_capital * self.RESERVE_PCT
        active_pool = total_capital - reserve

        # –®–∞–≥ 1: —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å RAW –∞–ª–ª–æ–∫–∞—Ü–∏–∏
        raw = {}
        for pair in pairs:
            w = self._pair_weight(pair)
            c = self._regime_confidence(snapshots[pair])
            p = self._performance_factor(performance.get(pair))
            raw[pair] = w * c * p

        # –®–∞–≥ 2: –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø ‚Äî —Å—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å active_pool
        raw_total = sum(raw.values())
        if raw_total == 0:
            return {pair: PairAllocation(target=Decimal(0)) for pair in pairs}

        if raw_total > 1.0:
            # –ü—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å—É–º–º–∞ = 100%
            norm_factor = 1.0 / raw_total
            raw = {pair: alloc * norm_factor for pair, alloc in raw.items()}

        # –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ª–∏–º–∏—Ç—ã –∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏–∏
        allocations = {}
        for pair in pairs:
            target = Decimal(str(raw[pair])) * active_pool
            target = min(target, active_pool * Decimal("0.25"))  # max 25% –Ω–∞ –ø–∞—Ä—É
            allocations[pair] = PairAllocation(target=target)

        return allocations

    def _regime_confidence(self, snapshot: MarketSnapshot) -> float:
        adx = snapshot.adx_14
        if adx > 40:
            return 1.0   # —Å–∏–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–¥ ‚Äî –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        elif adx > 30:
            return 0.8
        elif adx > 20:
            return 0.5   # –ø–µ—Ä–µ—Ö–æ–¥–Ω–∞—è –∑–æ–Ω–∞ ‚Äî –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å
        else:
            return 0.7   # –±–æ–∫–æ–≤–∏–∫ ‚Äî —É–º–µ—Ä–µ–Ω–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (Grid —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ)

    def _performance_factor(self, perf: PairPerformance | None) -> float:
        if perf is None or perf.total_trades < 10:
            # COLD START: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø—Ä–æ–±–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
            # –ù–µ 0.0 (deadlock) –∏ –Ω–µ 1.0 (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –¥–æ–≤–µ—Ä–∏—è)
            return 0.8

        if perf.win_rate > 0.60:
            return 1.2
        elif perf.win_rate > 0.40:
            return 1.0
        elif perf.win_rate > 0.25:
            return 0.6
        else:
            return 0.0  # –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø–∞—Ä—ã (>10 —Å–¥–µ–ª–æ–∫, win_rate < 25%)
```

### 6.2. Committed vs Available Capital

> **–ü—Ä–æ–±–ª–µ–º–∞:** Allocator –æ–ø–µ—Ä–∏—Ä—É–µ—Ç —Ü–µ–ª–µ–≤—ã–º–∏ —á–∏—Å–ª–∞–º–∏, –Ω–æ —Ä–µ–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª –∑–∞–ª–æ—á–µ–Ω –≤ –æ—Ä–¥–µ—Ä–∞—Ö.
> –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –º–æ–∂–µ—Ç ¬´–Ω–∞–∑–Ω–∞—á–∏—Ç—å¬ª –ø–∞—Ä–µ $12K, —Ö–æ—Ç—è $18K —É–∂–µ –∑–∞–ª–æ—á–µ–Ω–æ –≤ Grid.

```python
@dataclass
class PairAllocation:
    target: Decimal       # —Å–∫–æ–ª—å–∫–æ Allocator –•–û–ß–ï–¢ –≤—ã–¥–µ–ª–∏—Ç—å
    committed: Decimal = Decimal(0)  # —Å–∫–æ–ª—å–∫–æ –†–ï–ê–õ–¨–ù–û –∑–∞–ª–æ—á–µ–Ω–æ –≤ –æ—Ä–¥–µ—Ä–∞—Ö/–ø–æ–∑–∏—Ü–∏—è—Ö

    @property
    def available(self) -> Decimal:
        """–°–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ù–û–í–´–• –æ—Ä–¥–µ—Ä–æ–≤."""
        return max(Decimal(0), self.target - self.committed)

    @property
    def overcommitted(self) -> bool:
        """–ö–∞–ø–∏—Ç–∞–ª –∑–∞–ª–æ—á–µ–Ω —Å–≤–µ—Ä—Ö —Ü–µ–ª–µ–≤–æ–≥–æ ‚Äî –Ω–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã."""
        return self.committed > self.target
```

**–ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏ overcommitted:**
- –ù–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã (Strategy Loop –≤–∏–¥–∏—Ç `available = 0`)
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Ä–¥–µ—Ä–∞ –ù–ï –æ—Ç–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (–Ω–∞—Ä—É—à–∏—Ç Grid-—Ü–∏–∫–ª)
- –ü—Ä–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ: –µ—Å–ª–∏ –ø–∞—Ä–∞ overcommitted, Capital Allocator –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ –ø–∞—Ä—ã –∑–∞ —Å—á—ë—Ç ¬´–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ¬ª —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
- Grid-—Å–µ—Ç–∫–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—É—Ç—ë–º (—Ü–∏–∫–ª—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è)

### 6.3. –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- **–ú–∞–∫—Å–∏–º—É–º –Ω–∞ –æ–¥–Ω—É –ø–∞—Ä—É:** 25% –æ—Ç Active Pool
- **–ú–∞–∫—Å–∏–º—É–º –Ω–∞ –æ–¥–Ω—É —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–∫—Ä–æ—Å—Å-–ø–∞—Ä—ã):** 40% –æ—Ç Active Pool
- **Reserve 15% ‚Äî target —Å enforcement:**
  - Allocator –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞–∑–Ω–∞—á–∞–µ—Ç target, –Ω–∞—Ä—É—à–∞—é—â–∏–π reserve
  - –ù–æ –ø—Ä–∏ overcommitted (—Ä—ã–Ω–æ—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ) reserve –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞—Ä—É—à–µ–Ω
  - **Enforcement:** –µ—Å–ª–∏ `committed_total > 90% √ó total_capital` (reserve < 10%),
    Capital Allocator –ø–æ–º–µ—á–∞–µ—Ç –Ω–∞–∏–º–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ø–∞—Ä—ã –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ
    —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–π —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ (force reduce, –Ω–µ force close)
  - –≠—Ç–æ –º—è–≥—á–µ Emergency Halt, –Ω–æ –∑–∞—â–∏—â–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—É—Ñ–µ—Ä
- **–†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞:** –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å MIN_REGIME_DURATION)
- **Emergency Halt:** –µ—Å–ª–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å —É–ø–∞–ª –Ω–∞ > 10% –∑–∞ —Å—É—Ç–∫–∏ ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (—Å–º. —Ä–∞–∑–¥–µ–ª 7.3)

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-H5:** –†–∞–Ω–µ–µ reserve –æ–ø–∏—Å—ã–≤–∞–ª—Å—è –∫–∞–∫ ¬´15% –≤—Å–µ–≥–¥–∞¬ª,
> –Ω–æ overcommitted –ø–æ–∑–∏—Ü–∏–∏ –Ω–µ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è, –∏ –ø—Ä–∏ –∫—Ä—ç—à–µ committed –º–æ–≥ –ø–æ–≥–ª–æ—Ç–∏—Ç—å –≤–µ—Å—å reserve.
> –¢–µ–ø–µ—Ä—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞ enforcement (10% reserve = 90% committed) —Å –º—è–≥–∫–∏–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ–º.

---

## 7. Risk Aggregator ‚Äî –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–∏—Å–∫–æ–≤

### 7.1. –¢—Ä–∏ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã

```
Level 1: Per-Trade Risk (–Ω–∞ –∫–∞–∂–¥—É—é —Å–¥–µ–ª–∫—É)
‚îú‚îÄ‚îÄ Max loss per trade: 1-2% –æ—Ç –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞—Ä—ã
‚îú‚îÄ‚îÄ Stop-loss –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (ATR-based)
‚îî‚îÄ‚îÄ Position size = risk_amount / distance_to_stop

Level 2: Per-Pair Risk (–Ω–∞ –∫–∞–∂–¥—É—é –ø–∞—Ä—É)
‚îú‚îÄ‚îÄ Max open: 1 —Å–µ—Ç–∫–∞ (Grid) / 1 DCA-deal / 1 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (Trend)
‚îÇ   (–ü–æ–¥—Ä–æ–±–Ω–µ–µ –Ω–∏–∂–µ –≤ 7.2)
‚îú‚îÄ‚îÄ Max daily loss per pair: 3% –æ—Ç –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞—Ä—ã
‚îú‚îÄ‚îÄ Cooldown –ø–æ—Å–ª–µ —É–±—ã—Ç–æ—á–Ω–æ–π —Å–µ—Ä–∏–∏: 3 –ø–æ–¥—Ä—è–¥ ‚Üí –ø–∞—É–∑–∞ 2 —á–∞—Å–∞
‚îî‚îÄ‚îÄ –ù–µ–ª—å–∑—è –∏–º–µ—Ç—å Grid-—Å–µ—Ç–∫—É –ò DCA-deal –Ω–∞ –û–î–ù–û–ô –ø–∞—Ä–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

Level 3: Portfolio Risk (–ø–æ –≤—Å–µ–º—É –ø–æ—Ä—Ç—Ñ–µ–ª—é)
‚îú‚îÄ‚îÄ Max total exposure: 70% –æ—Ç Total Capital
‚îú‚îÄ‚îÄ Max correlated exposure: 40% (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã)
‚îú‚îÄ‚îÄ Dynamic correlation check: —Å–º. 7.4
‚îú‚îÄ‚îÄ Daily portfolio loss 5% ‚Üí REDUCED MODE (50% —Ä–∞–∑–º–µ—Ä—ã)
‚îú‚îÄ‚îÄ Daily portfolio loss 10% ‚Üí EMERGENCY HALT (–ø—Ä–æ—Ç–æ–∫–æ–ª –≤ 7.3)
‚îî‚îÄ‚îÄ Drawdown > 15% –æ—Ç ATH ‚Üí –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
```

### 7.2. –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–µ–∂–∏–º–æ–≤ —Ä–∏—Å–∫–∞ –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ NEW-H2 + NEW-M4:** –†–∞–Ω–µ–µ –Ω–µ –±—ã–ª–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ,
> –∫–∞–∫ REDUCED MODE –∏ STRESS MODE –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç, –∏ –∫–∞–∫–æ–π —Ä–µ–∂–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
> –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É):**

```
1. EMERGENCY HALT        (daily loss > 10%)  ‚Üí –í–°–ï –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
2. REDUCED MODE          (daily loss > 5%)   ‚Üí —Ä–∞–∑–º–µ—Ä—ã √ó 0.5
3. STRESS MODE           (–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è > 0.8)  ‚Üí —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è ‚Üí 40%, —Ä–∞–∑–º–µ—Ä—ã √ó 0.5
4. DRAWDOWN REDUCTION    (DD > 15% –æ—Ç ATH)   ‚Üí –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π
5. NORMAL                                     ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```

**–ü—Ä–∞–≤–∏–ª–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:**

- EMERGENCY HALT –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å—ë ‚Äî –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∏–∫–∞–∫–∏–µ –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã –Ω–µ –¥–µ–π—Å—Ç–≤—É—é—Ç
- REDUCED + STRESS –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí **–º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ:** `size = base √ó 0.5 √ó 0.5 = 25%`
  (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞, –Ω–µ "–æ–¥–∏–Ω–∞—Ä–Ω—ã–π" 50%)
- REDUCED + DRAWDOWN REDUCTION ‚Üí REDUCED –ø–æ–±–µ–∂–¥–∞–µ—Ç (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π)
- STRESS + DRAWDOWN REDUCTION ‚Üí –æ–±–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è: STRESS —Å–Ω–∏–∂–∞–µ—Ç —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é,
  DRAWDOWN REDUCTION –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∫—Ä–∞—â–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏

```python
class RiskModeManager:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Ä–µ–∂–∏–º–æ–≤ —Ä–∏—Å–∫–∞."""

    def get_size_multiplier(self) -> float:
        if self.emergency_halt:
            return 0.0  # —Ç–æ—Ä–≥–æ–≤–ª—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞

        multiplier = 1.0
        if self.reduced_mode:      # daily loss > 5%
            multiplier *= 0.5
        if self.stress_mode:       # high correlation
            multiplier *= 0.5
        return multiplier          # min = 0.25 (–æ–±–∞ –∞–∫—Ç–∏–≤–Ω—ã)

    def get_max_exposure(self) -> float:
        if self.stress_mode:
            return 0.40  # 40% –≤–º–µ—Å—Ç–æ 70%
        return 0.70
```

### 7.3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ¬´–ø–æ–∑–∏—Ü–∏–∏¬ª –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

> **–ü—Ä–æ–±–ª–µ–º–∞:** –ø—Ä–∞–≤–∏–ª–æ ¬´1 –ø–æ–∑–∏—Ü–∏—è –Ω–∞ –ø–∞—Ä—É¬ª –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Grid (–¥–æ 30 –æ—Ä–¥–µ—Ä–æ–≤)
> –∏ DCA (–¥–æ 11 –æ—Ä–¥–µ—Ä–æ–≤). –§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫—É –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å.

```python
class PerPairRisk:
    """–ü—Ä–∞–≤–∏–ª–∞ per-pair, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é."""

    def allow_new_activity(self, pair: str, strategy: str, state: ExchangeState) -> bool:
        if strategy == "grid":
            # Grid: max 1 –°–ï–¢–ö–ê –Ω–∞ –ø–∞—Ä—É
            # –°–µ—Ç–∫–∞ = –≥—Ä—É–ø–ø–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤ (15 buy + 15 sell = 1 —Å–µ—Ç–∫–∞)
            active_grids = state.count_active_grids(pair)
            return active_grids < 1

        elif strategy == "dca":
            # DCA: max 1 DEAL –Ω–∞ –ø–∞—Ä—É
            # Deal = base order + –¥–æ N safety orders (–≤—Å–µ = 1 deal)
            active_deals = state.count_active_dca_deals(pair)
            return active_deals < 1

        elif strategy == "trend":
            # Trend: max 1 –ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï –Ω–∞ –ø–∞—Ä—É
            # –ù–µ–ª—å–∑—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ long –ò short
            active_directions = state.get_active_directions(pair)
            return len(active_directions) < 1

    def check_cross_strategy_conflict(self, pair: str, state: ExchangeState) -> bool:
        """Grid-—Å–µ—Ç–∫–∞ –∏ DCA-deal –Ω–∞ –æ–¥–Ω–æ–π –ø–∞—Ä–µ = –ó–ê–ü–†–ï–©–ï–ù–û."""
        has_grid = state.count_active_grids(pair) > 0
        has_dca = state.count_active_dca_deals(pair) > 0
        return not (has_grid and has_dca)
```

### 7.3. Emergency Halt ‚Äî –ü—Ä–æ—Ç–æ–∫–æ–ª —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

> **–ü—Ä–æ–±–ª–µ–º–∞:** –≤ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –¥–∏–∑–∞–π–Ω–µ Emergency Halt = ¬´exit loop¬ª –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è,
> —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å –ø–æ–∑–∏—Ü–∏—è–º–∏, –∫–æ–≥–¥–∞ halt –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∏ –∫—Ç–æ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   EMERGENCY HALT PROTOCOL                          ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  –¢—Ä–∏–≥–≥–µ—Ä: daily_portfolio_loss > 10%                               ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  Stage 1: –ù–ï–ú–ï–î–õ–ï–ù–ù–û (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, < 5 —Å–µ–∫—É–Ω–¥)                   ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ –û—Ç–º–µ–Ω–∏—Ç—å –í–°–ï pending –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ (–≤—Å–µ –ø–∞—Ä—ã)               ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Strategy Loop ‚Üí PAUSE –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä                            ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Master Loop ‚Üí PAUSE                                           ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Telegram: "‚ö†Ô∏è EMERGENCY HALT: -10.2% –∑–∞ —Å—É—Ç–∫–∏"               ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  Stage 2: –†–ï–®–ï–ù–ò–ï (–æ–∂–∏–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, —Ç–∞–π–º–∞—É—Ç 30 –º–∏–Ω)             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç:                                    ‚îÇ
‚îÇ  ‚îÇ   - –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ –∫–∞–∂–¥–æ–π –ø–∞—Ä–µ                             ‚îÇ
‚îÇ  ‚îÇ   - Unrealized PnL –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏                               ‚îÇ
‚îÇ  ‚îÇ   - –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞                                         ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ –í–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:                                       ‚îÇ
‚îÇ  ‚îÇ   /close_all     ‚Äî –∑–∞–∫—Ä—ã—Ç—å –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ —Ä—ã–Ω–∫—É                 ‚îÇ
‚îÇ  ‚îÇ   /hold          ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tight SL        ‚îÇ
‚îÇ  ‚îÇ   /reduce_50     ‚Äî –∑–∞–∫—Ä—ã—Ç—å 50% –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏                   ‚îÇ
‚îÇ  ‚îÇ   /resume        ‚Äî —Å–Ω—è—Ç—å halt, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–æ—Ä–≥–æ–≤–ª—é              ‚îÇ
‚îÇ  ‚îÇ                                                                 ‚îÇ
‚îÇ  Stage 3: DEFAULT (–µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ 30 –º–∏–Ω—É—Ç)           ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tight Stop-Loss (1.5√ó ATR) –Ω–∞ –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ –ù–ï –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ market (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–¥–∞–∂—É –Ω–∞ –¥–Ω–µ)              ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Telegram: "‚è∞ –¢–∞–π–º–∞—É—Ç 30 –º–∏–Ω. Tight SL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ –û–∂–∏–¥–∞–Ω–∏–µ /resume –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è                            ‚îÇ
‚îÇ                                                                    ‚îÇ
‚îÇ  –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –¢–û–õ–¨–ö–û –ø–æ –∫–æ–º–∞–Ω–¥–µ /resume –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞             ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å Capital Allocation                                ‚îÇ
‚îÇ  ‚îú‚îÄ‚îÄ Reconcile –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ Master Loop ‚Üí RESUME                                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 7.3.1. Emergency Halt –≤–æ –≤—Ä–µ–º—è Graceful Transition

> **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ NEW-H1:** –ï—Å–ª–∏ Emergency Halt —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç, –ø–æ–∫–∞
> Graceful Transition —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç `strategy_locks[pair]`, –≤–æ–∑–Ω–∏–∫–∞–µ—Ç deadlock:
> transition –∂–¥—ë—Ç –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏ (–¥–æ 2 —á–∞—Å–æ–≤), –∞ halt –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë.

**–ü—Ä–æ—Ç–æ–∫–æ–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:**

```python
class EmergencyHalt:
    async def execute(self):
        # 1. –ü—Ä–µ—Ä–≤–∞—Ç—å –í–°–ï –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ transitions
        for pair, lock in self.strategy_locks.items():
            if lock.locked():
                # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ lock
                lock.release()
                logger.warning(f"Emergency Halt: force-released transition lock for {pair}")

        # 2. –ü–æ–º–µ—Ç–∏—Ç—å –≤—Å–µ TransitionState –∫–∞–∫ –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ
        pending = await self.state_persistence.get_pending_transitions()
        for transition in pending:
            transition.in_progress = False
            transition.completed_at = datetime.utcnow()
            transition.metadata["interrupted_by"] = "emergency_halt"
            await self.state_persistence.save_transition(transition)

        # 3. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª halt (cancel all, pause loops, notify)
        await self._cancel_all_orders()
        await self._pause_all_loops()
        await self._notify_operator()
```

**–ü—Ä–∞–≤–∏–ª–∞:**
- Emergency Halt **–í–°–ï–ì–î–ê** –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ Graceful Transition
- –í—Å–µ strategy_locks –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è
- –ü—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ transitions –ø–æ–º–µ—á–∞—é—Ç—Å—è –≤ PostgreSQL
- –ü—Ä–∏ /resume: —Å–∏—Å—Ç–µ–º–∞ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–µ transitions –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç crash recovery (—Ä–∞–∑–¥–µ–ª 8.2)

### 7.4. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞

> **–ü—Ä–æ–±–ª–µ–º–∞:** —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã (`btc_ecosystem`, `defi`, `memes`) –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç,
> —á—Ç–æ –ø—Ä–∏ –∫—Ä—ç—à–µ –í–°–ï –∫—Ä–∏–ø—Ç–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É–µ—Ç. –†–µ–∞–ª—å–Ω–∞—è —Å—É–º–º–∞—Ä–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å 90%,
> —Ö–æ—Ç—è –∫–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –≤ –ª–∏–º–∏—Ç–µ 30%.

```python
CORRELATION_GROUPS = {
    "btc_ecosystem": ["BTC/USDT", "WBTC/USDT"],
    "eth_ecosystem": ["ETH/USDT", "STETH/USDT"],
    "large_caps":    ["BNB/USDT", "SOL/USDT", "ADA/USDT"],
    "defi":          ["AAVE/USDT", "UNI/USDT", "LINK/USDT"],
    "memes":         ["DOGE/USDT", "SHIB/USDT", "PEPE/USDT"],
}

# –ü—Ä–∞–≤–∏–ª–æ 1 (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ): —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã <= 30% Active Pool


class DynamicCorrelationMonitor:
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–∞–ª—å–Ω–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –º–µ–∂–¥—É –ø–∞—Ä–∞–º–∏.
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞ –ø—Ä–∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–µ."""

    STRESS_CORRELATION_THRESHOLD = 0.8
    STRESS_PAIRS_RATIO = 0.6  # –µ—Å–ª–∏ > 60% –ø–∞—Ä –≤—ã—Å–æ–∫–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω—ã
    STRESS_MAX_EXPOSURE = 0.4  # —Å–Ω–∏–∑–∏—Ç—å —Å—É–º–º–∞—Ä–Ω—É—é —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é –¥–æ 40%

    def check(self, pairs: list[str], returns_24h: dict[str, list[float]]) -> StressLevel:
        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–æ–ø–∞—Ä–Ω—É—é –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
        corr_matrix = self._compute_pairwise_correlation(returns_24h)

        high_corr_count = 0
        total_pairs = len(pairs) * (len(pairs) - 1) // 2

        for i, a in enumerate(pairs):
            for b in pairs[i+1:]:
                if abs(corr_matrix[a][b]) > self.STRESS_CORRELATION_THRESHOLD:
                    high_corr_count += 1

        ratio = high_corr_count / total_pairs if total_pairs > 0 else 0

        if ratio > self.STRESS_PAIRS_RATIO:
            return StressLevel.HIGH
            # ‚Üí Capital Allocator —Å–Ω–∏–∂–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—É—é —ç–∫—Å–ø–æ–∑–∏—Ü–∏—é –¥–æ 40%
            # ‚Üí Telegram: "üî¥ Stress Mode: –≤—ã—Å–æ–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è, —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞"

        return StressLevel.NORMAL
```

**–ü—Ä–∞–≤–∏–ª–æ 2 (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ):** –ï—Å–ª–∏ > 60% –ø–∞—Ä –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç > 0.8 –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞:
- `STRESS_MODE` –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- –°—É–º–º–∞—Ä–Ω–∞—è —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è —Å–Ω–∏–∂–∞–µ—Ç—Å—è –¥–æ 40% Total Capital (–≤–º–µ—Å—Ç–æ 70%)
- –ù–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è —Å 50% –æ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
- –†–µ–∂–∏–º —Å–Ω–∏–º–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–∞–¥–∞–µ—Ç

---

## 8. Graceful Transition ‚Äî –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

### 8.1. –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª

> **–ü—Ä–æ–±–ª–µ–º–∞:** —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–æ–∂–µ—Ç –Ω–µ –∑–∞–∫—Ä—ã—Ç—å –ø–æ–∑–∏—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Grid-TP –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç,
> –∞ —Ü–µ–Ω–∞ —É—à–ª–∞ –≤ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—É—é —Å—Ç–æ—Ä–æ–Ω—É). –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ deadlock: –∫–∞–ø–∏—Ç–∞–ª –∑–∞–ª–æ—á–µ–Ω,
> –Ω–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É.

```python
class GracefulTransition:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ crash-safety."""

    TRANSITION_TIMEOUT = timedelta(hours=2)

    async def execute(self, pair: str, old_strategy: Strategy,
                      new_strategy: Strategy, exchange: Exchange):

        # 0. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ (crash-safety)
        transition_state = TransitionState(
            in_progress=True,
            from_strategy=old_strategy.name,
            to_strategy=new_strategy.name,
            started_at=datetime.utcnow(),
            pair=pair,
        )
        await self.state_persistence.save_transition(transition_state)

        # 1. LOCK Strategy Loop
        self.strategy_locks[pair].acquire()

        # 2. –û—Ç–º–µ–Ω–∏—Ç—å pending –æ—Ä–¥–µ—Ä–∞ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        await exchange.cancel_all_orders(pair)

        # 3. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–∫—Ä—ã—Ç—å
        position = await exchange.get_position(pair)
        if position and position.size > 0:
            # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å tight SL/TP –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è
            await self._set_exit_orders(position, exchange)

            # –ñ–¥–∞—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            closed = await self._wait_for_close(
                pair, exchange, timeout=self.TRANSITION_TIMEOUT
            )

            if not closed:
                # –¢–ê–ô–ú–ê–£–¢: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ market
                await exchange.close_position(pair, market=True)
                logger.warning(
                    f"Forced close {pair}: transition timeout "
                    f"({self.TRANSITION_TIMEOUT})"
                )

        # 4. –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
        self.active_strategies[pair] = new_strategy
        await new_strategy.initialize(pair, self.allocations[pair])

        # 5. –û–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞
        transition_state.in_progress = False
        transition_state.completed_at = datetime.utcnow()
        await self.state_persistence.save_transition(transition_state)

        # 6. UNLOCK Strategy Loop
        self.strategy_locks[pair].release()
```

### 8.2. Crash Recovery –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

> **–ü—Ä–æ–±–ª–µ–º–∞:** –ø—Ä–∏ –∫—Ä—ç—à–µ –ø–æ—Å—Ä–µ–¥–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±—ã–ª–æ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ.
> –ú–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–µ–∫—É—â–µ–º—É —Ä–µ–∂–∏–º—É.

```python
@dataclass
class TransitionState:
    """–°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞, –ø–µ—Ä—Å–∏—Å—Ç–∏—Ç—Å—è –≤ PostgreSQL."""
    in_progress: bool
    from_strategy: str
    to_strategy: str
    pair: str
    started_at: datetime
    completed_at: datetime | None = None
    pending_cancellations: list[str] = field(default_factory=list)  # order IDs

class CrashRecovery:
    async def reconcile_on_startup(self):
        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
        pending = await self.state_persistence.get_pending_transitions()

        for transition in pending:
            logger.warning(
                f"Crash recovery: incomplete transition on {transition.pair}: "
                f"{transition.from_strategy} ‚Üí {transition.to_strategy}"
            )

            # –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –ø–∞—Ä–µ (–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ —á—å–∏)
            await self.exchange.cancel_all_orders(transition.pair)

            # Reconcile –ø–æ–∑–∏—Ü–∏–∏
            position = await self.exchange.get_position(transition.pair)

            # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Ä—ã–Ω–∫–∞
            snapshot = await self.market_scanner.scan(transition.pair)
            regime = self.regime_classifier.classify(snapshot, None)
            target_strategy = self.strategy_router.route(regime)

            # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
            await self._start_strategy(transition.pair, target_strategy, position)

            # –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥
            transition.in_progress = False
            transition.completed_at = datetime.utcnow()
            await self.state_persistence.save_transition(transition)
```

---

## 9. –ü–æ–ª–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º ‚Äî –ü–æ—à–∞–≥–æ–≤–æ

```
TRADERAGENT v2.0 Main Algorithm
================================

INIT:
  1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ (–ø–∞—Ä—ã, –∫–∞–ø–∏—Ç–∞–ª, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π)
  2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∏—Ä–∂–µ (ByBitDirectClient / ExchangeClient)
  3. –ó–∞–≥—Ä—É–∑–∏—Ç—å state snapshot –∏–∑ PostgreSQL (–µ—Å–ª–∏ –µ—Å—Ç—å)
  4. CRASH RECOVERY: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ transitions
     ‚Üí –ï—Å–ª–∏ –µ—Å—Ç—å: reconcile, –æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä–∞, –Ω–∞—á–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
  5. Reconcile: —Å–≤–µ—Ä–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ—Ä–¥–µ—Ä–∞/–ø–æ–∑–∏—Ü–∏–∏ —Å –±–∏—Ä–∂–µ–π
  6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å SMC Filter (–∑–∞–≥—Ä—É–∑–∏—Ç—å 100 —Å–≤–µ—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¢–§)
  7. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–π Capital Allocation (—Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π)
  8. –ó–∞–ø—É—Å—Ç–∏—Ç—å Telegram notifier

MASTER LOOP (–∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥):
  FOR each trading_pair:
    1. SCAN: –ü–æ–ª—É—á–∏—Ç—å MarketSnapshot (ADX, ATR, EMA, RSI, volume, BB)
    2. CLASSIFY: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å MarketRegime (6 —Ä–µ–∂–∏–º–æ–≤, –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–µ)
    3. ROUTE: –í—ã–±—Ä–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ –º–∞—Ç—Ä–∏—Ü–µ –†–µ–∂–∏–º‚Üí–°—Ç—Ä–∞—Ç–µ–≥–∏—è
    4. CHECK TRANSITION (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º confirmation_counter):
       IF –Ω–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è != —Ç–µ–∫—É—â–∞—è:
         IF new_regime == pending_regime: increment counter
         ELSE: pending_regime = new_regime, counter = 1
       IF new_regime == current_regime: counter = 0, pending = None (–°–ë–†–û–°)
       IF counter >= 3 AND elapsed >= 4 —á–∞—Å–æ–≤:
         ‚Üí Graceful Transition —Å Transition Lock:
           a) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å TransitionState –≤ PostgreSQL
           b) LOCK Strategy Loop –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã
           c) –û—Ç–º–µ–Ω–∏—Ç—å pending –æ—Ä–¥–µ—Ä–∞ —Å—Ç–∞—Ä–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
           d) –î–æ–∂–¥–∞—Ç—å—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–¥–æ 10 —Å–µ–∫)
           e) Reconcile fills –∑–∞ –≤—Ä–µ–º—è –æ—Ç–º–µ–Ω—ã
           f) –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ ‚Üí SL/TP ‚Üí –∂–¥–∞—Ç—å (—Ç–∞–π–º–∞—É—Ç 2 —á–∞—Å–∞ ‚Üí force close)
           g) –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
           h) UNLOCK Strategy Loop
    5. SMC: –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∑–æ–Ω—ã (batch fetch 1h/4h —Å–≤–µ—á–µ–π, –æ–±–Ω–æ–≤–∏—Ç—å –∫–µ—à –∑–æ–Ω)
    6. ALLOCATE: –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∫–∞–ø–∏—Ç–∞–ª –¥–ª—è –ø–∞—Ä—ã
       raw = pair_weight √ó regime_confidence √ó performance_factor
       ‚Üí –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—É–º–º—ã –¥–æ 100% Active Pool
       ‚Üí –£—á—ë—Ç committed capital (overcommitted = –∑–∞–ø—Ä–µ—Ç –Ω–æ–≤—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤)
    7. RISK CHECK:
       IF daily_portfolio_loss > 10%: EMERGENCY HALT ‚Üí
         Stage 1: –æ—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –æ—Ä–¥–µ—Ä–∞, PAUSE –≤—Å–µ loops
         Stage 2: Telegram ‚Üí –æ–ø–µ—Ä–∞—Ç–æ—Ä (/close_all, /hold, /reduce_50, /resume)
         Stage 3: –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ 30 –º–∏–Ω ‚Üí tight SL, –∂–¥–∞—Ç—å /resume
       IF daily_portfolio_loss > 5%: REDUCED MODE ‚Üí halve all sizes
       IF pair_daily_loss > 3%: PAUSE pair ‚Üí skip
       IF drawdown > 15%: reduce positions gradually

  REBALANCE (–∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞):
    - –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å pair_weights –ø–æ performance (cold start: factor = 0.8)
    - –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å correlation exposure (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    - –ï—Å–ª–∏ > 60% –ø–∞—Ä –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç > 0.8: STRESS MODE ‚Üí —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ 40%
    - –£–±—Ä–∞—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ä—ã (win_rate < 25% –ø—Ä–∏ >= 10 —Å–¥–µ–ª–æ–∫)
    - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å allocation snapshot

STRATEGY LOOP (–∫–∞–∂–¥—ã–µ 1-5 —Å–µ–∫—É–Ω–¥, per pair):
  0. CHECK LOCK: –µ—Å–ª–∏ strategy_lock[pair] ‚Üí skip (–∏–¥—ë—Ç –ø–µ—Ä–µ—Ö–æ–¥)
  1. –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É
  2. –í—ã–ø–æ–ª–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:
     - Grid: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π, —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å counter-orders
     - DCA: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å confluence score, –¥–æ–±–∞–≤–∏—Ç—å safety orders
     - Trend Follower: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å EMA crossover, —É–ø—Ä–∞–≤–ª—è—Ç—å trailing stop
  3. –î–õ–Ø –ö–ê–ñ–î–û–ì–û –°–ò–ì–ù–ê–õ–ê ‚Äî –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø:
     - ENTRY ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ SMC Filter (–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–æ–Ω—ã)
       - ENHANCED ‚Üí –ø–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä
       - NEUTRAL ‚Üí 50% —Ä–∞–∑–º–µ—Ä–∞
       - REJECT ‚Üí —Å–∏–≥–Ω–∞–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω
     - GRID_COUNTER ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±–µ–∑ SMC (—á–∞—Å—Ç—å Grid-—Ü–∏–∫–ª–∞)
     - EXIT_TP / EXIT_SL / EXIT_TRANSITION / EXIT_EMERGENCY ‚Üí –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±–µ–∑ SMC
  4. CHECK available capital: –µ—Å–ª–∏ overcommitted ‚Üí –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞
  5. –†–∞–∑–º–µ—Å—Ç–∏—Ç—å/–æ—Ç–º–µ–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä–∞ –Ω–∞ –±–∏—Ä–∂–µ
  6. –û–±–Ω–æ–≤–∏—Ç—å state –≤ –ø–∞–º—è—Ç–∏
  7. Publish event –≤ Redis

STATE PERSISTENCE (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥):
  - Snapshot –≤—Å–µ—Ö engine states ‚Üí PostgreSQL
  - Snapshot TransitionState (–µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ) ‚Üí PostgreSQL
  - Snapshot regime history + allocation ‚Üí PostgreSQL
  - –ü—Ä–∏ crash ‚Üí restart ‚Üí reconcile transitions ‚Üí reconcile orders ‚Üí resume

SHUTDOWN:
  1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å TransitionState (–µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
  2. –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ pending –æ—Ä–¥–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ –∫–æ–Ω—Ñ–∏–≥—É)
  3. –§–∏–Ω–∞–ª—å–Ω—ã–π state snapshot
  4. Telegram notification
  5. Graceful exit
```

---

## 10. –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π: BTC –ø–∞–¥–∞–µ—Ç –ø–æ—Å–ª–µ —Ä–æ—Å—Ç–∞

```
–í—Ä–µ–º—è 00:00 ‚Äî BTC $100,000, ADX=15, ATR=0.8%
  –†–µ–∂–∏–º: TIGHT_RANGE (ADX < 18, ATR < 1%)
  –°—Ç—Ä–∞—Ç–µ–≥–∏—è: GRID (arithmetic, 15 —É—Ä–æ–≤–Ω–µ–π)
  –ê–ª–ª–æ–∫–∞—Ü–∏—è: $17,000 (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è)
  SMC Filter: Order Block –Ω–∞ $99,500 ‚Üí —Å–µ—Ç–∫–∞ ENHANCED
  Grid —Ä–∞–±–æ—Ç–∞–µ—Ç: –ø–æ–∫—É–ø–∞–µ—Ç –Ω–∞ $99,500, –ø—Ä–æ–¥–∞—ë—Ç –Ω–∞ $100,500

–í—Ä–µ–º—è 02:00 ‚Äî BTC $99,200, ADX=22, ATR=1.5%
  Classifier: ADX > 22 (exit_ranging) ‚Üí QUIET_TRANSITION
  pending_regime = QUIET_TRANSITION, counter = 1
  –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –æ—Å—Ç–∞—ë—Ç—Å—è GRID (–Ω—É–∂–Ω–æ 3 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

–í—Ä–µ–º—è 03:00 ‚Äî BTC $99,500, ADX=19
  Classifier: ADX < 22 ‚Üí –æ–±—Ä–∞—Ç–Ω–æ TIGHT_RANGE (= —Ç–µ–∫—É—â–∏–π)
  counter = 0, pending = None (–°–ë–†–û–°!)
  –°—Ç—Ä–∞—Ç–µ–≥–∏—è: GRID –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É (–ª–æ–∂–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ)

–í—Ä–µ–º—è 06:00 ‚Äî BTC $98,000, ADX=26, ATR=2.1%
  Classifier: VOLATILE_TRANSITION
  pending_regime = VOLATILE_TRANSITION, counter = 1

–í—Ä–µ–º—è 07:00 ‚Äî BTC $97,500, ADX=29, ATR=2.3%
  Classifier: –≤—Å—ë –µ—â—ë VOLATILE_TRANSITION (ADX < 32)
  counter = 2

–í—Ä–µ–º—è 08:00 ‚Äî BTC $97,000, ADX=33, ATR=2.5%
  Classifier: ADX > 32 (enter_trending), EMA20 < EMA50 ‚Üí BEAR_TREND
  pending_regime —Å–º–µ–Ω–∏–ª—Å—è! (–±—ã–ª VOLATILE_TRANSITION, —Å—Ç–∞–ª BEAR_TREND)
  counter = 1 (—Å–±—Ä–æ—Å –Ω–∞ –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞)

–í—Ä–µ–º—è 09:00 ‚Äî BTC $96,000, ADX=36
  BEAR_TREND, counter = 2

–í—Ä–µ–º—è 10:00 ‚Äî BTC $95,500, ADX=38
  BEAR_TREND, counter = 3 ‚úì, elapsed = 10 —á–∞—Å–æ–≤ > 4 —á–∞—Å–æ–≤ ‚úì
  ‚Üí Graceful Transition: Grid ‚Üí DCA
    1. TransitionState —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ PostgreSQL
    2. Strategy Loop LOCKED
    3. Grid: 15 pending –æ—Ä–¥–µ—Ä–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω—ã
    4. Grid buy fill –Ω–∞ $98,000 ‚Üí –ø–æ–∑–∏—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∞
       Tight SL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $94,500 (2√ó ATR)
    5. 10:15 ‚Äî SL hit: –∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ $94,500, loss = -$350
    6. DCA –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
    7. Strategy Loop UNLOCKED
  –ê–ª–ª–æ–∫–∞—Ü–∏—è: $12,750 (regime_confidence=0.5 ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

–í—Ä–µ–º—è 12:00 ‚Äî BTC $93,000, ADX=42
  –†–µ–∂–∏–º: BEAR_TREND (ADX > 25 = exit_trending ‚Üí —É–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ç—Ä–µ–Ω–¥)
  DCA: safety order #2 (-5% –æ—Ç –≤—Ö–æ–¥–∞)
  SMC Filter: Fair Value Gap –Ω–∞ $92,800 ‚Üí ENHANCED ‚Üí –ø–æ–ª–Ω—ã–π –æ–±—ä—ë–º
  Signal.type = ENTRY ‚Üí –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ SMC ‚úì

–í—Ä–µ–º—è 20:00 ‚Äî BTC $91,000, ADX=45
  DCA: safety order #3 (-8%)
  Portfolio daily loss = -4.2% ‚Üí –ø—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –∫ REDUCED MODE

  REBALANCE (–∫–∞–∂–¥—ã–µ 4 —á–∞—Å–∞):
    Dynamic Correlation Monitor:
      BTC, ETH, SOL, DOGE ‚Äî –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è 0.92 (–∫—Ä—ç—à!)
      > 60% –ø–∞—Ä –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—Ç > 0.8
      ‚Üí STRESS MODE: —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è —Å–Ω–∏–∂–µ–Ω–∞ –¥–æ 40% Total Capital

–í—Ä–µ–º—è +2 –¥–Ω—è ‚Äî BTC $97,000, ADX=18
  –†–∞–∑–≤–æ—Ä–æ—Ç! ADX –ø–∞–¥–∞–µ—Ç, —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç
  Classifier: ADX < 25 (exit_trending) ‚Üí QUIET_TRANSITION
  pending_regime = QUIET_TRANSITION, counter = 1, 2, 3...
  ‚Üí Graceful Transition: DCA ‚Üí Grid
    DCA: TP hit –ø—Ä–∏ $96,500 ‚Üí –ø—Ä–∏–±—ã–ª—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞
    Signal.type = EXIT_TP ‚Üí –æ–±—Ö–æ–¥–∏—Ç SMC Filter ‚úì
  DCA PnL: +$1,200 (4 safety orders, —Å—Ä–µ–¥–Ω—è—è $93,500, TP $96,500)
  Grid: –Ω–æ–≤—ã–π —Ü–∏–∫–ª (geometric, —à–∏—Ä–æ–∫–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω)
```

---

## 11. –û—Ç–ª–∏—á–∏—è –æ—Ç —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ê—Å–ø–µ–∫—Ç | –¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ | TRADERAGENT v2.0 |
|--------|----------------|-------------------|
| –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è | –ë–æ—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã | Master Loop —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤—Å–µ–º–∏ |
| –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ñ–∏–≥ | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ —Ä–µ–∂–∏–º—É —Ä—ã–Ω–∫–∞ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º |
| HYBRID | –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å –¥—É–±–ª–∏—Ä—É—é—â–∏–º —Ä–æ—É—Ç–∏–Ω–≥–æ–º | –£–¥–∞–ª—ë–Ω; Router –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç Grid/DCA –Ω–∞–ø—Ä—è–º—É—é |
| –ö–∞–ø–∏—Ç–∞–ª | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π per-bot | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π |
| Committed capital | –ù–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è | target vs committed vs available |
| SMC | –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è | –§–∏–ª—å—Ç—Ä: —Ç–æ–ª—å–∫–æ ENTRY, Grid —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–µ—Ç–∫—É —Ü–µ–ª–∏–∫–æ–º |
| SMC –∑–æ–Ω—ã | –ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–µ | –¢—Ä–µ–∫–∏–Ω–≥ –∫–∞—Å–∞–Ω–∏–π, confidence decay |
| –†–∏—Å–∫ | Per-bot limits | 3-—É—Ä–æ–≤–Ω–µ–≤—ã–π: trade ‚Üí pair ‚Üí portfolio |
| –ü–æ–∑–∏—Ü–∏–∏ | "1 –ø–æ–∑–∏—Ü–∏—è" –¥–ª—è –≤—Å–µ—Ö | Grid: 1 —Å–µ—Ç–∫–∞, DCA: 1 deal, Trend: 1 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ | –¢–æ–ª—å–∫–æ –≤ HYBRID (Grid‚ÜîDCA) | –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å Transition Lock –∏ —Ç–∞–π–º–∞—É—Ç–æ–º |
| Crash recovery | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ state | + –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö transitions |
| –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è | –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –≥—Ä—É–ø–ø—ã + –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| Emergency Halt | "exit loop" | 3-stage –ø—Ä–æ—Ç–æ–∫–æ–ª —Å —É—á–∞—Å—Ç–∏–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ |
| confirmation_counter | –ù–µ—Ç —Å–±—Ä–æ—Å–∞ | –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–∂–∏–º—É |
| Cold start | Deadlock (0 —Å–¥–µ–ª–æ–∫ = 0 –∞–ª–ª–æ–∫–∞—Ü–∏–∏) | –ü—Ä–æ–±–Ω—ã–π factor = 0.8 –ø—Ä–∏ < 10 —Å–¥–µ–ª–æ–∫ |
| –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ | –ù–µ—Ç | –ö–∞–∂–¥—ã–µ 4 —á–∞—Å–∞ —Å —É—á—ë—Ç–æ–º stress mode |

---

## 12. –°–ø–∏—Å–æ–∫ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –∏ —É—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### CRITICAL (—É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| C1 | SMC —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç Stop-Loss ‚Üí –ø–æ–∑–∏—Ü–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí —É–±—ã—Ç–æ–∫ —Ä–∞—Å—Ç—ë—Ç | SignalType: SMC Filter –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫ `ENTRY` | 5.1 |
| C2 | Emergency Halt –±–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ ‚Üí –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ | 3-stage –ø—Ä–æ—Ç–æ–∫–æ–ª: cancel ‚Üí –æ–ø–µ—Ä–∞—Ç–æ—Ä ‚Üí tight SL default | 7.3 |

### HIGH (—É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| H1 | Master Loop vs Strategy Loop race condition | Transition Lock: pause ‚Üí cancel ‚Üí confirm ‚Üí start ‚Üí unlock | 2.1 |
| H2 | Crash –≤–æ –≤—Ä–µ–º—è Graceful Transition | TransitionState –≤ PostgreSQL, recovery –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ | 8.2 |
| H3 | SMC –¥—ã—Ä—è–≤–∏—Ç Grid (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π) | SMC –¥–ª—è Grid –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –í–°–Æ —Å–µ—Ç–∫—É —Ü–µ–ª–∏–∫–æ–º | 5.3 |
| H4 | "1 –ø–æ–∑–∏—Ü–∏—è" vs Grid (30 –æ—Ä–¥–µ—Ä–æ–≤) –∏ DCA (11 –æ—Ä–¥–µ—Ä–æ–≤) | Grid: 1 —Å–µ—Ç–∫–∞, DCA: 1 deal, Trend: 1 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | 7.2 |
| H5 | Capital Allocator —Å—É–º–º–∞ > 100% | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–∞ raw allocations | 6.1 |
| H6 | –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ vs –∑–∞–ª–æ—á–µ–Ω–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª | committed/available capital, overcommitted = no new orders | 6.2 |
| H7 | confirmation_counter –±–µ–∑ —Å–±—Ä–æ—Å–∞ ‚Üí –ª–æ–∂–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è | –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Ç–µ–∫—É—â–µ–º—É, —Å–±—Ä–æ—Å –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ | 4.2 |
| H8 | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø—Ä–∏ –∫—Ä—ç—à–µ —Ä—ã–Ω–∫–∞ | DynamicCorrelationMonitor + STRESS_MODE (—ç–∫—Å–ø–æ–∑–∏—Ü–∏—è ‚Üí 40%) | 7.4 |
| H9 | Transition Deadlock (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è) | –¢–∞–π–º–∞—É—Ç 2 —á–∞—Å–∞ ‚Üí force close –ø–æ market | 8.1 |

### MEDIUM (—É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| M1 | HYBRID vs Strategy Router ‚Äî –¥–≤–æ–π–Ω–æ–π —Ä–æ—É—Ç–∏–Ω–≥ | HYBRID —É–¥–∞–ª—ë–Ω; Router –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é | 4.1 |
| M2 | Performance factor cold start ‚Üí deadlock | –ü—Ä–æ–±–Ω—ã–π factor = 0.8 –ø—Ä–∏ < 10 —Å–¥–µ–ª–æ–∫ | 6.1 |
| M3 | Classifier vs Router —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (—Ä–∞–∑–Ω—ã–µ –ø–æ—Ä–æ–≥–∏) | –ì–∏—Å—Ç–µ—Ä–µ–∑–∏—Å –¢–û–õ–¨–ö–û –≤ Classifier; Router –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç | 3.2 |
| M4 | SMC-–∑–æ–Ω—ã –Ω–µ —É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç | confidence_decay, max_touches, zone pruning | 5.4 |

### LOW (—É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| L1 | SMC rate limit –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º Strategy Loop | SMC –∑–æ–Ω—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ Master Loop (60—Å), Strategy Loop –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à | 5.5 |

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã (Session 13 ‚Äî –≤—ã—è–≤–ª–µ–Ω—ã –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã)

> –ù–∞–π–¥–µ–Ω—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–Ω–æ–º –∞—É–¥–∏—Ç–µ Algorithm + Backtesting –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ —Å –∫–æ–¥–æ–≤–æ–π –±–∞–∑–æ–π.

#### CRITICAL

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| NEW-C1 | QUIET_TRANSITION: Grid+DCA –Ω–∞ –æ–¥–Ω–æ–π –ø–∞—Ä–µ vs –∑–∞–ø—Ä–µ—Ç 7.2 | –û–¥–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (Grid –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–π), DCA –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è. –ë–µ–∑ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã | 4.1 |

#### HIGH

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| NEW-H1 | Emergency Halt –≤–æ –≤—Ä–µ–º—è Graceful Transition ‚Üí deadlock | Halt –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –≤—Å–µ strategy_locks, –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç transitions | 7.3.1 |
| NEW-H2 | REDUCED MODE + STRESS MODE: 50%+50% = ? | –ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–∏–≤–Ω–æ: 0.5 √ó 0.5 = 0.25. –ò–µ—Ä–∞—Ä—Ö–∏—è: Halt > Reduced > Stress > Drawdown | 7.2 |
| NEW-H3 | SMC filter —Ñ–æ—Ä–º—É–ª–∞ —Ä–∞—Å—Ö–æ–¥–∏—Ç—Å—è (algo: decay√óquality, backtest: —Ç–æ–ª—å–∫–æ decay) | –ï–¥–∏–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: `confidence = decay √ó zone_quality`. Backtesting –æ–±–Ω–æ–≤–ª—ë–Ω | 5.4, BT:5.4 |
| NEW-H4 | SMC zone touch per-candle: –∑–æ–Ω–∞ —É–º–∏—Ä–∞–µ—Ç –∑–∞ 2 —Å–≤–µ—á–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë | Per-entry –ø–æ–¥—Å—á—ë—Ç: `_was_inside` —Ç—Ä–µ–∫–∏–Ω–≥, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥–µ —Å–Ω–∞—Ä—É–∂–∏‚Üí–≤–Ω—É—Ç—Ä—å | 5.4 |
| NEW-H5 | Reserve 15% ¬´–≤—Å–µ–≥–¥–∞¬ª –Ω–µ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ overcommitted | Reserve = target —Å enforcement: committed > 90% ‚Üí –º—è–≥–∫–æ–µ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–∏–º–µ–Ω–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ø–∞—Ä | 6.3 |

#### MEDIUM

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| NEW-M1 | –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è: 3 –º–∏–Ω –∑–∞–¥–µ—Ä–∂–∫–∏ (confirmation_counter) | Cold start: `current_regime == None ‚Üí return True` (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è) | 4.3 |
| NEW-M2 | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ coordinator/ vs backtesting/multi/ | Backtesting –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ coordinator/, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ—Ç | BT:11 |
| NEW-M3 | Grid NEUTRAL –æ—Ç SMC = –ø–æ–ª–æ–≤–∏–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –Ω–∏–∂–µ min_order_size | `_check_grid_viability()`: –µ—Å–ª–∏ per-level < min_order_size ‚Üí REJECT | 5.3 |
| NEW-M4 | Drawdown 15% + daily loss 5-10% ‚Äî –¥–≤–æ–π–Ω–æ–π —Ä–µ–∂–∏–º –±–µ–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ | –ò–µ—Ä–∞—Ä—Ö–∏—è —Ä–µ–∂–∏–º–æ–≤: Halt > Reduced > Stress > Drawdown | 7.2 |

#### LOW

| # | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –†–µ—à–µ–Ω–∏–µ | –†–∞–∑–¥–µ–ª |
|---|----------|---------|--------|
| NEW-L1 | SMC –±–µ–∑ –∑–æ–Ω ‚Üí confidence=0.5 ‚Üí –≤—Å–µ–≥–¥–∞ NEUTRAL, –Ω–µ REJECT | –û—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚â† –ø–ª–æ—Ö–æ–π —Å–∏–≥–Ω–∞–ª. –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ | 5.4 |
| NEW-L2 | MarketRegime enum: –∫–æ–¥ (SIDEWAYS) vs —Å–ø–µ—Ü (TIGHT_RANGE/WIDE_RANGE) | –ú–∏–≥—Ä–∞—Ü–∏—è enum –ø—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ v2.0. –ú–∞–ø–ø–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω –≤ 13 | 13 |

---

## 13. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏

```
bot/
‚îú‚îÄ‚îÄ coordinator/
‚îÇ   ‚îú‚îÄ‚îÄ master_loop.py          # –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª (60 —Å–µ–∫)
‚îÇ   ‚îú‚îÄ‚îÄ market_scanner.py       # –°–±–æ—Ä MarketSnapshot
‚îÇ   ‚îú‚îÄ‚îÄ regime_classifier.py    # 6 —Ä–µ–∂–∏–º–æ–≤ —Å –≥–∏—Å—Ç–µ—Ä–µ–∑–∏—Å–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ strategy_router.py      # –ú–∞—Ç—Ä–∏—Ü–∞ –†–µ–∂–∏–º‚Üí–°—Ç—Ä–∞—Ç–µ–≥–∏—è (confirmation_counter)
‚îÇ   ‚îú‚îÄ‚îÄ capital_allocator.py    # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ risk_aggregator.py      # 3-—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã–π —Ä–∏—Å–∫
‚îÇ   ‚îú‚îÄ‚îÄ correlation_monitor.py  # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è + STRESS_MODE
‚îÇ   ‚îî‚îÄ‚îÄ graceful_transition.py  # Transition Lock + —Ç–∞–π–º–∞—É—Ç + crash recovery
‚îú‚îÄ‚îÄ filters/
‚îÇ   ‚îú‚îÄ‚îÄ smc_filter.py           # SMC Enhancement Layer (—Ç–æ–ª—å–∫–æ ENTRY)
‚îÇ   ‚îî‚îÄ‚îÄ smc_zones.py            # SMCZone —Å confidence_decay
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ signal.py               # Signal + SignalType enum
‚îÇ   ‚îú‚îÄ‚îÄ allocation.py           # PairAllocation (target/committed/available)
‚îÇ   ‚îî‚îÄ‚îÄ transition_state.py     # TransitionState –¥–ª—è crash recovery
```

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥—É–ª—è—Ö

- `BotOrchestrator` ‚Üí –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç —Ä–µ—à–µ–Ω–∏—è `MasterLoop`
- `BaseStrategy` ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Signal` —Å `SignalType` –≤–º–µ—Å—Ç–æ raw dict
- `GridStrategy` ‚Üí counter-orders –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ `SignalType.GRID_COUNTER`
- `RiskManager` ‚Üí —Ä–∞—Å—à–∏—Ä–µ–Ω –¥–æ `RiskAggregator` —Å 3 —É—Ä–æ–≤–Ω—è–º–∏ + `RiskModeManager`
- `StatePersistence` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `TransitionState`, regime history, allocation snapshots
- `HYBRID` —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ‚Üí —É–¥–∞–ª–µ–Ω–∞ (—Ä–æ—É—Ç–∏–Ω–≥ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ `StrategyRouter`)

### –ú–∏–≥—Ä–∞—Ü–∏—è MarketRegime enum (NEW-L2)

> –¢–µ–∫—É—â–∏–π –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–∏–µ –∏–º–µ–Ω–∞ enum. –ü—Ä–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ v2.0 –Ω–µ–æ–±—Ö–æ–¥–∏–º –º–∞–ø–ø–∏–Ω–≥:

| –¢–µ–∫—É—â–∏–π –∫–æ–¥ (market_regime.py) | v2.0 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è | –î–µ–π—Å—Ç–≤–∏–µ |
|-------------------------------|-------------------|----------|
| `SIDEWAYS` | `TIGHT_RANGE` + `WIDE_RANGE` | –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ ATR (< 1% = tight, ‚â• 1% = wide) |
| `TRENDING_BULLISH` | `BULL_TREND` | –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å |
| `TRENDING_BEARISH` | `BEAR_TREND` | –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å |
| `HIGH_VOLATILITY` | –ü–æ–≥–ª–æ—â—ë–Ω `VOLATILE_TRANSITION` | –£–¥–∞–ª–∏—Ç—å, –∑–∞–º–µ–Ω–∏—Ç—å |
| `TRANSITIONING` | `QUIET_TRANSITION` + `VOLATILE_TRANSITION` | –†–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ ATR (< 2% = quiet, ‚â• 2% = volatile) |
| `UNKNOWN` | ‚Äî | –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ fallback –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ |

**–ü–æ—Ä—è–¥–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–∏:**
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `RegimeClassifier` –≤ `bot/coordinator/` —Å v2.0 enum
2. –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç—ã (1859 —Ç–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å—Ç–∞—Ä—ã–µ enum)
3. `MarketRegimeDetector` ‚Üí deprecated, –¥–µ–ª–µ–≥–∏—Ä—É–µ—Ç –≤ `RegimeClassifier`
4. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è: –æ–±–∞ enum —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ adapter

### –ü—Ä–∏–Ω—Ü–∏–ø –µ–¥–∏–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–æ–¥–∞ (NEW-M2)

> –ë—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥ –ù–ï –î–û–õ–ñ–ï–ù –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.

```python
# –ü–†–ê–í–ò–õ–¨–ù–û: backtesting –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏–∑ coordinator
# bot/backtesting/multi/multi_strategy.py
from bot.coordinator.regime_classifier import RegimeClassifier
from bot.coordinator.strategy_router import StrategyRouter
from bot.coordinator.capital_allocator import CapitalAllocator

# –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–ø–∏–∏ –≤ backtesting/multi/
# bot/backtesting/multi/regime_classifier.py  ‚Üê –ù–ï –°–û–ó–î–ê–í–ê–¢–¨
```

–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: `SimulatedExchange` –∏ `BacktestRiskManager` ‚Äî –±—ç–∫—Ç–µ—Å—Ç-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ,
–∂–∏–≤—É—Ç —Ç–æ–ª—å–∫–æ –≤ `bot/backtesting/`.
