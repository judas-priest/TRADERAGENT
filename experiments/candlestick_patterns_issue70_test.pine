// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© TRADERAGENT

//@version=6
indicator("Candlestick Patterns Test - Issue #70", shorttitle="Candle Patterns Test", overlay=true, max_labels_count=500)

// ============================================================================
// ÐžÐŸÐ˜Ð¡ÐÐÐ˜Ð• / DESCRIPTION
// ============================================================================
// Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ñ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð² ÑÐ²ÐµÑ‡ÐµÐ¹
// ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ issue #70.
//
// Test indicator for verifying candlestick pattern recognition
// according to issue #70.
//
// Ð­Ñ‚Ð¾Ñ‚ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ:
// 1. ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð² Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð¾Ñ‚Ð°
// 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÑƒ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ (Strict/Medium/Relaxed)
// 3. Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ð¾Ð²
//
// This indicator allows visual testing of:
// 1. Detection of classic reversal patterns
// 2. Sensitivity adjustment (Strict/Medium/Relaxed)
// 3. Statistics of detected patterns

// ============================================================================
// Ð’Ð¥ÐžÐ”ÐÐ«Ð• ÐŸÐÐ ÐÐœÐ•Ð¢Ð Ð« / INPUTS
// ============================================================================

// Candlestick Pattern Settings
patternSensitivity = input.string("Medium", "Pattern Sensitivity", options=["Strict", "Medium", "Relaxed"], group="ðŸ•¯ï¸ Pattern Settings")
useHammer = input.bool(true, "Use Hammer/Shooting Star", group="ðŸ•¯ï¸ Pattern Settings")
useEngulfing = input.bool(true, "Use Engulfing Patterns", group="ðŸ•¯ï¸ Pattern Settings")
useStarPatterns = input.bool(true, "Use Star Patterns (Morning/Evening)", group="ðŸ•¯ï¸ Pattern Settings")
useDoji = input.bool(true, "Use Doji Pattern", group="ðŸ•¯ï¸ Pattern Settings")

// Display Settings
showLabels = input.bool(true, "Show Pattern Labels", group="ðŸ“Š Display")
showStats = input.bool(true, "Show Statistics Table", group="ðŸ“Š Display")
showHighlights = input.bool(true, "Highlight Pattern Candles", group="ðŸ“Š Display")

// RSI for trend detection
rsiLength = input.int(14, "RSI Length (for trend)", minval=1, group="ðŸ“ˆ Trend Detection")
emaLength = input.int(20, "EMA Length (for trend)", minval=1, group="ðŸ“ˆ Trend Detection")

// ============================================================================
// Ð’Ð«Ð§Ð˜Ð¡Ð›Ð•ÐÐ˜Ð• Ð˜ÐÐ”Ð˜ÐšÐÐ¢ÐžÐ ÐžÐ’ / INDICATOR CALCULATIONS
// ============================================================================

// Get sensitivity multipliers
float bodyThreshold = patternSensitivity == "Strict" ? 0.25 : patternSensitivity == "Medium" ? 0.3 : 0.35
float wickRatio = patternSensitivity == "Strict" ? 2.5 : patternSensitivity == "Medium" ? 2.0 : 1.5

// Candle measurements
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
totalRange = high - low

// Trend detection
rsi = ta.rsi(close, rsiLength)
ema = ta.ema(close, emaLength)

// ============================================================================
// Ð ÐÐ¡ÐŸÐžÐ—ÐÐÐ’ÐÐÐ˜Ð• ÐŸÐÐ¢Ð¢Ð•Ð ÐÐžÐ’ / PATTERN RECOGNITION
// ============================================================================

// Function: Hammer
isHammer() =>
    smallBody = bodySize < totalRange * bodyThreshold
    longLowerWick = lowerWick > bodySize * wickRatio
    shortUpperWick = upperWick < bodySize * 0.5
    inDowntrend = close < ema
    totalRange > 0 and smallBody and longLowerWick and shortUpperWick and inDowntrend

// Function: Shooting Star
isShootingStar() =>
    smallBody = bodySize < totalRange * bodyThreshold
    longUpperWick = upperWick > bodySize * wickRatio
    shortLowerWick = lowerWick < bodySize * 0.5
    inUptrend = close > ema
    totalRange > 0 and smallBody and longUpperWick and shortLowerWick and inUptrend

// Function: Bullish Engulfing
isBullishEngulfing() =>
    prevBearish = close[1] < open[1]
    currentBullish = close > open
    engulfs = open < close[1] and close > open[1]
    inDowntrend = close < ema
    prevBearish and currentBullish and engulfs and inDowntrend

// Function: Bearish Engulfing
isBearishEngulfing() =>
    prevBullish = close[1] > open[1]
    currentBearish = close < open
    engulfs = open > close[1] and close < open[1]
    inUptrend = close > ema
    prevBullish and currentBearish and engulfs and inUptrend

// Function: Morning Star
isMorningStar() =>
    firstBearish = (open[2] - close[2]) > (high[2] - low[2]) * 0.6
    secondSmall = math.abs(close[1] - open[1]) < (high[2] - low[2]) * bodyThreshold
    thirdBullish = (close - open) > (high - low) * 0.6
    thirdCloseAboveMid = close > (open[2] + close[2]) / 2
    firstBearish and secondSmall and thirdBullish and thirdCloseAboveMid

// Function: Evening Star
isEveningStar() =>
    firstBullish = (close[2] - open[2]) > (high[2] - low[2]) * 0.6
    secondSmall = math.abs(close[1] - open[1]) < (high[2] - low[2]) * bodyThreshold
    thirdBearish = (open - close) > (high - low) * 0.6
    thirdCloseBelowMid = close < (open[2] + close[2]) / 2
    firstBullish and secondSmall and thirdBearish and thirdCloseBelowMid

// Function: Doji
isDoji() =>
    totalRange > 0 and bodySize < totalRange * 0.1

// Detect patterns
hammer = useHammer and isHammer()
shootingStar = useHammer and isShootingStar()
bullishEngulfing = useEngulfing and isBullishEngulfing()
bearishEngulfing = useEngulfing and isBearishEngulfing()
morningStar = useStarPatterns and isMorningStar()
eveningStar = useStarPatterns and isEveningStar()
doji = useDoji and isDoji()

// Pattern counters
var int hammerCount = 0
var int shootingStarCount = 0
var int bullishEngulfCount = 0
var int bearishEngulfCount = 0
var int morningStarCount = 0
var int eveningStarCount = 0
var int dojiCount = 0

if hammer
    hammerCount += 1
if shootingStar
    shootingStarCount += 1
if bullishEngulfing
    bullishEngulfCount += 1
if bearishEngulfing
    bearishEngulfCount += 1
if morningStar
    morningStarCount += 1
if eveningStar
    eveningStarCount += 1
if doji
    dojiCount += 1

// ============================================================================
// Ð’Ð˜Ð—Ð£ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ / VISUALIZATION
// ============================================================================

// Pattern labels
if showLabels
    if hammer
        label.new(bar_index, low, "ðŸ”¨\nHammer",
                 color=color.new(color.green, 20),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.small)

    if shootingStar
        label.new(bar_index, high, "ðŸ’«\nShooting Star",
                 color=color.new(color.red, 20),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.small)

    if bullishEngulfing
        label.new(bar_index, low, "â¬†ï¸\nBull Engulf",
                 color=color.new(color.green, 20),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.small)

    if bearishEngulfing
        label.new(bar_index, high, "â¬‡ï¸\nBear Engulf",
                 color=color.new(color.red, 20),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.small)

    if morningStar
        label.new(bar_index, low, "â­\nMorning Star",
                 color=color.new(color.green, 20),
                 textcolor=color.white,
                 style=label.style_label_up,
                 size=size.small)

    if eveningStar
        label.new(bar_index, high, "ðŸŒ™\nEvening Star",
                 color=color.new(color.red, 20),
                 textcolor=color.white,
                 style=label.style_label_down,
                 size=size.small)

    if doji
        label.new(bar_index, high, "âž•\nDoji",
                 color=color.new(color.gray, 40),
                 textcolor=color.white,
                 style=label.style_label_center,
                 size=size.small)

// Highlight pattern candles
barcolor(
     showHighlights and (hammer or bullishEngulfing or morningStar) ? color.new(color.green, 70) :
     showHighlights and (shootingStar or bearishEngulfing or eveningStar) ? color.new(color.red, 70) :
     showHighlights and doji ? color.new(color.gray, 80) : na,
     title="Pattern Highlight"
 )

// ============================================================================
// Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ˜ / STATISTICS TABLE
// ============================================================================

if showStats and barstate.islast
    var table statsTable = table.new(position.top_right, 3, 9, border_width=1)

    // Header
    table.cell(statsTable, 0, 0, "Pattern / ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½",
              text_color=color.white,
              bgcolor=color.new(color.blue, 20),
              text_size=size.normal)
    table.cell(statsTable, 1, 0, "Count / ÐšÐ¾Ð»-Ð²Ð¾",
              text_color=color.white,
              bgcolor=color.new(color.blue, 20),
              text_size=size.normal)
    table.cell(statsTable, 2, 0, "Type / Ð¢Ð¸Ð¿",
              text_color=color.white,
              bgcolor=color.new(color.blue, 20),
              text_size=size.normal)

    // Bullish patterns
    table.cell(statsTable, 0, 1, "ðŸ”¨ Hammer",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 1, str.tostring(hammerCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 1, "Bullish / Ð‘Ñ‹Ñ‡Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.small)

    table.cell(statsTable, 0, 2, "â¬†ï¸ Bull Engulf",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 2, str.tostring(bullishEngulfCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 2, "Bullish / Ð‘Ñ‹Ñ‡Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.small)

    table.cell(statsTable, 0, 3, "â­ Morning Star",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 3, str.tostring(morningStarCount),
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 3, "Bullish / Ð‘Ñ‹Ñ‡Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.green, 60),
              text_size=size.small)

    // Bearish patterns
    table.cell(statsTable, 0, 4, "ðŸ’« Shooting Star",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 4, str.tostring(shootingStarCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 4, "Bearish / ÐœÐµÐ´Ð²ÐµÐ¶Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.small)

    table.cell(statsTable, 0, 5, "â¬‡ï¸ Bear Engulf",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 5, str.tostring(bearishEngulfCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 5, "Bearish / ÐœÐµÐ´Ð²ÐµÐ¶Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.small)

    table.cell(statsTable, 0, 6, "ðŸŒ™ Evening Star",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 6, str.tostring(eveningStarCount),
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 6, "Bearish / ÐœÐµÐ´Ð²ÐµÐ¶Ð¸Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.red, 60),
              text_size=size.small)

    // Neutral pattern
    table.cell(statsTable, 0, 7, "âž• Doji",
              text_color=color.white,
              bgcolor=color.new(color.gray, 60),
              text_size=size.normal)
    table.cell(statsTable, 1, 7, str.tostring(dojiCount),
              text_color=color.white,
              bgcolor=color.new(color.gray, 60),
              text_size=size.normal)
    table.cell(statsTable, 2, 7, "Neutral / ÐÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹",
              text_color=color.white,
              bgcolor=color.new(color.gray, 60),
              text_size=size.small)

    // Totals
    totalPatterns = hammerCount + shootingStarCount + bullishEngulfCount + bearishEngulfCount + morningStarCount + eveningStarCount + dojiCount
    table.cell(statsTable, 0, 8, "TOTAL / Ð’Ð¡Ð•Ð“Ðž",
              text_color=color.white,
              bgcolor=color.new(color.blue, 40),
              text_size=size.normal)
    table.cell(statsTable, 1, 8, str.tostring(totalPatterns),
              text_color=color.white,
              bgcolor=color.new(color.blue, 40),
              text_size=size.normal)
    table.cell(statsTable, 2, 8, "Sensitivity: " + patternSensitivity,
              text_color=color.white,
              bgcolor=color.new(color.blue, 40),
              text_size=size.small)

// ============================================================================
// ÐÐ›Ð•Ð Ð¢Ð« / ALERTS
// ============================================================================

alertcondition(hammer, "Hammer Pattern", "ðŸ”¨ Hammer candlestick pattern detected")
alertcondition(shootingStar, "Shooting Star Pattern", "ðŸ’« Shooting Star candlestick pattern detected")
alertcondition(bullishEngulfing, "Bullish Engulfing Pattern", "â¬†ï¸ Bullish Engulfing pattern detected")
alertcondition(bearishEngulfing, "Bearish Engulfing Pattern", "â¬‡ï¸ Bearish Engulfing pattern detected")
alertcondition(morningStar, "Morning Star Pattern", "â­ Morning Star pattern detected")
alertcondition(eveningStar, "Evening Star Pattern", "ðŸŒ™ Evening Star pattern detected")
alertcondition(doji, "Doji Pattern", "âž• Doji pattern detected")

// ============================================================================
// ÐŸÐ Ð˜ÐœÐ•Ð§ÐÐÐ˜Ð¯ / NOTES
// ============================================================================

// Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ / Usage Instructions:
//
// 1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ ÑÑ‚Ð¾Ñ‚ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð² TradingView
//    Load this test indicator in TradingView
//
// 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ (Strict/Medium/Relaxed)
//    Adjust sensitivity (Strict/Medium/Relaxed)
//
// 3. Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ/Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
//    Enable/disable individual patterns for testing
//
// 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
//    Verify recognition on historical data
//
// 5. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
//    Use statistics table for analysis
//
// 6. ÐŸÐ°Ñ‚Ñ‚ÐµÑ€Ð½Ñ‹ Ð½Ð°Ð¸Ð±Ð¾Ð»ÐµÐµ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹ Ð½Ð° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑƒÑ€Ð¾Ð²Ð½ÑÑ… Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸/ÑÐ¾Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð»ÐµÐ½Ð¸Ñ
//    Patterns are most effective at key support/resistance levels
//
// 7. Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² ÑÐ¾Ñ‡ÐµÑ‚Ð°Ð½Ð¸Ð¸ Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
//    Recommended to use in combination with other indicators
