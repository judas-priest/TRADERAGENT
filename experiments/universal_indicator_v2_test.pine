// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("Universal Indicator v2 - Test & Examples", shorttitle="UI v2 Test", overlay=false)

// ============================================================================
// TESTING AND EXAMPLE SCRIPT FOR UNIVERSAL INDICATOR V2
// ============================================================================
//
// This script demonstrates the core logic of Universal Indicator v2
// and can be used for testing different parameter combinations.
//
// Этот скрипт демонстрирует основную логику Универсального Индикатора v2
// и может использоваться для тестирования различных комбинаций параметров.

// ============================================================================
// EXAMPLE CONFIGURATIONS / ПРИМЕРЫ КОНФИГУРАЦИЙ
// ============================================================================

// Example 1: Scalping 5m / Пример 1: Скальпинг 5m
// RSI Length: 9, Smoothing: 2, Momentum: 1.3, Min Bars: 5

// Example 2: Swing Trading 4H / Пример 2: Свинг-трейдинг 4H
// RSI Length: 14, Smoothing: 3, Momentum: 1.5, Min Bars: 20

// Example 3: Day Trading Crypto / Пример 3: Дневная торговля крипто
// RSI Length: 14, Smoothing: 3, Momentum: 1.2, Min Bars: 10

// ============================================================================
// INPUTS - CURRENT TEST CONFIGURATION
// ============================================================================

testConfig = input.string("Default", "Test Configuration",
     options=["Default", "Scalping 5m", "Swing 4H", "Day Trading", "Custom"],
     group="Test Configuration")

// Auto-set parameters based on selected configuration
// Автоматическая установка параметров на основе выбранной конфигурации
var int defaultRsiLength = 14
var int defaultRsiSmooth = 3
var float defaultMomentum = 1.2
var int defaultMinBars = 10
var int defaultFibLookback = 100

if testConfig == "Scalping 5m"
    defaultRsiLength := 9
    defaultRsiSmooth := 2
    defaultMomentum := 1.3
    defaultMinBars := 5
    defaultFibLookback := 50
else if testConfig == "Swing 4H"
    defaultRsiLength := 14
    defaultRsiSmooth := 3
    defaultMomentum := 1.5
    defaultMinBars := 20
    defaultFibLookback := 150
else if testConfig == "Day Trading"
    defaultRsiLength := 14
    defaultRsiSmooth := 3
    defaultMomentum := 1.2
    defaultMinBars := 10
    defaultFibLookback := 100

// Manual override for Custom configuration
rsiLength = testConfig == "Custom" ? input.int(14, "RSI Length", minval=1, group="Custom Settings") : defaultRsiLength
rsiSmoothLength = testConfig == "Custom" ? input.int(3, "RSI Smoothing", minval=1, group="Custom Settings") : defaultRsiSmooth
rsiOversold = input.int(30, "Oversold Level", minval=1, maxval=50, group="RSI Settings")
rsiOverbought = input.int(70, "Overbought Level", minval=50, maxval=100, group="RSI Settings")

volumeMaLength = input.int(20, "Volume MA Length", minval=1, group="Volume Settings")
momentumThreshold = testConfig == "Custom" ? input.float(1.2, "Momentum Threshold", minval=1.0, step=0.1, group="Custom Settings") : defaultMomentum
minBarsBetweenSignals = testConfig == "Custom" ? input.int(10, "Min Bars Between Signals", minval=1, group="Custom Settings") : defaultMinBars

fibLookback = testConfig == "Custom" ? input.int(100, "Fibonacci Lookback", minval=10, group="Custom Settings") : defaultFibLookback

showStatistics = input.bool(true, "Show Statistics Table", group="Display")

// ============================================================================
// CORE INDICATOR LOGIC / ОСНОВНАЯ ЛОГИКА ИНДИКАТОРА
// ============================================================================

// RSI Calculation
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, rsiSmoothLength)

// Volume Momentum
volumeMa = ta.sma(volume, volumeMaLength)
volumeMomentum = volume / volumeMa

// State Detection
isOversold = rsi < rsiOversold
isOverbought = rsi > rsiOverbought

// Momentum Confirmation
strongMomentum = volumeMomentum > momentumThreshold

// Signal Detection
bullishTransition = ta.crossover(rsi, rsiOversold)
rsiRising = rsiSmooth > rsiSmooth[1]
bullishSignalRaw = bullishTransition and strongMomentum and rsiRising

bearishTransition = ta.crossunder(rsi, rsiOverbought)
rsiFalling = rsiSmooth < rsiSmooth[1]
bearishSignalRaw = bearishTransition and strongMomentum and rsiFalling

// Signal Filter
var int lastSignalBar = na
signalAllowed = na(lastSignalBar) or (bar_index - lastSignalBar) >= minBarsBetweenSignals

bullishSignal = bullishSignalRaw and signalAllowed
bearishSignal = bearishSignalRaw and signalAllowed

if bullishSignal or bearishSignal
    lastSignalBar := bar_index

// ============================================================================
// VISUALIZATION / ВИЗУАЛИЗАЦИЯ
// ============================================================================

// Plot RSI
plot(rsi, "RSI", color=color.new(color.blue, 0), linewidth=2)
plot(rsiSmooth, "RSI Smooth", color=color.new(color.orange, 0), linewidth=1)

// Plot levels
hline(rsiOversold, "Oversold", color=color.green, linestyle=hline.style_dashed)
hline(50, "Midline", color=color.gray, linestyle=hline.style_dotted)
hline(rsiOverbought, "Overbought", color=color.red, linestyle=hline.style_dashed)

// Colored zones
bgcolor(isOversold ? color.new(color.green, 85) : na, title="Oversold Zone")
bgcolor(isOverbought ? color.new(color.red, 85) : na, title="Overbought Zone")

// Volume Momentum histogram
volumeMomentumScaled = (volumeMomentum - 1) * 50 + 50
volumeColor = volumeMomentum > momentumThreshold ? color.new(color.green, 50) : color.new(color.gray, 70)
plot(volumeMomentumScaled, "Volume Momentum", style=plot.style_histogram, color=volumeColor)

// Signal markers
plotshape(bullishSignal, "Bullish", location=location.bottom, color=color.new(color.green, 0), style=shape.triangleup, size=size.small)
plotshape(bearishSignal, "Bearish", location=location.top, color=color.new(color.red, 0), style=shape.triangledown, size=size.small)

// ============================================================================
// STATISTICS / СТАТИСТИКА
// ============================================================================

// Track signal performance
var int totalBullishSignals = 0
var int totalBearishSignals = 0
var float totalBullishProfit = 0.0
var float totalBearishProfit = 0.0
var int bullishWins = 0
var int bearishWins = 0

// Simple profit calculation (price change from signal to 50 bars later)
if bullishSignal
    totalBullishSignals += 1

if bearishSignal
    totalBearishSignals += 1

// Calculate profit for bullish signals
if bullishSignal[50]
    priceChange = (close - close[50]) / close[50] * 100
    totalBullishProfit += priceChange
    if priceChange > 0
        bullishWins += 1

// Calculate profit for bearish signals
if bearishSignal[50]
    priceChange = (close[50] - close) / close[50] * 100
    totalBearishProfit += priceChange
    if priceChange > 0
        bearishWins += 1

// ============================================================================
// STATISTICS TABLE / ТАБЛИЦА СТАТИСТИКИ
// ============================================================================

if showStatistics
    var table statsTable = table.new(position.bottom_right, 2, 12,
                                     border_width=1,
                                     border_color=color.gray,
                                     frame_width=1,
                                     frame_color=color.gray)

    if barstate.islast
        // Header
        table.cell(statsTable, 0, 0, "Configuration Test", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)
        table.cell(statsTable, 1, 0, testConfig, bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.small)

        // Parameters
        table.cell(statsTable, 0, 1, "RSI Length", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 1, str.tostring(rsiLength), bgcolor=color.new(color.gray, 85), text_size=size.tiny)

        table.cell(statsTable, 0, 2, "RSI Smoothing", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 2, str.tostring(rsiSmoothLength), bgcolor=color.new(color.gray, 85), text_size=size.tiny)

        table.cell(statsTable, 0, 3, "Momentum Threshold", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 3, str.tostring(momentumThreshold, "#.#"), bgcolor=color.new(color.gray, 85), text_size=size.tiny)

        table.cell(statsTable, 0, 4, "Min Bars Between", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 4, str.tostring(minBarsBetweenSignals), bgcolor=color.new(color.gray, 85), text_size=size.tiny)

        // Separator
        table.cell(statsTable, 0, 5, "STATISTICS", bgcolor=color.new(color.orange, 70), text_color=color.white, text_size=size.small)
        table.cell(statsTable, 1, 5, "VALUES", bgcolor=color.new(color.orange, 70), text_color=color.white, text_size=size.small)

        // Bullish signals
        table.cell(statsTable, 0, 6, "Bullish Signals", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 6, str.tostring(totalBullishSignals), bgcolor=color.new(color.green, 85), text_size=size.tiny)

        // Bullish wins
        bullishWinRate = totalBullishSignals > 0 ? bullishWins / totalBullishSignals * 100 : 0
        table.cell(statsTable, 0, 7, "Bullish Win Rate", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 7, str.tostring(bullishWinRate, "#.#") + "%", bgcolor=color.new(color.green, 85), text_size=size.tiny)

        // Bearish signals
        table.cell(statsTable, 0, 8, "Bearish Signals", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 8, str.tostring(totalBearishSignals), bgcolor=color.new(color.red, 85), text_size=size.tiny)

        // Bearish wins
        bearishWinRate = totalBearishSignals > 0 ? bearishWins / totalBearishSignals * 100 : 0
        table.cell(statsTable, 0, 9, "Bearish Win Rate", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 9, str.tostring(bearishWinRate, "#.#") + "%", bgcolor=color.new(color.red, 85), text_size=size.tiny)

        // Current RSI
        rsiColor = isOversold ? color.new(color.green, 80) : (isOverbought ? color.new(color.red, 80) : color.new(color.gray, 80))
        table.cell(statsTable, 0, 10, "Current RSI", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 10, str.tostring(rsi, "#.#"), bgcolor=rsiColor, text_size=size.tiny)

        // Current Vol Momentum
        volColor = strongMomentum ? color.new(color.green, 80) : color.new(color.gray, 80)
        table.cell(statsTable, 0, 11, "Vol Momentum", bgcolor=color.new(color.gray, 90), text_size=size.tiny)
        table.cell(statsTable, 1, 11, str.tostring(volumeMomentum, "#.##"), bgcolor=volColor, text_size=size.tiny)

// ============================================================================
// TESTING NOTES / ПРИМЕЧАНИЯ ПО ТЕСТИРОВАНИЮ
// ============================================================================

// HOW TO USE THIS SCRIPT / КАК ИСПОЛЬЗОВАТЬ ЭТОТ СКРИПТ:
//
// 1. Add this indicator to your chart
//    Добавьте этот индикатор на график
//
// 2. Select a test configuration from the dropdown
//    Выберите тестовую конфигурацию из выпадающего списка
//
// 3. Observe the signals and statistics
//    Наблюдайте за сигналами и статистикой
//
// 4. Compare different configurations on different timeframes
//    Сравните различные конфигурации на разных таймфреймах
//
// 5. Use "Custom" to test your own parameter combinations
//    Используйте "Custom" для тестирования своих комбинаций параметров
//
// STATISTICS EXPLANATION / ОБЪЯСНЕНИЕ СТАТИСТИКИ:
//
// - Win Rate is calculated based on price movement 50 bars after signal
//   Win Rate рассчитывается на основе движения цены через 50 баров после сигнала
//
// - This is a simplified backtesting approach for demonstration
//   Это упрощенный подход к бэктестингу для демонстрации
//
// - For production trading, use proper backtesting with risk management
//   Для реальной торговли используйте правильный бэктестинг с риск-менеджментом
