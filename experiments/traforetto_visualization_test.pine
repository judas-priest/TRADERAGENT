// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
indicator("Traforetto Visualization Test", overlay=true, max_lines_count=100, max_boxes_count=10)

// ============================================================================
// ТЕСТ ВИЗУАЛИЗАЦИИ
// ============================================================================
// Этот скрипт тестирует все визуальные элементы индикатора Трафоретто
// для подтверждения корректного отображения на графике

// Настройки
testMode = input.string("Full", "Test Mode", options=["Lines", "Labels", "Boxes", "Full"])
showTestInfo = input.bool(true, "Show Test Info")

// Создаем тестовые точки на последних барах для демонстрации
var testPoint1Bar = bar_index - 50
var testPoint1Price = close[50]
var testPoint2Bar = bar_index - 40
var testPoint2Price = high[40]
var testPoint3Bar = bar_index - 30
var testPoint3Price = low[30]
var testPoint4Bar = bar_index - 20
var testPoint4Price = high[20]

// Обновляем на последнем баре
if barstate.islast
    testPoint1Bar := bar_index - 50
    testPoint1Price := close[50]
    testPoint2Bar := bar_index - 40
    testPoint2Price := high[40]
    testPoint3Bar := bar_index - 30
    testPoint3Price := low[30]
    testPoint4Bar := bar_index - 20
    testPoint4Price := high[20]

// Тест: Линии
if testMode == "Lines" or testMode == "Full"
    // Линия тренда (сплошная)
    line.new(testPoint1Bar, testPoint1Price, testPoint3Bar, testPoint3Price,
             color=color.green, width=2, style=line.style_solid,
             extend=extend.right)

    // Линия целей (пунктирная)
    line.new(testPoint2Bar, testPoint2Price, testPoint4Bar, testPoint4Price,
             color=color.green, width=2, style=line.style_dashed,
             extend=extend.right)

    // Крестик для Сакральной Точки
    stX = testPoint1Bar - 10
    stY = testPoint1Price - (testPoint2Price - testPoint1Price) * 0.1
    line.new(stX - 2, stY, stX + 2, stY,
             color=color.purple, width=3)
    line.new(stX, stY - (testPoint2Price - testPoint1Price) * 0.02,
             stX, stY + (testPoint2Price - testPoint1Price) * 0.02,
             color=color.purple, width=3)

// Тест: Метки
if testMode == "Labels" or testMode == "Full"
    label.new(testPoint1Bar, testPoint1Price, "1",
              color=color.new(color.green, 70),
              textcolor=color.white,
              style=label.style_label_up,
              size=size.normal)

    label.new(testPoint2Bar, testPoint2Price, "2",
              color=color.new(color.green, 70),
              textcolor=color.white,
              style=label.style_label_down,
              size=size.normal)

    label.new(testPoint3Bar, testPoint3Price, "3",
              color=color.new(color.green, 70),
              textcolor=color.white,
              style=label.style_label_up,
              size=size.normal)

    label.new(testPoint4Bar, testPoint4Price, "4",
              color=color.new(color.green, 70),
              textcolor=color.white,
              style=label.style_label_down,
              size=size.normal)

    // Метка Сакральной Точки
    stX = testPoint1Bar - 10
    stY = testPoint1Price - (testPoint2Price - testPoint1Price) * 0.1
    label.new(stX, stY, "СТ\nСИЛЬНЫЙ\n0.85",
              color=color.new(color.purple, 70),
              textcolor=color.white,
              style=label.style_label_center,
              size=size.small)

// Тест: Прямоугольники (каналы)
if testMode == "Boxes" or testMode == "Full"
    // Визуализация канала
    box.new(testPoint3Bar, testPoint3Price, bar_index, testPoint4Price,
            border_color=color.new(color.green, 90),
            bgcolor=color.new(color.green, 95),
            border_width=1,
            border_style=line.style_dotted,
            extend=extend.right)

// Тест: Гексаграмма
if testMode == "Full"
    // Середина 3-4
    mid34X = (testPoint3Bar + testPoint4Bar) / 2
    mid34Y = (testPoint3Price + testPoint4Price) / 2

    // Точка C (прогноз)
    pointCX = mid34X + (mid34X - testPoint1Bar + 10)
    pointCY = mid34Y + (mid34Y - testPoint1Price)

    // Линии гексаграммы
    line.new(testPoint3Bar, testPoint3Price, testPoint4Bar, testPoint4Price,
             color=color.new(color.blue, 30), width=1, style=line.style_dotted)

    line.new(testPoint3Bar, testPoint3Price, int(pointCX), pointCY,
             color=color.new(color.blue, 30), width=1, style=line.style_dotted)

    line.new(testPoint4Bar, testPoint4Price, int(pointCX), pointCY,
             color=color.new(color.blue, 30), width=1, style=line.style_dotted)

    // Прогнозные точки A и B
    pointAX = testPoint3Bar + (mid34X - testPoint3Bar) * 1.5
    pointAY = testPoint3Price + (mid34Y - testPoint3Price) * 1.3

    pointBX = testPoint4Bar + (mid34X - testPoint4Bar) * 1.5
    pointBY = testPoint4Price - (testPoint4Price - mid34Y) * 1.3

    // Линии к прогнозным точкам
    line.new(testPoint2Bar, testPoint2Price, int(pointAX), pointAY,
             color=color.new(color.purple, 50), width=1, style=line.style_dashed)

    line.new(testPoint1Bar, testPoint1Price, int(pointBX), pointBY,
             color=color.new(color.orange, 50), width=1, style=line.style_dashed)

    // Линия между прогнозами
    line.new(int(pointAX), pointAY, int(pointBX), pointBY,
             color=color.new(color.yellow, 30), width=2, style=line.style_solid)

    // Метки прогнозов
    label.new(int(pointAX), pointAY, "A (прогноз 5)",
              color=color.new(color.purple, 70),
              textcolor=color.white,
              style=label.style_label_center,
              size=size.small)

    label.new(int(pointBX), pointBY, "B (прогноз 6)",
              color=color.new(color.orange, 70),
              textcolor=color.white,
              style=label.style_label_center,
              size=size.small)

// Информационная таблица
if showTestInfo
    var table testTable = table.new(position.top_right, 2, 4, border_width=1)

    if barstate.islast
        table.cell(testTable, 0, 0, "Параметр",
                   bgcolor=color.new(color.gray, 50),
                   text_color=color.white)
        table.cell(testTable, 1, 0, "Статус",
                   bgcolor=color.new(color.gray, 50),
                   text_color=color.white)

        table.cell(testTable, 0, 1, "Overlay Mode",
                   bgcolor=color.new(color.gray, 70),
                   text_color=color.white)
        table.cell(testTable, 1, 1, "ON",
                   bgcolor=color.new(color.green, 70),
                   text_color=color.white)

        table.cell(testTable, 0, 2, "Test Mode",
                   bgcolor=color.new(color.gray, 70),
                   text_color=color.white)
        table.cell(testTable, 1, 2, testMode,
                   bgcolor=color.new(color.blue, 70),
                   text_color=color.white)

        table.cell(testTable, 0, 3, "Elements",
                   bgcolor=color.new(color.gray, 70),
                   text_color=color.white)
        elemCount = testMode == "Full" ? "All" : testMode
        table.cell(testTable, 1, 3, elemCount,
                   bgcolor=color.new(color.green, 70),
                   text_color=color.white)

// Сигналы
plotshape(bar_index == testPoint3Bar, title="Test Long Signal",
          location=location.belowbar,
          color=color.new(color.green, 0),
          style=shape.triangleup,
          size=size.normal,
          text="LONG")

// Фон
bgcolor(bar_index >= testPoint3Bar and bar_index <= testPoint3Bar + 5 ? color.new(color.green, 90) : na,
        title="Test Background")
