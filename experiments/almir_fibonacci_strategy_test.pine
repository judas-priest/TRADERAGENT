// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © TRADERAGENT

//@version=6
strategy("ALMIR Fibonacci Strategy Test", shorttitle="ALMIR-Test", overlay=true,
         initial_capital=10000, default_qty_type=strategy.percent_of_equity,
         default_qty_value=1, commission_type=strategy.commission.percent,
         commission_value=0.1, slippage=3)

// ============================================================================
// TEST SCRIPT FOR ALMIR FIBONACCI STRATEGY
// ============================================================================
// Этот скрипт предназначен для тестирования основных компонентов стратегии
// This script is for testing core strategy components
//
// Что тестируется / What is tested:
// 1. Определение сигналов (зеленые/красные свечи)
// 2. Построение уровней Фибоначчи
// 3. Confluence scoring system
// 4. Адаптивные фильтры
// 5. Визуализация сигналов
// ============================================================================

// Упрощенные настройки для тестирования / Simplified settings for testing
rsiLength = input.int(10, "RSI Length", minval=1, group="Test Settings")
minConfluenceScore = input.int(6, "Min Confluence Score", minval=2, maxval=15, group="Test Settings")
fibLookback = input.int(100, "Fibonacci Lookback", minval=10, group="Test Settings")
showDebugInfo = input.bool(true, "Show Debug Info", group="Test Settings")

// ============================================================================
// CORE INDICATORS / ОСНОВНЫЕ ИНДИКАТОРЫ
// ============================================================================

// RSI
rsi = ta.rsi(close, rsiLength)
rsiSmooth = ta.sma(rsi, 3)

// MACD
[macdLine, signalLine, _] = ta.macd(close, 2, 30, 10)
macdBullish = ta.crossover(macdLine, signalLine) and macdLine < 0
macdBearish = ta.crossunder(macdLine, signalLine) and macdLine > 0

// Stochastic
stochK = ta.stoch(close, high, low, 14)
stochD = ta.sma(stochK, 3)
stochBullish = ta.crossover(stochK, stochD) and stochK < 30
stochBearish = ta.crossunder(stochK, stochD) and stochK > 83

// Volume
volumeMa = ta.sma(volume, 10)
strongVolume = volume / volumeMa > 2.0
isBuyingPressure = close > open and strongVolume
isSellingPressure = close < open and strongVolume

// EMA
ema1 = ta.ema(close, 9)
ema2 = ta.ema(close, 5)
ema3 = ta.ema(close, 200)
emaBullish = ta.crossover(ema1, ema2) and ema1 > ema3
emaBearish = ta.crossunder(ema1, ema2) and ema1 < ema3

// Price Action
candleRange = high - low
candleBody = math.abs(close - open)
isBullishCandle = (close > open) and (candleBody > candleRange * 0.6) and candleRange > 0
isBearishCandle = (open > close) and (candleBody > candleRange * 0.6) and candleRange > 0

// ATR for volatility
atr = ta.atr(14)
atrMa = ta.sma(atr, 20)
isHighVolatility = atr / atrMa > 0.85

// ADX for trend
[diPlus, diMinus, adx] = ta.dmi(14, 14)
isTrendingUp = adx > 25 and diPlus > diMinus
isTrendingDown = adx > 25 and diMinus > diPlus

// ============================================================================
// CONFLUENCE SCORING / ПОДСЧЕТ CONFLUENCE
// ============================================================================

var int bullishScore = 0
var int bearishScore = 0

bullishScore := 0
bearishScore := 0

// RSI Signals
rsiBullishSignal = ta.crossover(rsi, 30) and rsiSmooth > rsiSmooth[1]
rsiBearishSignal = ta.crossunder(rsi, 65) and rsiSmooth < rsiSmooth[1]

if rsiBullishSignal
    bullishScore += 2

if rsiBearishSignal
    bearishScore += 2

// MACD Signals
if macdBullish
    bullishScore += 2

if macdBearish
    bearishScore += 2

// Stochastic Signals
if stochBullish
    bullishScore += 2

if stochBearish
    bearishScore += 2

// Volume Signals
if isBuyingPressure
    bullishScore += 2

if isSellingPressure
    bearishScore += 2

// Price Action Signals
if isBullishCandle
    bullishScore += 1

if isBearishCandle
    bearishScore += 1

// EMA Signals
if emaBullish
    bullishScore += 1

if emaBearish
    bearishScore += 1

// ============================================================================
// SIGNAL GENERATION / ГЕНЕРАЦИЯ СИГНАЛОВ
// ============================================================================

var int lastBullishBar = 0
var int lastBearishBar = 0

barsSinceLastBullish = bar_index - lastBullishBar
barsSinceLastBearish = bar_index - lastBearishBar

bullishSignalRaw = bullishScore >= minConfluenceScore and barsSinceLastBullish >= 12
bearishSignalRaw = bearishScore >= minConfluenceScore and barsSinceLastBearish >= 12

// Apply filters
bullishSignal = bullishSignalRaw and not (isTrendingDown and isHighVolatility)
bearishSignal = bearishSignalRaw and not (isTrendingUp and isHighVolatility)

if bullishSignal
    lastBullishBar := bar_index

if bearishSignal
    lastBearishBar := bar_index

// ============================================================================
// FIBONACCI LEVELS / УРОВНИ ФИБОНАЧЧИ
// ============================================================================

var float fibBase = na
var float fibTop = na
var bool isLongPosition = false

// Calculate ta.highest and ta.lowest on every bar for consistency
highestHigh = ta.highest(high, fibLookback)
lowestLow = ta.lowest(low, fibLookback)

if bullishSignal
    isLongPosition := true
    fibBase := low
    fibTop := highestHigh

if bearishSignal
    isLongPosition := false
    fibBase := high
    fibTop := lowestLow

// Calculate Fibonacci levels
float fib_0_0 = na
float fib_0_5 = na
float fib_0_618 = na
float fib_0_820 = na
float fib_n0_618 = na
float fib_n1_618 = na
float fib_n2_618 = na

if not na(fibBase) and not na(fibTop)
    fibRange = fibTop - fibBase

    if isLongPosition
        fib_0_0 := fibTop
        fib_0_5 := fibBase + fibRange * 0.5
        fib_0_618 := fibBase + fibRange * 0.618
        fib_0_820 := fibBase + fibRange * 0.820
        fib_n0_618 := fibTop + fibRange * 0.618
        fib_n1_618 := fibTop + fibRange * 1.618
        fib_n2_618 := fibTop + fibRange * 2.618
    else
        fib_0_0 := fibTop
        fib_0_5 := fibBase - fibRange * 0.5
        fib_0_618 := fibBase - fibRange * 0.618
        fib_0_820 := fibBase - fibRange * 0.820
        fib_n0_618 := fibTop - fibRange * 0.618
        fib_n1_618 := fibTop - fibRange * 1.618
        fib_n2_618 := fibTop - fibRange * 2.618

// ============================================================================
// VISUALIZATION / ВИЗУАЛИЗАЦИЯ
// ============================================================================

// Plot EMAs
plot(ema1, "EMA 9", color=color.new(color.blue, 50), linewidth=1)
plot(ema3, "EMA 200", color=color.new(color.purple, 50), linewidth=2)

// Plot Fibonacci levels
plot(fib_0_0, "Fib 0.0", color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr)
plot(fib_0_5, "Fib 0.5", color=color.new(color.blue, 30), linewidth=1, style=plot.style_linebr)
plot(fib_0_618, "Fib 0.618", color=color.new(color.blue, 30), linewidth=1, style=plot.style_linebr)
plot(fib_0_820, "Fib 0.820 (SL)", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)
plot(fib_n0_618, "Fib -0.618 (TP1)", color=color.new(color.yellow, 0), linewidth=2, style=plot.style_linebr)
plot(fib_n1_618, "Fib -1.618 (TP2)", color=color.new(color.orange, 0), linewidth=2, style=plot.style_linebr)
plot(fib_n2_618, "Fib -2.618 (TP3)", color=color.new(color.lime, 0), linewidth=2, style=plot.style_linebr)

// Plot signals
plotshape(bullishSignal, "Bullish", style=shape.triangleup, location=location.belowbar,
     color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.large)

plotshape(bearishSignal, "Bearish", style=shape.triangledown, location=location.abovebar,
     color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.large)

// ============================================================================
// DEBUG TABLE / ТАБЛИЦА ОТЛАДКИ
// ============================================================================

if showDebugInfo and barstate.islast
    var table debugTable = table.new(position.bottom_left, 2, 15,
         border_width=1, border_color=color.gray)

    // Header
    table.cell(debugTable, 0, 0, "Test Results", bgcolor=color.new(color.blue, 30),
         text_color=color.white, text_size=size.normal)
    table.merge_cells(debugTable, 0, 0, 1, 0)

    // RSI
    table.cell(debugTable, 0, 1, "RSI", text_size=size.small)
    table.cell(debugTable, 1, 1, str.tostring(rsi, "#.##"), text_size=size.small)

    // Confluence Scores
    table.cell(debugTable, 0, 2, "Bull Score", text_size=size.small)
    bullColor = bullishScore >= minConfluenceScore ? color.green : color.gray
    table.cell(debugTable, 1, 2, str.tostring(bullishScore) + "/" + str.tostring(minConfluenceScore),
         text_color=bullColor, text_size=size.small)

    table.cell(debugTable, 0, 3, "Bear Score", text_size=size.small)
    bearColor = bearishScore >= minConfluenceScore ? color.red : color.gray
    table.cell(debugTable, 1, 3, str.tostring(bearishScore) + "/" + str.tostring(minConfluenceScore),
         text_color=bearColor, text_size=size.small)

    // Market State
    table.cell(debugTable, 0, 4, "Trend", text_size=size.small)
    trendText = isTrendingUp ? "Up" : isTrendingDown ? "Down" : "Side"
    table.cell(debugTable, 1, 4, trendText, text_size=size.small)

    table.cell(debugTable, 0, 5, "Volatility", text_size=size.small)
    volText = isHighVolatility ? "High" : "Normal"
    table.cell(debugTable, 1, 5, volText, text_size=size.small)

    // Indicator States
    table.cell(debugTable, 0, 6, "RSI Signal", text_size=size.small)
    table.cell(debugTable, 1, 6, rsiBullishSignal ? "Bull" : rsiBearishSignal ? "Bear" : "-", text_size=size.small)

    table.cell(debugTable, 0, 7, "MACD Signal", text_size=size.small)
    table.cell(debugTable, 1, 7, macdBullish ? "Bull" : macdBearish ? "Bear" : "-", text_size=size.small)

    table.cell(debugTable, 0, 8, "Stoch Signal", text_size=size.small)
    table.cell(debugTable, 1, 8, stochBullish ? "Bull" : stochBearish ? "Bear" : "-", text_size=size.small)

    table.cell(debugTable, 0, 9, "Volume Signal", text_size=size.small)
    table.cell(debugTable, 1, 9, isBuyingPressure ? "Buy" : isSellingPressure ? "Sell" : "-", text_size=size.small)

    table.cell(debugTable, 0, 10, "Price Action", text_size=size.small)
    table.cell(debugTable, 1, 10, isBullishCandle ? "Bull" : isBearishCandle ? "Bear" : "-", text_size=size.small)

    table.cell(debugTable, 0, 11, "EMA Signal", text_size=size.small)
    table.cell(debugTable, 1, 11, emaBullish ? "Bull" : emaBearish ? "Bear" : "-", text_size=size.small)

    // Fibonacci Info
    table.cell(debugTable, 0, 12, "Fib Range", text_size=size.small)
    fibRangeText = not na(fibBase) and not na(fibTop) ? str.tostring(math.abs(fibTop - fibBase), "#.####") : "N/A"
    table.cell(debugTable, 1, 12, fibRangeText, text_size=size.small)

    table.cell(debugTable, 0, 13, "Position Type", text_size=size.small)
    posTypeText = isLongPosition ? "LONG" : "SHORT"
    posTypeColor = isLongPosition ? color.green : color.red
    table.cell(debugTable, 1, 13, posTypeText, text_color=posTypeColor, text_size=size.small)

    // Last Signal
    table.cell(debugTable, 0, 14, "Last Signal", text_size=size.small)
    lastSignalText = bullishSignal ? "BULL NOW" :
                     bearishSignal ? "BEAR NOW" :
                     lastBullishBar > lastBearishBar ? str.tostring(barsSinceLastBullish) + " bars" :
                     str.tostring(barsSinceLastBearish) + " bars"
    table.cell(debugTable, 1, 14, lastSignalText, text_size=size.small)

// ============================================================================
// TEST SUMMARY
// ============================================================================
// Этот тестовый скрипт позволяет проверить:
// This test script allows to verify:
//
// 1. Определение зеленых свечей (bullish signals)
//    - RSI пересекает 30 снизу вверх
//    - Сильный объем с покупательским давлением
//    - Confluence score >= 6
//
// 2. Определение красных свечей (bearish signals)
//    - RSI пересекает 65 сверху вниз
//    - Сильный объем с продавательским давлением
//    - Confluence score >= 6
//
// 3. Построение уровней Фибоначчи
//    - Entry levels: 0.0, 0.5, 0.618
//    - Stop Loss: 0.820
//    - Take Profit: -0.618, -1.618, -2.618
//
// 4. Адаптивные фильтры
//    - Не торговать против сильного тренда
//    - Фильтр высокой волатильности
//
// 5. Визуализация
//    - Зеленые треугольники для Long
//    - Красные треугольники для Short
//    - Уровни Фибоначчи разными цветами
//
// Используйте Strategy Tester для анализа результатов
// Use Strategy Tester to analyze results
// ============================================================================
